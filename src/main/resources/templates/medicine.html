<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4A90E2">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ÏïΩÎ≥µÏö©">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>ÏïΩ Î≥µÏö© Í¥ÄÎ¶¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        *{-webkit-tap-highlight-color:transparent;margin:0;padding:0;box-sizing:border-box}
        :root{
            --primary:#4A90E2;--success:#5cb85c;--danger:#d9534f;--warning:#f0ad4e;--info:#5bc0de;
            --gray-100:#f8f9fa;--gray-200:#e9ecef;--gray-300:#dee2e6;--gray-600:#6c757d;--gray-900:#212529;
            --nav-height:65px;
            --bg-gradient-start:#f0f9ff;--bg-gradient-mid:#e0f2fe;--bg-gradient-end:#dbeafe;
            --card-bg:rgba(255,255,255,.95);--card-border:rgba(0,0,0,.04);
            --text-primary:#212529;--text-secondary:#6c757d;
            --white:#ffffff;--hover-bg:#f8f9fa;
        }
        body.dark-mode{
            --primary:#6ba3e8;--success:#72c472;--danger:#e06b67;--warning:#f3ba65;--info:#6fcce4;
            --gray-100:#2a2a2a;--gray-200:#3a3a3a;--gray-300:#4a4a4a;--gray-600:#b0b0b0;--gray-900:#e5e5e5;
            --bg-gradient-start:#0f1419;--bg-gradient-mid:#1a1f26;--bg-gradient-end:#141922;
            --card-bg:rgba(30,35,42,.95);--card-border:rgba(255,255,255,.08);
            --text-primary:#e5e5e5;--text-secondary:#b0b0b0;
            --white:#1e232a;--hover-bg:#2a2a2a;
        }
        body{
            background:linear-gradient(135deg,var(--bg-gradient-start) 0%,var(--bg-gradient-mid) 40%,var(--bg-gradient-end) 100%);
            min-height:100vh;padding-bottom:var(--nav-height);
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Helvetica,Arial,sans-serif;overflow-x:hidden;
            color:var(--text-primary);transition:background .3s,color .3s;
        }
        .tab-content-wrapper{display:none;animation:fadeIn .3s ease-in}
        .tab-content-wrapper.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .app-container{max-width:600px;margin:0 auto;padding:20px 16px}
        .custom-card{background:var(--card-bg);backdrop-filter:blur(20px);border-radius:16px;box-shadow:0 2px 16px rgba(0,0,0,.06);padding:20px;margin-bottom:16px;border:1px solid var(--card-border)}
        .user-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:16px;border-bottom:1px solid var(--gray-200)}
        .user-info{display:flex;align-items:center;gap:12px}
        .user-avatar{width:48px;height:48px;background:linear-gradient(135deg,var(--primary) 0%,#0284c7 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 4px 12px rgba(74,144,226,.3);overflow:hidden;cursor:pointer}
        .user-avatar img{width:100%;height:100%;object-fit:cover}
        .user-details h5{margin:0;font-size:16px;font-weight:700;color:var(--text-primary)}
        .role-badge{display:inline-block;padding:4px 12px;background:linear-gradient(135deg,#cffafe 0%,#a5f3fc 100%);color:#0369a1;border-radius:12px;font-size:12px;font-weight:600}
        body.dark-mode .role-badge{background:linear-gradient(135deg,#164e63 0%,#155e75 100%);color:#a5f3fc}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:var(--nav-height);background:var(--card-bg);backdrop-filter:blur(20px);border-top:1px solid var(--card-border);box-shadow:0 -2px 16px rgba(0,0,0,.06);display:flex;justify-content:space-around;align-items:center;z-index:1000}
        .nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;height:100%;color:var(--gray-600);text-decoration:none;transition:all .3s;cursor:pointer;user-select:none}
        .nav-item i{font-size:24px;margin-bottom:4px;transition:transform .3s}
        .nav-item span{font-size:11px;font-weight:500}
        .nav-item.active{color:var(--primary)}
        .nav-item.active i{transform:scale(1.1)}
        .comment-section{margin-top:20px}
        .comment-input-wrapper{display:flex;flex-direction:column;gap:12px;margin-bottom:20px}
        .comment-input-row{display:flex;gap:8px}
        .comment-input{flex:1;padding:12px 16px;border:1px solid var(--gray-300);border-radius:24px;font-size:14px;outline:none;transition:all .3s;background:var(--white);color:var(--text-primary)}
        .comment-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(74,144,226,.1)}
        .comment-image-btn{padding:12px;background:var(--white);color:var(--text-secondary);border:1px solid var(--gray-300);border-radius:50%;cursor:pointer;transition:all .3s;width:48px;height:48px;display:flex;align-items:center;justify-content:center}
        .comment-image-btn:hover{background:var(--hover-bg);color:var(--primary)}
        .comment-image-btn.active{background:var(--primary);color:white}
        .comment-submit-btn{padding:12px 24px;background:var(--primary);color:white;border:none;border-radius:24px;font-weight:600;cursor:pointer;transition:all .3s}
        .comment-submit-btn:hover{background:#357abd;transform:scale(1.05)}
        .comment-image-preview{width:100%;max-height:200px;border-radius:12px;object-fit:cover;margin-top:8px}
        .comment-image-preview-wrapper{position:relative;display:inline-block}
        .comment-image-remove{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.7);color:white;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .reply-input-wrapper{margin-left:40px;margin-top:8px;display:none}
        .reply-input-wrapper.active{display:block}
        .comment-list{display:flex;flex-direction:column;gap:12px}
        .comment-item{background:var(--white);border-radius:12px;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,.05);position:relative}
        body.dark-mode .comment-item{box-shadow:0 1px 4px rgba(0,0,0,.3)}
        body.dark-mode .activity-item-modern{background:rgba(255,255,255,0.05)!important;border-color:rgba(255,255,255,0.1)!important}
        body.dark-mode .activity-header{background:linear-gradient(135deg,#4a5568 0%,#2d3748 100%)!important}
        .comment-item.new::before{content:'NEW';position:absolute;top:-8px;right:12px;background:#ef4444;color:white;padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700}
        .comment-item.reply{margin-left:40px;background:var(--gray-100);border-left:3px solid var(--primary)}
        .comment-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
        .comment-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--primary) 0%,#0284c7 100%);display:flex;align-items:center;justify-content:center;color:white;font-weight:600;overflow:hidden;cursor:pointer;transition:transform .3s;position:relative;font-size:14px}
        .comment-avatar:hover{transform:scale(1.1)}
        .comment-avatar img{width:100%;height:100%;object-fit:cover}
        .comment-avatar.rainbow-border::before{content:'';position:absolute;inset:-3px;border-radius:50%;background:linear-gradient(45deg,#ff0000,#ff7f00,#ffff00,#00ff00,#0000ff,#4b0082,#9400d3);animation:rainbow-rotate 3s linear infinite;z-index:-1}
        @keyframes rainbow-rotate{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .comment-user-info{flex:1}
        .comment-username{font-weight:600;color:var(--text-primary);font-size:13px}
        .comment-time{font-size:11px;color:var(--text-secondary)}
        .comment-content{margin-bottom:8px;line-height:1.4;color:var(--text-primary);font-size:13px}
        .comment-image{width:100%;border-radius:8px;margin-bottom:8px;cursor:pointer}
        .comment-actions{display:flex;gap:12px;padding-top:8px;border-top:1px solid var(--gray-200)}
        .comment-action-btn{display:flex;align-items:center;gap:4px;background:none;border:none;color:var(--gray-600);cursor:pointer;font-size:13px;transition:all .3s}
        .comment-action-btn:hover{color:var(--primary)}
        .comment-action-btn.liked{color:#ef4444}
        .pagination-wrapper{display:flex;justify-content:center;margin-top:24px}
        .pagination{display:flex;gap:8px}
        .page-btn{padding:8px 12px;border:1px solid var(--gray-300);background:var(--white);border-radius:8px;cursor:pointer;transition:all .3s}
        .page-btn:hover{background:var(--hover-bg)}
        .page-btn.active{background:var(--primary);color:white;border-color:var(--primary)}
        .medicine-buttons{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
        .medicine-btn{padding:32px 16px;border:2px solid var(--gray-300);background:var(--white);border-radius:16px;cursor:pointer;transition:all .3s;text-align:center}
        .medicine-btn:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.1)}
        .medicine-btn.taken{background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 100%);border-color:var(--success)}
        body.dark-mode .medicine-btn.taken{background:linear-gradient(135deg,#064e3b 0%,#065f46 100%);color:#a7f3d0}
        .medicine-btn.disabled{opacity:.6;cursor:not-allowed}
        .medicine-icon{font-size:48px;margin-bottom:12px}
        .medicine-label{font-size:18px;font-weight:700;margin-bottom:8px;color:var(--text-primary)}
        .medicine-status{font-size:14px;color:var(--text-secondary)}
        .calendar-wrapper{margin-top:20px}
        .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .calendar-title{font-size:18px;font-weight:700;color:var(--text-primary)}
        .calendar-nav-btn{padding:8px 12px;background:var(--white);border:1px solid var(--gray-300);border-radius:8px;cursor:pointer;transition:all .3s}
        .calendar-nav-btn:hover{background:var(--hover-bg)}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
        .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:8px}
        .calendar-weekday{text-align:center;font-size:12px;font-weight:600;color:var(--text-secondary);padding:8px 0}
        .calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
        .calendar-day-header{text-align:center;font-size:12px;font-weight:600;color:var(--text-secondary);padding:8px 0}
        .calendar-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--white);border-radius:8px;cursor:pointer;transition:all .3s;position:relative;color:var(--text-primary)}
        .calendar-day.empty{background:transparent;cursor:default}
        .calendar-day:hover:not(.empty){background:var(--hover-bg)}
        .calendar-day.today{background:var(--primary);color:white}
        .calendar-day.selected{background:#ffd700;color:#333;font-weight:700}
        body.dark-mode .calendar-day.selected{background:#b8860b;color:#fff}
        .calendar-day.has-record::after{content:'';position:absolute;bottom:4px;width:6px;height:6px;background:var(--success);border-radius:50%}
        .meal-grid{display:grid;grid-template-columns:1fr;gap:16px;margin-bottom:20px}
        .meal-item{aspect-ratio:16/9;background:var(--white);border-radius:12px;padding:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;border:2px dashed var(--gray-300)}
        .meal-item:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(0,0,0,.1)}
        .meal-item.has-image{border:2px solid var(--success);padding:0;overflow:hidden}
        .meal-item img{width:100%;height:100%;object-fit:cover}
        .meal-placeholder{font-size:32px;margin-bottom:8px}
        .meal-label{font-size:12px;font-weight:600;color:var(--text-secondary)}
        .settings-list{display:flex;flex-direction:column;gap:12px}
        .settings-item{background:var(--white);border-radius:12px;padding:16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:all .3s}
        .settings-item:hover{background:var(--hover-bg)}
        .settings-item-content{display:flex;align-items:center;gap:12px}
        .settings-item-icon{font-size:24px;color:var(--primary)}
        .settings-item-text h6{margin:0;font-size:16px;font-weight:600;color:var(--text-primary)}
        .settings-item-text p{margin:0;font-size:12px;color:var(--text-secondary)}
        .empty-state{text-align:center;padding:60px 20px}
        .empty-state-icon{font-size:64px;color:var(--gray-300);margin-bottom:16px}
        .empty-state-title{font-size:18px;font-weight:700;color:var(--text-secondary);margin-bottom:8px}
        .empty-state-text{font-size:14px;color:var(--text-secondary)}
        .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.75);z-index:2000;align-items:center;justify-content:center;animation:fadeIn .3s}
        body.dark-mode .modal-overlay{background:rgba(0,0,0,.85)}
        .modal-overlay.active{display:flex}
        .modal-content{background:var(--card-bg);border-radius:16px;padding:24px;max-width:90%;max-height:90vh;overflow:auto;animation:slideUp .3s;color:var(--text-primary)}
        @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .modal-title{font-size:20px;font-weight:700;color:var(--text-primary)}
        .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-secondary)}
        .wish-card{position:relative;background:var(--white);border-radius:12px;padding:0;box-shadow:0 1px 3px rgba(0,0,0,.05);overflow:hidden;transition:all .3s}
        .wish-card:hover{box-shadow:0 2px 6px rgba(0,0,0,.08)}
        body.dark-mode .wish-card{box-shadow:0 1px 3px rgba(0,0,0,.3)}
        .wish-card-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;gap:8px}
        .wish-card-title{font-weight:700;font-size:15px;flex:1;margin:0;color:var(--text-primary)}
        .wish-card-body{padding:0 16px 12px 16px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
        .wish-menu-btn{background:none;border:none;color:var(--gray-600);cursor:pointer;font-size:20px;padding:4px 8px;border-radius:6px;transition:all .2s;position:relative}
        .wish-menu-btn:hover{background:var(--gray-100);color:var(--text-primary)}
        .wish-dropdown{position:absolute;top:100%;right:0;background:var(--white);border:1px solid var(--gray-300);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);min-width:160px;z-index:100;display:none}
        body.dark-mode .wish-dropdown{box-shadow:0 4px 12px rgba(0,0,0,.5)}
        .wish-dropdown.active{display:block}
        .wish-dropdown-item{padding:10px 16px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-primary);border:none;background:none;width:100%;text-align:left}
        .wish-dropdown-item:hover{background:var(--hover-bg)}
        .wish-dropdown-item i{font-size:14px;width:16px}
        .wish-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;color:white}
        .wish-info-badge{display:inline-flex;align-items:center;gap:4px;font-size:12px;color:var(--gray-600);padding:4px 8px;background:var(--gray-100);border-radius:8px}
        .wish-status-btn{padding:4px 10px;font-size:11px;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:all .2s}
        .wish-status-btn.completed{background:#e0e7ff;color:#4338ca}
        .wish-status-btn.incomplete{background:#dbeafe;color:#1e40af}
        body.dark-mode .wish-status-btn.completed{background:#312e81;color:#a5b4fc}
        body.dark-mode .wish-status-btn.incomplete{background:#1e3a8a;color:#93c5fd}
        .modal-image{width:100%;border-radius:12px}
        .loading{text-align:center;padding:20px}
        .loading-spinner{width:40px;height:40px;border:4px solid var(--gray-200);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
        @keyframes spin{to{transform:rotate(360deg)}}
        .toast-container{position:fixed;top:20px;right:20px;z-index:3000}
        .toast{background:var(--card-bg);border-radius:12px;padding:16px 24px;box-shadow:0 4px 16px rgba(0,0,0,.2);margin-bottom:12px;animation:slideInRight .3s;color:var(--text-primary)}
        @keyframes slideInRight{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
        .toast.success{border-left:4px solid var(--success)}
        .toast.error{border-left:4px solid var(--danger)}
        .toast.info{border-left:4px solid var(--info)}
        @media (max-width:480px){.app-container{padding:16px 12px}.custom-card{padding:16px}}
        .switch{position:relative;display:inline-block;width:51px;height:28px}
        .switch input{opacity:0;width:0;height:0}
        .switch-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--gray-300);transition:.4s;border-radius:28px}
        .switch-slider:before{position:absolute;content:"";height:20px;width:20px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}
        input:checked+.switch-slider{background-color:var(--success)}
        input:checked+.switch-slider:before{transform:translateX(23px)}
        .points-display{text-align:center;padding:24px 16px;margin:16px 0;background:linear-gradient(135deg,#fef3c7 0%,#fde68a 50%,#fcd34d 100%);border-radius:16px;box-shadow:0 4px 12px rgba(252,211,77,.3);position:relative;overflow:hidden}
        body.dark-mode .points-display{background:linear-gradient(135deg,#422006 0%,#713f12 50%,#854d0e 100%);box-shadow:0 4px 12px rgba(133,77,14,.3)}
        .points-display::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.3) 0%,transparent 70%);animation:shimmer 3s infinite}
        @keyframes shimmer{0%,100%{transform:translate(-50%,-50%) rotate(0deg)}50%{transform:translate(-50%,-50%) rotate(180deg)}}
        .points-label{font-size:14px;font-weight:600;color:#92400e;margin-bottom:12px;position:relative;z-index:1}
        body.dark-mode .points-label{color:#fef3c7}
        .points-content{display:flex;align-items:center;justify-content:center;gap:12px;position:relative;z-index:1}
        .points-icon{font-size:48px;color:#fbbf24;filter:drop-shadow(0 2px 4px rgba(251,191,36,.4));animation:bounce 2s infinite}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
        .points-value{font-size:36px;font-weight:900;color:#78350f;text-shadow:2px 2px 4px rgba(120,53,15,.2)}
        body.dark-mode .points-value{color:#fde68a;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
        .points-unit{font-size:24px;font-weight:700;color:#92400e;margin-left:4px}
        body.dark-mode .points-unit{color:#fde68a}
        .point-items-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
        .point-item-card{background:var(--white);border-radius:16px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);transition:all .3s;cursor:pointer;border:2px solid transparent}
        body.dark-mode .point-item-card{box-shadow:0 2px 8px rgba(0,0,0,.3)}
        .point-item-card:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.15);border-color:var(--primary)}
        body.dark-mode .point-item-card:hover{box-shadow:0 8px 20px rgba(0,0,0,.5)}
        .point-item-card.disabled{opacity:.6;cursor:not-allowed}
        .point-item-card.disabled:hover{transform:none;box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .point-item-icon-wrapper{width:64px;height:64px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:32px;margin-bottom:16px}
        .point-item-name{font-size:18px;font-weight:700;margin-bottom:8px;color:var(--text-primary)}
        .point-item-desc{font-size:14px;color:var(--text-secondary);margin-bottom:16px;min-height:40px}
        .point-item-price{display:flex;align-items:center;gap:8px;padding-top:16px;border-top:1px solid var(--gray-200)}
        .point-item-price-value{font-size:24px;font-weight:900;color:var(--primary)}
        .point-item-price-unit{font-size:16px;font-weight:600;color:var(--gray-600)}
        .expected-points-display{background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 100%);border-radius:16px;padding:20px;margin-bottom:20px;border:2px solid #86efac}
        body.dark-mode .expected-points-display{background:linear-gradient(135deg,#064e3b 0%,#065f46 100%);border-color:#10b981}
        .expected-points-label{font-size:14px;font-weight:600;color:#166534;margin-bottom:8px}
        body.dark-mode .expected-points-label{color:#d1fae5}
        .expected-points-value{font-size:28px;font-weight:900;color:#15803d}
        body.dark-mode .expected-points-value{color:#6ee7b7}
        .meal-item-wrapper{display:flex;flex-direction:column}
        .meal-evaluation{font-size:13px;color:var(--gray-700);animation:fadeIn .3s ease-in}
        .meal-item img{cursor:pointer;transition:transform .2s}
        .meal-item img:hover{transform:scale(1.05)}
        .comment-delete-btn{background:none;border:none;color:var(--danger);cursor:pointer;padding:4px 8px;border-radius:6px;transition:all .2s;margin-left:auto}
        .comment-delete-btn:hover{background:rgba(217,83,79,.1)}
        .calendar-marker{position:absolute;bottom:2px;left:50%;transform:translateX(-50%);display:flex;gap:2px}
        .marker-dot{width:4px;height:4px;border-radius:50%;background:#10b981}
        .marker-dot.meal{background:#f59e0b}
        @media (max-width:768px){
            .meal-grid{flex-direction:column;gap:16px}
            .meal-item-wrapper{width:100%}
            .meal-item{min-height:120px}
        }
        .home-medicine-status{margin-top:20px}
        .medicine-status-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
        .medicine-status-item{background:var(--white);border-radius:12px;padding:16px;text-align:center;border:2px solid var(--gray-300)}
        .medicine-status-item.taken{background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 100%);border-color:var(--success)}
        body.dark-mode .medicine-status-item.taken{background:linear-gradient(135deg,#064e3b 0%,#065f46 100%)}
        .medicine-status-icon{font-size:32px;margin-bottom:8px}
        .medicine-status-label{font-size:14px;font-weight:600;color:var(--text-primary)}
        .medicine-status-text{font-size:12px;color:var(--text-secondary);margin-top:4px}
        .home-meals-section{margin-top:20px}
        .home-meal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
        .home-meal-item{position:relative;aspect-ratio:1;background:var(--white);border-radius:12px;overflow:hidden;border:2px dashed var(--gray-300)}
        .home-meal-item.has-image{border:2px solid var(--success)}
        .home-meal-item img{width:100%;height:100%;object-fit:cover;cursor:pointer}
        .home-meal-placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--gray-400)}
        .home-meal-placeholder i{font-size:32px;margin-bottom:8px}
        .home-meal-label{font-size:12px;font-weight:600}
        .ai-eval-btn{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);background:rgba(74,144,226,0.9);color:white;border:none;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;cursor:pointer;transition:all .3s;backdrop-filter:blur(10px)}
        .ai-eval-btn:hover{background:rgba(74,144,226,1);transform:translateX(-50%) scale(1.05)}
        .calendar-day-content{position:relative;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center}
        .calendar-score{font-size:10px;font-weight:600;margin-top:2px}
        .calendar-medicine-status{display:flex;gap:2px;margin-top:2px}
        .medicine-dot{width:5px;height:5px;border-radius:50%}
        .medicine-dot.morning{background:#fbbf24}
        .medicine-dot.evening{background:#a78bfa}
        @media (max-width:768px){
            .home-meal-grid{grid-template-columns:1fr;gap:16px}
            .home-meal-item{max-width:100%;aspect-ratio:16/9}
        }
        .dark-mode-toggle{
            width:40px;height:40px;border-radius:50%;background:var(--card-bg);border:2px solid var(--gray-300);
            display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;font-size:20px;
            color:var(--text-primary);
        }
        .dark-mode-toggle:hover{transform:scale(1.1);background:var(--hover-bg)}
        .dark-mode-toggle:active{transform:scale(0.95)}
        body.dark-mode .shop-icon-btn{color:#ffffff;border-color:#4a4a4a}
        body.dark-mode .shop-icon-btn:hover{background:rgba(255,255,255,0.1)}
        .shop-icon-btn{position:relative}
        .shop-icon-btn::before{content:'';position:absolute;inset:-12px;border-radius:50%;z-index:-1}
        .image-slider{position:relative;width:100%;overflow:hidden;border-radius:8px;margin-bottom:16px}
        .slider-container{display:flex;transition:transform .3s ease}
        .slider-item{min-width:100%;display:flex;align-items:center;justify-content:center}
        .slider-item img,.slider-item video{width:100%;max-height:500px;object-fit:contain}
        .slider-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.5);color:white;border:none;border-radius:50%;width:40px;height:40px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s;z-index:10}
        .slider-btn:hover{background:rgba(0,0,0,.8)}
        .slider-btn.prev{left:8px}
        .slider-btn.next{right:8px}
        .slider-indicators{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:10}
        .slider-indicator{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.5);cursor:pointer;transition:all .3s}
        .slider-indicator.active{background:white;width:24px;border-radius:4px}
        body.dark-mode .calendar-nav-btn{color:#e5e5e5;border-color:#4a4a4a}
        body.dark-mode .calendar-nav-btn:hover{background:rgba(255,255,255,0.1)}
    </style>
</head>
<body>
<div id="homeTab" class="tab-content-wrapper active">
    <div class="app-container">
        <div class="custom-card">
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar" id="headerUserAvatar"
                         th:data-profile-image="${user.profileImage}"
                         th:data-display-name="${user.displayName}"
                         onclick="showProfileModalFromData(this)">
                        <img th:if="${user.profileImage!=null}" th:src="${user.profileImage}" alt="ÌîÑÎ°úÌïÑ">
                        <span th:if="${user.profileImage==null}" th:text="${user.displayName!=null?user.displayName.substring(0,1):user.username.substring(0,1)}"></span>
                    </div>
                    <div class="user-details">
                        <h5 th:text="${user.displayName!=null?user.displayName:user.username}">ÏÇ¨Ïö©Ïûê</h5>
                        <span class="role-badge" th:text="${user.role.displayName}">Ïó≠Ìï†</span>
                    </div>
                </div>
                <div class="dark-mode-toggle" onclick="toggleDarkMode()" id="homeDarkModeToggle">
                    <i class="bi bi-moon-fill"></i>
                </div>
            </div>
            <div class="points-display" style="position:relative">
                <div class="points-label">ÏõîÍ≥°ÏïÑÎ≤ÑÎãòÏù¥ Î™®ÏùÄÌè¨Ïù∏Ìä∏Îäî?</div>
                <div class="points-content">
                    <i class="bi bi-trophy-fill points-icon"></i>
                    <div>
                        <span class="points-value" id="userPoints" th:text="${user.points != null ? user.points : 0}">0</span>
                        <span class="points-unit">P</span>
                    </div>
                </div>
                <button class="dark-mode-toggle shop-icon-btn" onclick="openModal('pointShopModal');loadPointShop()" style="position:absolute;top:16px;right:16px" title="Ìè¨Ïù∏Ìä∏ ÏÉÅÏ†ê">
                    <i class="bi bi-shop"></i>
                </button>
            </div>

            <div class="comment-section" style="margin-top:20px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;cursor:pointer" onclick="toggleCommentSection()">
                    <h6 style="font-weight:700;margin:0"><i class="bi bi-chat-heart"></i> ÏùëÏõê Î©îÏãúÏßÄ</h6>
                    <i class="bi bi-chevron-down" id="commentToggleIcon" style="font-size:18px;color:var(--primary);transition:transform .3s"></i>
                </div>
                <div id="commentSectionContent" style="display:none">
                <div class="comment-input-wrapper">
                    <div class="comment-input-row">
                        <input type="text" id="commentInput" class="comment-input" placeholder="ÏùëÏõê Î©îÏãúÏßÄÎ•º ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî...">
                        <input type="file" id="commentImageInput" accept="image/*" style="display:none" onchange="handleCommentImageSelect(event)">
                        <button class="comment-image-btn" onclick="document.getElementById('commentImageInput').click()" title="Ïù¥ÎØ∏ÏßÄ Ï≤®Î∂Ä">
                            <i class="bi bi-image"></i>
                        </button>
                        <button class="comment-submit-btn" onclick="submitComment()"><i class="bi bi-send-fill"></i></button>
                    </div>
                    <div id="commentImagePreviewWrapper" class="comment-image-preview-wrapper" style="display:none">
                        <img id="commentImagePreview" class="comment-image-preview">
                        <button class="comment-image-remove" onclick="removeCommentImage()"><i class="bi bi-x"></i></button>
                    </div>
                </div>
                <div class="comment-list" id="commentList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p style="margin-top:12px;color:var(--gray-600)">ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                    </div>
                </div>
                <div class="pagination-wrapper" id="commentPagination"></div>
                </div>
            </div>

            <div class="activity-section" style="margin-top:20px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <h6 style="font-weight:700;margin:0"><i class="bi bi-bell-fill"></i> ÌôúÎèô ÏïåÎ¶º</h6>
                    <button onclick="markAllActivitiesAsRead()" style="background:none;border:none;color:var(--primary);font-size:13px;cursor:pointer;padding:4px 8px;border-radius:6px;transition:background .2s" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='none'">
                        Î™®Îëê ÏùΩÏùå
                    </button>
                </div>
                <div id="activityList" style="display:flex;flex-direction:column;gap:8px;max-height:400px;overflow-y:auto">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p style="margin-top:12px;color:var(--gray-600)">ÌôúÎèôÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                    </div>
                </div>
            </div>

            <div class="home-daily-section" style="margin-top:20px">
                <h6 style="margin-bottom:16px;font-weight:700"><i class="bi bi-images"></i> ÏµúÍ∑º ÏùºÏÉÅ</h6>
                <div id="homeRecentDailies" style="display:flex;flex-direction:column;gap:12px">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p style="margin-top:12px;color:var(--gray-600)">ÏùºÏÉÅÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="healthTab" class="tab-content-wrapper">
    <div class="app-container">
        <!-- ÌÜµÌï© Ï∫òÎ¶∞Îçî -->
        <div class="custom-card">
            <h5 style="margin-bottom:20px;font-weight:700"><i class="bi bi-calendar3"></i> Í±¥Í∞ï Ï∫òÎ¶∞Îçî</h5>
            <div class="calendar-wrapper">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="changeHealthMonth(-1)"><i class="bi bi-chevron-left"></i></button>
                    <div class="calendar-title" id="healthCalendarTitle">2025ÎÖÑ 1Ïõî</div>
                    <button class="calendar-nav-btn" onclick="changeHealthMonth(1)"><i class="bi bi-chevron-right"></i></button>
                </div>
                <div id="healthCalendarGrid"></div>
            </div>
            <div id="healthDayDetails" style="margin-top:20px;display:none"></div>
        </div>

        <!-- ÏòàÏÉÅ Ìè¨Ïù∏Ìä∏ -->
        <div th:if="${user.role.name() == 'FATHER'}" class="expected-points-display" id="healthExpectedPointsDisplay" style="margin-bottom:16px;padding:12px;background:linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%);border-radius:12px">
            <div style="font-size:13px;color:#065f46;font-weight:600;margin-bottom:4px">üíö ÎÇ¥Ïùº Ï†ÅÎ¶Ω ÏòàÏ†ï Ìè¨Ïù∏Ìä∏</div>
            <div style="font-size:20px;font-weight:700;color:#047857"><span id="healthExpectedPointsValue">Í≥ÑÏÇ∞ Ï§ë...</span><span style="font-size:14px;margin-left:4px">p</span></div>
        </div>

        <!-- ÏïΩÎ≥µÏö© ÏÑπÏÖò -->
        <div class="custom-card">
            <h5 style="margin-bottom:20px;font-weight:700"><i class="bi bi-capsule"></i> Ïò§ÎäòÏùò ÏïΩ Î≥µÏö©</h5>
            <div class="medicine-buttons">
                <div class="medicine-btn" id="morningBtn"
                     th:classappend="${morningRecord.taken}?'taken':''"
                     th:data-can-take="${canTakeMedicine}"
                     onclick="handleMedicineClick('MORNING', this)">
                    <div class="medicine-icon">üåÖ</div>
                    <div class="medicine-label">ÏïÑÏπ®</div>
                    <div class="medicine-status" id="morningStatus">
                        <span th:text="${morningRecord.taken}?'Î≥µÏö©ÏôÑÎ£å':'ÎØ∏Î≥µÏö©'">ÎØ∏Î≥µÏö©</span>
                    </div>
                </div>
                <div class="medicine-btn" id="eveningBtn"
                     th:classappend="${eveningRecord.taken}?'taken':''"
                     th:data-can-take="${canTakeMedicine}"
                     onclick="handleMedicineClick('EVENING', this)">
                    <div class="medicine-icon">üåô</div>
                    <div class="medicine-label">Ï†ÄÎÖÅ</div>
                    <div class="medicine-status" id="eveningStatus">
                        <span th:text="${eveningRecord.taken}?'Î≥µÏö©ÏôÑÎ£å':'ÎØ∏Î≥µÏö©'">ÎØ∏Î≥µÏö©</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÏãùÎã®Í¥ÄÎ¶¨ ÏÑπÏÖò -->
        <div class="custom-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h5 style="margin:0;font-weight:700"><i class="bi bi-egg-fried"></i> Ïò§ÎäòÏùò ÏãùÎã®</h5>
                <div id="dailyAverageScore" style="display:none;padding:8px 16px;border-radius:12px;font-weight:700"></div>
            </div>
            <div class="meal-grid">
                <div class="meal-item-wrapper">
                    <div class="meal-item" id="breakfastMeal" onclick="uploadMeal('BREAKFAST')">
                        <div class="meal-placeholder">üç≥</div>
                        <div class="meal-label">ÏïÑÏπ®</div>
                    </div>
                    <div id="breakfastEvaluation" class="meal-evaluation" style="display:none;margin-top:12px"></div>
                </div>
                <div class="meal-item-wrapper">
                    <div class="meal-item" id="lunchMeal" onclick="uploadMeal('LUNCH')">
                        <div class="meal-placeholder">üç±</div>
                        <div class="meal-label">Ï†êÏã¨</div>
                    </div>
                    <div id="lunchEvaluation" class="meal-evaluation" style="display:none;margin-top:12px"></div>
                </div>
                <div class="meal-item-wrapper">
                    <div class="meal-item" id="dinnerMeal" onclick="uploadMeal('DINNER')">
                        <div class="meal-placeholder">üçΩÔ∏è</div>
                        <div class="meal-label">Ï†ÄÎÖÅ</div>
                    </div>
                    <div id="dinnerEvaluation" class="meal-evaluation" style="display:none;margin-top:12px"></div>
                </div>
            </div>
            <input type="file" id="mealImageInput" accept="image/*" style="display:none" onchange="handleMealImageUpload()">
        </div>
    </div>
</div>
<div id="dailyTab" class="tab-content-wrapper">
    <div class="app-container">
        <div class="custom-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <div style="display:flex;align-items:center;gap:12px">
                    <h5 style="margin:0;font-weight:700"><i class="bi bi-images"></i> ÏùºÏÉÅ</h5>
                    <button onclick="toggleDailySearch()" style="width:36px;height:36px;border-radius:50%;background:var(--white);color:var(--text-primary);border:2px solid var(--gray-300);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--gray-300)'" title="Í≤ÄÏÉâ">
                        <i class="bi bi-search" style="font-size:16px"></i>
                    </button>
                </div>
                <button onclick="showDailyPostModal()" style="width:40px;height:40px;border-radius:50%;background:var(--primary);color:white;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;box-shadow:0 2px 8px rgba(74,144,226,.3)" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Í≤åÏãúÎ¨º ÏûëÏÑ±">
                    <i class="bi bi-plus-lg" style="font-size:20px"></i>
                </button>
            </div>
            <div id="dailySearchPanel" style="display:none;margin-bottom:16px;padding:16px;background:var(--white);border-radius:12px;border:1px solid var(--gray-300)">
                <div style="margin-bottom:12px">
                    <label style="display:block;margin-bottom:8px;font-weight:600;font-size:14px">Í≤ÄÏÉâ Ïú†Ìòï</label>
                    <select id="dailySearchType" class="comment-input" style="width:100%">
                        <option value="content">ÎÇ¥Ïö© Í≤ÄÏÉâ</option>
                        <option value="date">ÎÇ†Ïßú Í≤ÄÏÉâ</option>
                    </select>
                </div>
                <div id="dailySearchContent" style="margin-bottom:12px">
                    <label style="display:block;margin-bottom:8px;font-weight:600;font-size:14px">Í≤ÄÏÉâÏñ¥</label>
                    <input type="text" id="dailySearchInput" class="comment-input" style="width:100%" placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                </div>
                <div id="dailySearchDate" style="display:none;margin-bottom:12px">
                    <label style="display:block;margin-bottom:8px;font-weight:600;font-size:14px">ÎÇ†Ïßú</label>
                    <input type="date" id="dailySearchDateInput" class="comment-input" style="width:100%">
                </div>
                <button onclick="searchDailyPosts()" class="comment-submit-btn" style="width:100%">
                    <i class="bi bi-search"></i> Í≤ÄÏÉâ
                </button>
            </div>
            <div id="dailyPostsGrid" style="display:flex;flex-direction:column;gap:20px">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p style="margin-top:12px;color:var(--gray-600)">ÏùºÏÉÅÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wishTab" class="tab-content-wrapper">
    <div class="app-container">
        <div class="custom-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h5 style="margin:0;font-weight:700"><i class="bi bi-star-fill"></i> ÏúÑÏãúÎ¶¨Ïä§Ìä∏</h5>
                <button onclick="showWishModal()" style="width:40px;height:40px;border-radius:50%;background:var(--primary);color:white;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;box-shadow:0 2px 8px rgba(74,144,226,.3)" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="ÏúÑÏãú Ï∂îÍ∞Ä">
                    <i class="bi bi-plus-lg" style="font-size:20px"></i>
                </button>
            </div>
            <div id="wishListGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p style="margin-top:12px;color:var(--gray-600)">ÏúÑÏãúÎ¶¨Ïä§Ìä∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                </div>
            </div>
        </div>

        <div class="custom-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h5 style="margin:0;font-weight:700"><i class="bi bi-calendar-event"></i> ÏùºÏ†ï</h5>
            </div>
            <div class="calendar-wrapper">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="changeWishMonth(-1)"><i class="bi bi-chevron-left"></i></button>
                    <div class="calendar-title" id="wishCalendarTitle">2025ÎÖÑ 1Ïõî</div>
                    <button class="calendar-nav-btn" onclick="changeWishMonth(1)"><i class="bi bi-chevron-right"></i></button>
                </div>
                <div id="wishCalendarGrid"></div>
            </div>
            <div id="wishScheduleList" style="margin-top:20px;display:flex;flex-direction:column;gap:12px"></div>
        </div>
    </div>
</div>
<div id="settingsTab" class="tab-content-wrapper">
    <div class="app-container">
        <div class="custom-card">
            <h5 style="margin-bottom:20px;font-weight:700"><i class="bi bi-gear"></i> ÏÑ§Ï†ï</h5>
            <div class="settings-list">
                <div class="settings-item" onclick="showProfileSettings()">
                    <div class="settings-item-content">
                        <div class="settings-item-icon"><i class="bi bi-person-circle"></i></div>
                        <div class="settings-item-text">
                            <h6>ÌîÑÎ°úÌïÑ Î≥ÄÍ≤Ω</h6>
                            <p>ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ Î∞è ÌëúÏãú Ïù¥Î¶Ñ Î≥ÄÍ≤Ω</p>
                        </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
                <div class="settings-item" onclick="showPasswordSettings()">
                    <div class="settings-item-content">
                        <div class="settings-item-icon"><i class="bi bi-shield-lock"></i></div>
                        <div class="settings-item-text">
                            <h6>ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</h6>
                            <p>Í≥ÑÏ†ï Î≥¥ÏïàÏùÑ ÏúÑÌï¥ ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</p>
                        </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
                <div class="settings-item">
                    <div class="settings-item-content">
                        <div class="settings-item-icon"><i class="bi bi-moon-stars"></i></div>
                        <div class="settings-item-text">
                            <h6>Îã§ÌÅ¨ Î™®Îìú</h6>
                            <p>ÌôîÎ©¥ ÌÖåÎßà Î≥ÄÍ≤Ω</p>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode()">
                        <span class="switch-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <div class="settings-item-content">
                        <div class="settings-item-icon"><i class="bi bi-bell"></i></div>
                        <div class="settings-item-text">
                            <h6>Push ÏïåÎ¶º</h6>
                            <p>ÏïΩ Î≥µÏö© ÏïåÎ¶º ÏÑ§Ï†ï</p>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="pushNotificationSwitch" onchange="togglePushNotification()">
                        <span class="switch-slider"></span>
                    </label>
                </div>
                <div class="settings-item" onclick="openModal('pointShopModal');loadPointShop()">
                    <div class="settings-item-content">
                        <div class="settings-item-icon" style="color:#f59e0b"><i class="bi bi-shop"></i></div>
                        <div class="settings-item-text">
                            <h6>Ìè¨Ïù∏Ìä∏ ÏÉÅÏ†ê</h6>
                            <p>Ìè¨Ïù∏Ìä∏Î°ú ÏÉÅÌíà Íµ¨Îß§ÌïòÍ∏∞</p>
                        </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
                <div class="settings-item" th:if="${user.role.name() == 'ADMIN'}" onclick="showPointItemManagement()">
                    <div class="settings-item-content">
                        <div class="settings-item-icon" style="color:var(--primary)"><i class="bi bi-shop-window"></i></div>
                        <div class="settings-item-text">
                            <h6>Ìè¨Ïù∏Ìä∏ ÏÉÅÌíà Í¥ÄÎ¶¨</h6>
                            <p>Ìè¨Ïù∏Ìä∏ ÏÉÅÌíà Îì±Î°ù Î∞è ÏÇ≠Ï†ú (Í¥ÄÎ¶¨Ïûê Ï†ÑÏö©)</p>
                        </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
                <div class="settings-item" onclick="logout()">
                    <div class="settings-item-content">
                        <div class="settings-item-icon" style="color:var(--danger)"><i class="bi bi-box-arrow-right"></i></div>
                        <div class="settings-item-text">
                            <h6 style="color:var(--danger)">Î°úÍ∑∏ÏïÑÏõÉ</h6>
                            <p>Í≥ÑÏ†ïÏóêÏÑú Î°úÍ∑∏ÏïÑÏõÉ</p>
                        </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
            </div>
        </div>
    </div>
</div>
<nav class="bottom-nav">
    <div class="nav-item active" data-tab="homeTab"><i class="bi bi-house-door-fill"></i><span>Ìôà</span></div>
    <div class="nav-item" data-tab="healthTab"><i class="bi bi-heart-pulse-fill"></i><span>Í±¥Í∞ï</span></div>
    <div class="nav-item" data-tab="wishTab"><i class="bi bi-star-fill"></i><span>ÏúÑÏãú</span></div>
    <div class="nav-item" data-tab="dailyTab"><i class="bi bi-images"></i><span>ÏùºÏÉÅ</span></div>
    <div class="nav-item" data-tab="settingsTab"><i class="bi bi-gear"></i><span>ÏÑ§Ï†ï</span></div>
</nav>
<div class="modal-overlay" id="profileModal" onclick="closeProfileModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title" id="profileModalTitle">ÌîÑÎ°úÌïÑ</div>
            <button class="modal-close" onclick="closeProfileModal()"><i class="bi bi-x"></i></button>
        </div>
        <img class="modal-image" id="profileModalImage" src="" alt="ÌîÑÎ°úÌïÑ">
    </div>
</div>
<div class="modal-overlay" id="profileSettingsModal" onclick="closeModal('profileSettingsModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:400px">
        <div class="modal-header">
            <div class="modal-title">ÌîÑÎ°úÌïÑ Î≥ÄÍ≤Ω</div>
            <button class="modal-close" onclick="closeModal('profileSettingsModal')"><i class="bi bi-x"></i></button>
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">ÌëúÏãú Ïù¥Î¶Ñ</label>
            <input type="text" id="displayNameInput" class="comment-input" style="width:100%" th:value="${user.displayName}" placeholder="ÌëúÏãú Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ</label>
            <input type="file" id="profileImageInput" accept="image/*" style="width:100%">
        </div>
        <button class="comment-submit-btn" style="width:100%" onclick="updateProfile()">Ï†ÄÏû•</button>
    </div>
</div>
<div class="modal-overlay" id="passwordSettingsModal" onclick="closeModal('passwordSettingsModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:400px">
        <div class="modal-header">
            <div class="modal-title">ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</div>
            <button class="modal-close" onclick="closeModal('passwordSettingsModal')"><i class="bi bi-x"></i></button>
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏</label>
            <input type="password" id="currentPassword" class="comment-input" style="width:100%" placeholder="ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏">
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏</label>
            <input type="password" id="newPassword" class="comment-input" style="width:100%" placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏">
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label>
            <input type="password" id="confirmPassword" class="comment-input" style="width:100%" placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏">
        </div>
        <button class="comment-submit-btn" style="width:100%" onclick="updatePassword()">Î≥ÄÍ≤Ω</button>
    </div>
</div>
<div class="modal-overlay" id="aiEvaluationModal" onclick="closeModal('aiEvaluationModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:500px">
        <div class="modal-header">
            <div class="modal-title" id="aiEvalModalTitle">AI ÏãùÎã® ÌèâÍ∞Ä</div>
            <button class="modal-close" onclick="closeModal('aiEvaluationModal')"><i class="bi bi-x"></i></button>
        </div>
        <div id="aiEvalModalContent" style="line-height:1.8">
            <p>ÌèâÍ∞Ä ÎÇ¥Ïö©ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
        </div>
    </div>
</div>
<div class="modal-overlay" id="imageModal" onclick="closeModal('imageModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title" id="profileModalTitle">Ïù¥ÎØ∏ÏßÄ</div>
            <button class="modal-close" onclick="closeModal('imageModal')"><i class="bi bi-x"></i></button>
        </div>
        <div id="modalImage">
            <img class="modal-image" id="imageModalImage" src="" alt="Ïù¥ÎØ∏ÏßÄ">
        </div>
    </div>
</div>
<div class="modal-overlay" id="pointItemManagementModal" onclick="closeModal('pointItemManagementModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:800px;max-height:90vh;overflow-y:auto">
        <div class="modal-header">
            <div class="modal-title">Ìè¨Ïù∏Ìä∏ ÏÉÅÌíà Í¥ÄÎ¶¨</div>
            <button class="modal-close" onclick="closeModal('pointItemManagementModal')"><i class="bi bi-x"></i></button>
        </div>
        <div style="margin-bottom:20px">
            <h6 style="font-weight:700;margin-bottom:12px">ÏÉà ÏÉÅÌíà Îì±Î°ù</h6>
            <form id="pointItemForm" onsubmit="submitPointItem(event)">
                <input type="hidden" id="editItemId" value="">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
                    <div>
                        <label style="display:block;margin-bottom:4px;font-weight:600;font-size:14px">ÏÉÅÌíàÎ™Ö *</label>
                        <input type="text" id="itemName" class="comment-input" style="width:100%" placeholder="ÏÉÅÌíàÎ™Ö" required>
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:4px;font-weight:600;font-size:14px">ÌïÑÏöî Ìè¨Ïù∏Ìä∏ *</label>
                        <input type="number" id="itemPoints" class="comment-input" style="width:100%" placeholder="1000" required>
                    </div>
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:block;margin-bottom:4px;font-weight:600;font-size:14px">ÏÉÅÏÑ∏ ÏÑ§Î™Ö</label>
                    <textarea id="itemDescription" class="comment-input" style="width:100%;min-height:80px;border-radius:12px" placeholder="ÏÉÅÌíà ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
                    <div>
                        <label style="display:block;margin-bottom:4px;font-weight:600;font-size:14px">ÏïÑÏù¥ÏΩò (Bootstrap)</label>
                        <input type="text" id="itemIcon" class="comment-input" style="width:100%" placeholder="gift">
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:4px;font-weight:600;font-size:14px">ÏÉâÏÉÅ (HEX)</label>
                        <input type="text" id="itemColor" class="comment-input" style="width:100%" placeholder="#4A90E2">
                    </div>
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:block;margin-bottom:4px;font-weight:600;font-size:14px">ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ</label>
                    <input type="file" id="itemImage" accept="image/*" style="width:100%">
                </div>
                <button type="submit" class="comment-submit-btn" style="width:100%">
                    <i class="bi bi-plus-circle"></i> ÏÉÅÌíà Îì±Î°ù
                </button>
            </form>
        </div>
        <div>
            <h6 style="font-weight:700;margin-bottom:12px">Îì±Î°ùÎêú ÏÉÅÌíà Î™©Î°ù</h6>
            <div id="adminItemsList" style="display:flex;flex-direction:column;gap:12px"></div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="pointShopModal" onclick="closeModal('pointShopModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:800px;max-height:90vh;overflow-y:auto">
        <div class="modal-header">
            <div class="modal-title">Ìè¨Ïù∏Ìä∏ ÏÉÅÏ†ê</div>
            <button class="modal-close" onclick="closeModal('pointShopModal')"><i class="bi bi-x"></i></button>
        </div>
        <div class="points-display" style="margin-bottom:24px">
            <div class="points-label">Î≥¥Ïú† Ìè¨Ïù∏Ìä∏</div>
            <div class="points-content">
                <i class="bi bi-trophy-fill points-icon"></i>
                <div>
                    <span class="points-value" id="modalCurrentPoints" th:text="${user.points != null ? user.points : 0}">0</span>
                    <span class="points-unit">pt</span>
                </div>
            </div>
        </div>
        <div class="point-items-grid" id="modalPointItemsGrid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p style="margin-top:12px;color:var(--gray-600)">ÏÉÅÌíàÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
            </div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="dailyPostModal" onclick="closeModal('dailyPostModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:600px">
        <div class="modal-header">
            <div class="modal-title">ÏùºÏÉÅ Í≤åÏãúÎ¨º ÏûëÏÑ±</div>
            <button class="modal-close" onclick="closeModal('dailyPostModal')"><i class="bi bi-x"></i></button>
        </div>
        <form id="dailyPostForm" onsubmit="submitDailyPost(event)">
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ÎÇ¥Ïö©</label>
                <textarea id="dailyContent" class="comment-input" style="width:100%;min-height:120px;border-radius:12px;resize:vertical" placeholder="Ïò§ÎäòÏùò ÏùºÏÉÅÏùÑ Í≥µÏú†Ìï¥Ï£ºÏÑ∏Ïöî..." required></textarea>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ÏÇ¨ÏßÑ/ÏòÅÏÉÅ (Ïó¨Îü¨ Í∞ú ÏÑ†ÌÉù Í∞ÄÎä•)</label>
                <input type="file" id="dailyMedia" accept="image/*,video/*" multiple style="display:none" onchange="handleDailyMediaSelect(event)">
                <button type="button" class="comment-submit-btn" onclick="document.getElementById('dailyMedia').click()" style="width:100%;justify-content:center;gap:8px">
                    <i class="bi bi-image-fill"></i> ÏÇ¨ÏßÑ/ÏòÅÏÉÅ ÏÑ†ÌÉù
                </button>
                <div id="dailyMediaPreview" style="margin-top:12px;display:none;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px"></div>
            </div>
            <button type="submit" class="comment-submit-btn" style="width:100%">
                <i class="bi bi-send-fill"></i> Í≤åÏãúÌïòÍ∏∞
            </button>
        </form>
    </div>
</div>
<div class="modal-overlay" id="wishModal" onclick="closeModal('wishModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:700px;max-height:90vh;overflow-y:auto">
        <div class="modal-header">
            <div class="modal-title">ÏúÑÏãú Ï∂îÍ∞Ä</div>
            <button class="modal-close" onclick="closeModal('wishModal')"><i class="bi bi-x"></i></button>
        </div>
        <form id="wishForm" onsubmit="submitWish(event)">
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">Ï†úÎ™©</label>
                <input type="text" id="wishTitle" class="comment-input" style="width:100%;border-radius:12px" placeholder="Ïòà: Í∞ïÎÇ® ÎßõÏßë Î∞©Î¨∏" required>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ÏÑ§Î™Ö</label>
                <textarea id="wishDescription" class="comment-input" style="width:100%;min-height:100px;border-radius:12px;resize:vertical" placeholder="ÏÉÅÏÑ∏ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                <select id="wishCategory" class="comment-input" style="width:100%;border-radius:12px" required>
                    <option value="">Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù</option>
                    <option value="RESTAURANT">ÎßõÏßë</option>
                    <option value="TRAVEL">Ïó¨ÌñâÏßÄ</option>
                    <option value="SHOPPING">ÏáºÌïë</option>
                    <option value="CAFE">Ïπ¥Ìéò</option>
                    <option value="ACTIVITY">Ïï°Ìã∞ÎπÑÌã∞</option>
                    <option value="OTHER">Í∏∞ÌÉÄ</option>
                </select>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ÏúÑÏπò Í≤ÄÏÉâ</label>
                <div style="display:flex;gap:8px;margin-bottom:8px">
                    <input type="text" id="wishLocationSearch" class="comment-input" style="flex:1;border-radius:12px" placeholder="Ïû•ÏÜåÎ™Ö ÎòêÎäî Ï£ºÏÜå Í≤ÄÏÉâ">
                    <button type="button" class="comment-submit-btn" onclick="searchLocation()">
                        <i class="bi bi-search"></i> Í≤ÄÏÉâ
                    </button>
                </div>
                <div id="naverMap" style="width:100%;height:300px;border-radius:12px;overflow:hidden;margin-bottom:8px"></div>
                <input type="hidden" id="wishLatitude">
                <input type="hidden" id="wishLongitude">
                <input type="text" id="wishAddress" class="comment-input" style="width:100%;border-radius:12px" placeholder="ÏÑ†ÌÉùÎêú Ï£ºÏÜå" readonly>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">Ïù¥ÎØ∏ÏßÄ (ÏÑ†ÌÉù)</label>
                <input type="file" id="wishImage" accept="image/*" style="display:none" onchange="handleWishImageSelect(event)">
                <button type="button" class="comment-submit-btn" onclick="document.getElementById('wishImage').click()" style="width:100%;justify-content:center;gap:8px">
                    <i class="bi bi-image-fill"></i> Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù
                </button>
                <div id="wishImagePreview" style="margin-top:12px;display:none"></div>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ÏùºÏ†ï Ï∂îÍ∞Ä (ÏÑ†ÌÉù)</label>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div>
                        <label style="display:block;margin-bottom:4px;font-size:12px;color:var(--gray-600)">ÎÇ†Ïßú</label>
                        <input type="date" id="wishScheduleDate" class="comment-input" style="width:100%;border-radius:12px">
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:4px;font-size:12px;color:var(--gray-600)">ÏãúÍ∞Ñ</label>
                        <input type="time" id="wishScheduleTime" class="comment-input" style="width:100%;border-radius:12px">
                    </div>
                </div>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ÏùºÏÉÅ Í≤åÏãúÎ¨º Ïó∞Í≤∞ (ÏÑ†ÌÉù)</label>
                <select id="wishDailyLink" class="comment-input" style="width:100%;border-radius:12px">
                    <option value="">Ïó∞Í≤∞Ìï† ÏùºÏÉÅ Í≤åÏãúÎ¨º ÏÑ†ÌÉù</option>
                </select>
                <p style="font-size:12px;color:var(--gray-600);margin-top:4px">ÏúÑÏãú Ìï≠Î™©Í≥º Í¥ÄÎ†®Îêú ÏùºÏÉÅ Í≤åÏãúÎ¨ºÏùÑ Ïó∞Í≤∞Ìï† Ïàò ÏûàÏäµÎãàÎã§</p>
            </div>
            <button type="submit" class="comment-submit-btn" style="width:100%">
                <i class="bi bi-star-fill"></i> ÏúÑÏãú Ï∂îÍ∞ÄÌïòÍ∏∞
            </button>
        </form>
    </div>
</div>
<div class="toast-container" id="toastContainer"></div>
<script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=YOUR_CLIENT_ID&submodules=geocoder"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
<script>
const currentUserId='[[${user.id}]]';
const currentUsername='[[${user.username}]]';
const canTakeMedicine=[[${canTakeMedicine}]];
let currentTab='homeTab',currentPage=1,commentsPerPage=10,allComments=[],currentMealType=null,currentCalendarDate=new Date();
let messaging=null,currentFcmToken=null,currentMealData={};
document.addEventListener('DOMContentLoaded',function(){initializeDarkMode();initializeNavigation();loadComments();initializeMedicineStatus();initializeMealStatus();loadHomeRecentDailies();loadActivities();checkPushNotificationStatus();calculateExpectedPoints();initializeFirebase();initActivitySSE()});
function initializeDarkMode(){const darkMode=localStorage.getItem('darkMode')==='true';if(darkMode){document.body.classList.add('dark-mode');updateDarkModeUI(true)}else{updateDarkModeUI(false)}}
function toggleDarkMode(){const isDark=document.body.classList.toggle('dark-mode');localStorage.setItem('darkMode',isDark);updateDarkModeUI(isDark);showToast(isDark?'Îã§ÌÅ¨ Î™®ÎìúÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.':'ÎùºÏù¥Ìä∏ Î™®ÎìúÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.','success')}
function updateDarkModeUI(isDark){const homeToggle=document.getElementById('homeDarkModeToggle');const settingsSwitch=document.getElementById('darkModeSwitch');if(homeToggle){homeToggle.innerHTML=isDark?'<i class="bi bi-sun-fill"></i>':'<i class="bi bi-moon-fill"></i>'}if(settingsSwitch){settingsSwitch.checked=isDark}}
function initializeNavigation(){document.querySelectorAll('.nav-item').forEach(item=>{item.addEventListener('click',function(){switchTab(this.getAttribute('data-tab'))})})}
function switchTab(tabId){document.querySelectorAll('.tab-content-wrapper').forEach(tab=>tab.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(item=>item.classList.remove('active'));const tabElement=document.getElementById(tabId);const navElement=document.querySelector(`[data-tab="${tabId}"]`);if(tabElement){tabElement.classList.add('active')}if(navElement){navElement.classList.add('active')}currentTab=tabId;if(tabId==='healthTab'){initializeMedicineStatus();initializeMealStatus();renderHealthCalendar()}else if(tabId==='dailyTab'){loadDailies()}else if(tabId==='wishTab'){loadWishes();loadWishSchedules()}}
async function loadComments(){try{const response=await fetch('/api/comments');allComments=await response.json();renderComments()}catch(error){console.error('ÎåìÍ∏Ä Î°úÎìú Ïã§Ìå®:',error);showToast('ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
let commentImageData=null;
function handleCommentImageSelect(event){const file=event.target.files[0];if(!file)return;if(file.size>5*1024*1024){showToast('Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞Îäî 5MB Ïù¥ÌïòÏó¨Ïïº Ìï©ÎãàÎã§.','error');return}const reader=new FileReader();reader.onload=function(e){const img=new Image();img.onload=function(){const maxWidth=600;const maxHeight=600;let width=img.width;let height=img.height;if(width>height){if(width>maxWidth){height*=maxWidth/width;width=maxWidth}}else{if(height>maxHeight){width*=maxHeight/height;height=maxHeight}}const canvas=document.createElement('canvas');canvas.width=width;canvas.height=height;const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0,width,height);commentImageData=canvas.toDataURL('image/jpeg',0.85);document.getElementById('commentImagePreview').src=commentImageData;document.getElementById('commentImagePreviewWrapper').style.display='block';document.querySelector('.comment-image-btn').classList.add('active')};img.src=e.target.result};reader.readAsDataURL(file)}
function removeCommentImage(){commentImageData=null;document.getElementById('commentImageInput').value='';document.getElementById('commentImagePreviewWrapper').style.display='none';document.querySelector('.comment-image-btn').classList.remove('active')}
function showReplyInput(commentId){const existingReplyWrapper=document.querySelector('.reply-input-wrapper.active');if(existingReplyWrapper)existingReplyWrapper.remove();const replyHtml=`<div class="reply-input-wrapper active" id="reply-${commentId}"><div class="comment-input-row"><input type="text" id="replyInput-${commentId}" class="comment-input" placeholder="ÎãµÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."><button class="comment-submit-btn" onclick="submitReply(${commentId})"><i class="bi bi-send-fill"></i></button><button class="comment-submit-btn" style="background:var(--gray-600)" onclick="cancelReply(${commentId})">Ï∑®ÏÜå</button></div></div>`;const commentEl=document.querySelector(`[data-comment-id="${commentId}"]`);if(commentEl){commentEl.insertAdjacentHTML('afterend',replyHtml);document.getElementById(`replyInput-${commentId}`).focus()}}
function cancelReply(commentId){const replyWrapper=document.getElementById(`reply-${commentId}`);if(replyWrapper)replyWrapper.remove()}
async function submitReply(parentCommentId){const input=document.getElementById(`replyInput-${parentCommentId}`);const content=input.value.trim();if(!content){showToast('ÎãµÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.','error');return}try{const response=await fetch('/api/comments',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content,parentCommentId})});if(response.ok){input.value='';showToast('ÎãµÍ∏ÄÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.','success');cancelReply(parentCommentId);await loadComments()}else throw new Error('ÎãµÍ∏Ä Îì±Î°ù Ïã§Ìå®')}catch(error){console.error('ÎãµÍ∏Ä Îì±Î°ù Ïã§Ìå®:',error);showToast('ÎãµÍ∏Ä Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
function renderComments(){const commentList=document.getElementById('commentList');const parentComments=allComments.filter(c=>!c.parentComment);const totalPages=Math.ceil(parentComments.length/commentsPerPage);const startIndex=(currentPage-1)*commentsPerPage;const pageComments=parentComments.slice(startIndex,startIndex+commentsPerPage);if(!pageComments.length){commentList.innerHTML='<div class="empty-state"><div class="empty-state-icon"><i class="bi bi-chat"></i></div><div class="empty-state-title">ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§</div><div class="empty-state-text">Ï≤´ Î≤àÏß∏ ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!</div></div>';return}const oneDayAgo=new Date(Date.now()-864e5);let html='';pageComments.forEach(comment=>{const createdAt=new Date(comment.createdAt);const isNew=createdAt>oneDayAgo;html+=`<div class="comment-item ${isNew?'new':''}" data-comment-id="${comment.id}"><div class="comment-header"><div class="comment-avatar" onclick="showProfileModal('${comment.user?.profileImage||''}','${comment.user?.displayName||''}')">${comment.user?.profileImage?`<img src="${comment.user.profileImage}" alt="${comment.user.displayName}">`:comment.user?.displayName?.substring(0,1)||'U'}</div><div class="comment-user-info"><div class="comment-username">${comment.user?.displayName||'ÏÇ¨Ïö©Ïûê'}</div><div class="comment-time">${formatTimeAgo(createdAt)}</div></div>${comment.user?.id==currentUserId?`<button class="comment-delete-btn" onclick="event.stopPropagation();deleteComment(${comment.id})" title="ÏÇ≠Ï†ú"><i class="bi bi-trash"></i></button>`:''}</div><div class="comment-content">${escapeHtml(comment.content)}</div>${comment.imageUrl?`<img class="comment-image" src="${comment.imageUrl}" onclick="showImageModal('${comment.imageUrl}')">`:''}<div class="comment-actions"><button class="comment-action-btn ${comment.likedUserIds&&comment.likedUserIds.includes(parseInt(currentUserId))?'liked':''}" onclick="toggleLike(${comment.id})"><i class="bi bi-heart-fill"></i><span>${comment.likesCount||0}</span></button><button class="comment-action-btn" onclick="showReplyInput(${comment.id})"><i class="bi bi-reply-fill"></i> ÎãµÍ∏Ä</button></div></div>`;const replies=allComments.filter(r=>r.parentComment&&r.parentComment.id===comment.id);replies.forEach(reply=>{const replyCreatedAt=new Date(reply.createdAt);const replyIsNew=replyCreatedAt>oneDayAgo;html+=`<div class="comment-item reply ${replyIsNew?'new':''}" data-comment-id="${reply.id}"><div class="comment-header"><div class="comment-avatar" onclick="showProfileModal('${reply.user?.profileImage||''}','${reply.user?.displayName||''}')">${reply.user?.profileImage?`<img src="${reply.user.profileImage}" alt="${reply.user.displayName}">`:reply.user?.displayName?.substring(0,1)||'U'}</div><div class="comment-user-info"><div class="comment-username">${reply.user?.displayName||'ÏÇ¨Ïö©Ïûê'}</div><div class="comment-time">${formatTimeAgo(replyCreatedAt)}</div></div>${reply.user?.id==currentUserId?`<button class="comment-delete-btn" onclick="event.stopPropagation();deleteComment(${reply.id})" title="ÏÇ≠Ï†ú"><i class="bi bi-trash"></i></button>`:''}</div><div class="comment-content">${escapeHtml(reply.content)}</div>${reply.imageUrl?`<img class="comment-image" src="${reply.imageUrl}" onclick="showImageModal('${reply.imageUrl}')">`:''}<div class="comment-actions"><button class="comment-action-btn ${reply.likedUserIds&&reply.likedUserIds.includes(parseInt(currentUserId))?'liked':''}" onclick="toggleLike(${reply.id})"><i class="bi bi-heart-fill"></i><span>${reply.likesCount||0}</span></button></div></div>`})});commentList.innerHTML=html;renderPagination(totalPages)}
function renderPagination(totalPages){const paginationWrapper=document.getElementById('commentPagination');if(totalPages<=1){paginationWrapper.innerHTML='';return}let html='<div class="pagination">';if(currentPage>1)html+=`<button class="page-btn" onclick="changePage(${currentPage-1})"><i class="bi bi-chevron-left"></i></button>`;for(let i=1;i<=totalPages;i++){if(i===1||i===totalPages||(i>=currentPage-1&&i<=currentPage+1))html+=`<button class="page-btn ${i===currentPage?'active':''}" onclick="changePage(${i})">${i}</button>`;else if(i===currentPage-2||i===currentPage+2)html+='<span style="padding:8px">...</span>'}if(currentPage<totalPages)html+=`<button class="page-btn" onclick="changePage(${currentPage+1})"><i class="bi bi-chevron-right"></i></button>`;paginationWrapper.innerHTML=html+'</div>'}
function changePage(page){currentPage=page;renderComments();window.scrollTo({top:0,behavior:'smooth'})}
async function submitComment(){const input=document.getElementById('commentInput');const content=input.value.trim();if(!content){showToast('ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.','error');return}try{const response=await fetch('/api/comments',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content,imageData:commentImageData})});if(response.ok){input.value='';removeCommentImage();showToast('ÎåìÍ∏ÄÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.','success');await loadComments()}else throw new Error('ÎåìÍ∏Ä Îì±Î°ù Ïã§Ìå®')}catch(error){console.error('ÎåìÍ∏Ä Îì±Î°ù Ïã§Ìå®:',error);showToast('ÎåìÍ∏Ä Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function toggleLike(commentId){try{const response=await fetch(`/api/comments/${commentId}/like`,{method:'POST'});if(response.ok)await loadComments();else throw new Error('Ï¢ãÏïÑÏöî Ïã§Ìå®')}catch(error){console.error('Ï¢ãÏïÑÏöî Ïã§Ìå®:',error);showToast('Ï¢ãÏïÑÏöîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function deleteComment(commentId){if(!confirm('ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?'))return;try{const response=await fetch(`/api/comments/${commentId}`,{method:'DELETE'});if(response.ok){showToast('ÎåìÍ∏ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.','success');await loadComments()}else{const error=await response.json();showToast(error.error||'ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}catch(error){console.error('ÎåìÍ∏Ä ÏÇ≠Ï†ú Ïã§Ìå®:',error);showToast('ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
function initializeMedicineStatus(){const morningTaken=[[${morningRecord.taken}]];const eveningTaken=[[${eveningRecord.taken}]];if(morningTaken)document.getElementById('morningBtn').classList.add('taken');if(eveningTaken)document.getElementById('eveningBtn').classList.add('taken')}
function handleMedicineClick(type,element){toggleMedicine(type,element)}
async function toggleMedicine(type,element){const btn=element||document.getElementById(type==='MORNING'?'morningBtn':'eveningBtn');const isTaken=btn.classList.contains('taken');const canTake=btn.getAttribute('data-can-take')==='true';if(!isTaken&&!canTake){showToast('ÏïΩ Î≥µÏö© Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.','error');return}btn.classList.toggle('taken');const statusEl=document.getElementById(type.toLowerCase()+'Status').querySelector('span');statusEl.textContent=isTaken?'ÎØ∏Î≥µÏö©':'Î≥µÏö©ÏôÑÎ£å';try{const response=await fetch(isTaken?'/api/medicine/cancel':'/api/medicine/take',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:`medicineType=${type}`});if(response.ok){showToast(isTaken?'ÏïΩ Î≥µÏö©Ïù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.':'ÏïΩ Î≥µÏö©Ïù¥ Í∏∞Î°ùÎêòÏóàÏäµÎãàÎã§.','success')}else{btn.classList.toggle('taken');statusEl.textContent=isTaken?'Î≥µÏö©ÏôÑÎ£å':'ÎØ∏Î≥µÏö©';throw new Error('ÏïΩ Î≥µÏö© Ï≤òÎ¶¨ Ïã§Ìå®')}}catch(error){console.error('ÏïΩ Î≥µÏö© Ï≤òÎ¶¨ Ïã§Ìå®:',error);showToast('ÏïΩ Î≥µÏö© Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
function initializeCalendar(){renderCalendar()}
async function renderCalendar(){const year=currentCalendarDate.getFullYear(),month=currentCalendarDate.getMonth();document.getElementById('calendarTitle').textContent=`${year}ÎÖÑ ${month+1}Ïõî`;const firstDay=new Date(year,month,1).getDay(),daysInMonth=new Date(year,month+1,0).getDate(),today=new Date();let medicineData={};try{const response=await fetch(`/api/medicine/calendar/${year}/${month+1}`);const data=await response.json();if(data.records){data.records.forEach(record=>{const day=new Date(record.date).getDate();if(!medicineData[day])medicineData[day]={morning:false,evening:false};if(record.medicineType==='MORNING')medicineData[day].morning=record.taken;else if(record.medicineType==='EVENING')medicineData[day].evening=record.taken})}}catch(error){console.error('ÏïΩÎ≥µÏö© Îã¨Î†• Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:',error)}let html='';['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'].forEach(day=>html+=`<div class="calendar-day-header">${day}</div>`);for(let i=0;i<firstDay;i++)html+='<div></div>';for(let day=1;day<=daysInMonth;day++){const date=new Date(year,month,day);const medData=medicineData[day];let statusHtml='';if(medData){statusHtml='<div class="calendar-medicine-status">';if(medData.morning)statusHtml+='<div class="medicine-dot morning"></div>';if(medData.evening)statusHtml+='<div class="medicine-dot evening"></div>';statusHtml+='</div>'}html+=`<div class="calendar-day ${date.toDateString()===today.toDateString()?'today':''}" onclick="selectDate('${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}')"><div class="calendar-day-content">${day}${statusHtml}</div></div>`}document.getElementById('calendarGrid').innerHTML=html}
function changeMonth(delta){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+delta);renderCalendar()}
function changeMealMonth(delta){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+delta);renderMealCalendar()}
function selectDate(dateStr){showToast(`${dateStr} ÏÑ†ÌÉùÎê®`,'info');loadDateData(dateStr)}
function selectMealDate(dateStr){loadDateData(dateStr)}
async function loadDateData(dateStr){try{const response=await fetch(`/api/meal/date/${dateStr}`);const data=await response.json();if(data.success){updateMealDisplay(data.meals||[],data.stats)}}catch(error){console.error('ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:',error)}}
async function renderMealCalendar(){const year=currentCalendarDate.getFullYear(),month=currentCalendarDate.getMonth();document.getElementById('mealCalendarTitle').textContent=`${year}ÎÖÑ ${month+1}Ïõî`;const firstDay=new Date(year,month,1).getDay(),daysInMonth=new Date(year,month+1,0).getDate(),today=new Date();let mealScores={};try{const response=await fetch(`/api/meal/calendar/${year}/${month+1}`);const data=await response.json();if(data.dailyStats){data.dailyStats.forEach(stat=>{const day=new Date(stat.date).getDate();mealScores[day]=stat.averageScore})}}catch(error){console.error('ÏãùÎã® Îã¨Î†• Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:',error)}let html='';['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'].forEach(day=>html+=`<div class="calendar-day-header">${day}</div>`);for(let i=0;i<firstDay;i++)html+='<div></div>';for(let day=1;day<=daysInMonth;day++){const date=new Date(year,month,day);const score=mealScores[day];let scoreHtml='';if(score){const color=getScoreColor(score);scoreHtml=`<div class="calendar-score" style="color:${color}">${score}Ï†ê</div>`}html+=`<div class="calendar-day ${date.toDateString()===today.toDateString()?'today':''}" onclick="selectMealDate('${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}')"><div class="calendar-day-content">${day}${scoreHtml}</div></div>`}document.getElementById('mealCalendarGrid').innerHTML=html}
function getScoreColor(score){if(score>=80)return'#10b981';if(score>=60)return'#3b82f6';if(score>=40)return'#f59e0b';if(score>=20)return'#ef4444';return'#991b1b'}
function updateMealDisplay(meals,stats){meals.forEach(meal=>{const mealType=meal.mealType.toLowerCase();const mealElement=document.getElementById(mealType+'Meal');const evalElement=document.getElementById(mealType+'Evaluation');if(mealElement&&meal.imageUrl){mealElement.classList.add('has-image');mealElement.innerHTML=`<img src="${meal.imageUrl}" alt="${meal.mealType}" onclick="showImageModal('${meal.imageUrl}')">`}if(evalElement&&meal.aiEvaluation){const color=getScoreColor(meal.score||0);evalElement.style.display='block';const mealTypeName=meal.mealType==='BREAKFAST'?'ÏïÑÏπ®':meal.mealType==='LUNCH'?'Ï†êÏã¨':'Ï†ÄÎÖÅ';evalElement.innerHTML=`<div style="padding:12px;background:${color}15;border-left:4px solid ${color};border-radius:8px"><div style="font-weight:700;color:${color};font-size:16px;margin-bottom:4px">Ï†êÏàò: ${meal.score||0}Ï†ê</div><div style="font-weight:600;font-size:14px;margin-bottom:8px;color:var(--text-primary)">${mealTypeName} ÏãùÎã®</div><div style="font-size:13px;line-height:1.7;white-space:pre-wrap;color:var(--text-secondary)">${escapeHtml(meal.aiEvaluation)}</div></div>`}});if(stats&&stats.averageScore>0){const avgElement=document.getElementById('dailyAverageScore');const avgColor=getScoreColor(stats.averageScore);avgElement.style.display='block';avgElement.style.background=`${avgColor}15`;avgElement.style.color=avgColor;avgElement.style.border=`2px solid ${avgColor}`;avgElement.textContent=`ÌèâÍ∑† ${stats.averageScore}Ï†ê ${stats.emoji}`}}
async function initializeMealStatus(){try{const today=new Date().toISOString().split('T')[0];const response=await fetch(`/api/meal/date/${today}`);const data=await response.json();if(data.success){updateMealDisplay(data.meals||[],data.stats)}}catch(error){console.error('ÏãùÎã® Ï°∞Ìöå Ïã§Ìå®:',error)}}
function uploadMeal(mealType){currentMealType=mealType;document.getElementById('mealImageInput').click()}
async function handleMealImageUpload(){const input=document.getElementById('mealImageInput'),file=input.files[0];if(!file)return;const mealId=currentMealType.toLowerCase()+'Meal';const mealItem=document.getElementById(mealId);const originalHTML=mealItem.innerHTML;mealItem.innerHTML='<div class="loading-spinner"></div><div style="margin-top:8px;font-size:12px">ÏóÖÎ°úÎìú Ï§ë...</div>';const formData=new FormData();formData.append('image',file);formData.append('mealType',currentMealType);formData.append('date',new Date().toISOString().split('T')[0]);try{const response=await fetch('/api/meal/upload',{method:'POST',body:formData});if(response.ok){const result=await response.json();showToast('ÏãùÎã®Ïù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.','success');await initializeMealStatus()}else{const errorData=await response.json();showToast(errorData.error||'ÏãùÎã® ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error');mealItem.innerHTML=originalHTML}}catch(error){console.error('ÏãùÎã® ÏóÖÎ°úÎìú Ïã§Ìå®:',error);showToast('ÏãùÎã® ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error');mealItem.innerHTML=originalHTML}input.value=''}
function showProfileSettings(){document.getElementById('profileSettingsModal').classList.add('active')}
function showPasswordSettings(){document.getElementById('passwordSettingsModal').classList.add('active')}
async function updateProfile(){const displayName=document.getElementById('displayNameInput').value.trim(),file=document.getElementById('profileImageInput').files[0],formData=new FormData();if(displayName)formData.append('displayName',displayName);if(file)formData.append('profileImage',file);try{const response=await fetch('/api/profile/update',{method:'POST',body:formData});if(response.ok){showToast('ÌîÑÎ°úÌïÑÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.','success');closeModal('profileSettingsModal');setTimeout(()=>location.reload(),1e3)}else throw new Error('ÌîÑÎ°úÌïÑ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®')}catch(error){console.error('ÌîÑÎ°úÌïÑ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:',error);showToast('ÌîÑÎ°úÌïÑ ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function updatePassword(){const currentPassword=document.getElementById('currentPassword').value,newPassword=document.getElementById('newPassword').value,confirmPassword=document.getElementById('confirmPassword').value;if(!currentPassword||!newPassword||!confirmPassword){showToast('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.','error');return}if(newPassword!==confirmPassword){showToast('ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.','error');return}try{const response=await fetch('/api/profile/password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({currentPassword,newPassword})});if(response.ok){showToast('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.','success');closeModal('passwordSettingsModal');document.getElementById('currentPassword').value='';document.getElementById('newPassword').value='';document.getElementById('confirmPassword').value=''}else throw new Error('ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Ïã§Ìå®')}catch(error){console.error('ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Ïã§Ìå®:',error);showToast('ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function checkPushNotificationStatus(){}
async function togglePushNotification(){const isEnabled=document.getElementById('pushNotificationSwitch').checked;showToast(isEnabled?'Push ÏïåÎ¶ºÏù¥ ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.':'Push ÏïåÎ¶ºÏù¥ ÎπÑÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.','success')}
function logout(){if(confirm('Î°úÍ∑∏ÏïÑÏõÉÌïòÏãúÍ≤†ÏäµÎãàÍπå?'))location.href='/logout'}
function showProfileModal(imageUrl,displayName){if(!imageUrl){showToast('ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.','info');return}document.getElementById('profileModalTitle').textContent=displayName||'ÌîÑÎ°úÌïÑ';document.getElementById('profileModalImage').src=imageUrl;document.getElementById('profileModal').classList.add('active')}
function showProfileModalFromData(element){const imageUrl=element.getAttribute('data-profile-image');const displayName=element.getAttribute('data-display-name');showProfileModal(imageUrl,displayName)}
function closeProfileModal(){document.getElementById('profileModal').classList.remove('active')}
function openModal(modalId){document.getElementById(modalId).classList.add('active')}
function closeModal(modalId){document.getElementById(modalId).classList.remove('active')}
function showToast(message,type='info'){const container=document.getElementById('toastContainer'),toast=document.createElement('div');toast.className=`toast ${type}`;toast.innerHTML=`<i class="bi bi-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i><span style="margin-left:8px">${message}</span>`;container.appendChild(toast);setTimeout(()=>toast.remove(),3e3)}
function formatTimeAgo(date){const seconds=Math.floor((new Date()-date)/1e3);if(seconds<60)return'Î∞©Í∏à Ï†Ñ';if(seconds<3600)return`${Math.floor(seconds/60)}Î∂Ñ Ï†Ñ`;if(seconds<86400)return`${Math.floor(seconds/3600)}ÏãúÍ∞Ñ Ï†Ñ`;if(seconds<604800)return`${Math.floor(seconds/86400)}Ïùº Ï†Ñ`;return date.toLocaleDateString('ko-KR')}
function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML}
function hasRecentProfileUpdate(user){if(!user||!user.profileImageUpdatedAt)return false;const updateTime=new Date(user.profileImageUpdatedAt);const now=new Date();const daysDiff=(now-updateTime)/(1000*60*60*24);return daysDiff<=3}
async function loadPointItems(){const sampleItems=[{id:1,name:'Ï†úÏ£º ÏΩòÎèÑ 1Î∞ï',description:'ÏïÑÎ¶ÑÎã§Ïö¥ Ï†úÏ£ºÎèÑÏóêÏÑúÏùò ÌûêÎßÅ ÌÉÄÏûÑ! Ïò§ÏÖòÎ∑∞ ÏΩòÎèÑÏóêÏÑú Ìé∏ÏïàÌïú Ìú¥ÏãùÏùÑ Ï¶êÍ∏∞ÏÑ∏Ïöî.',price:5000,imageUrl:'https://via.placeholder.com/300x200/4A90E2/ffffff?text=%EC%A0%9C%EC%A3%BC+%EC%BD%98%EB%8F%84',available:true},{id:2,name:'ÏÑúÏö∏ 5ÏÑ±Í∏â Ìò∏ÌÖî 1Î∞ï',description:'Í∞ïÎÇ® ÌîÑÎ¶¨ÎØ∏ÏóÑ Ìò∏ÌÖî Ïä§ÏúÑÌä∏Î£∏ 1Î∞ï 2Ïùº + Ï°∞Ïãù 2Ïù∏ Ìè¨Ìï®',price:8000,imageUrl:'https://via.placeholder.com/300x200/5cb85c/ffffff?text=%ED%98%B8%ED%85%94+%EC%88%99%EB%B0%95',available:true},{id:3,name:'Í≥†Í∏â Î†àÏä§ÌÜ†Îûë ÎîîÎÑà 2Ïù∏',description:'ÎØ∏ÏäêÎû≠ Í∞ÄÏù¥Îìú ÏÑ†Ï†ï Î†àÏä§ÌÜ†Îûë ÎîîÎÑà ÏΩîÏä§ (2Ïù∏)',price:3000,imageUrl:'https://via.placeholder.com/300x200/f0ad4e/ffffff?text=%EB%94%94%EB%84%88+%EC%BD%94%EC%8A%A4',available:true},{id:4,name:'Î∂ÄÏÇ∞ Ìï¥Ïö¥ÎåÄ ÏΩòÎèÑ 2Î∞ï',description:'Î∂ÄÏÇ∞ Ìï¥Ïö¥ÎåÄ Ïò§ÏÖòÎ∑∞ ÏΩòÎèÑ 2Î∞ï 3Ïùº + ÏõåÌÑ∞ÌååÌÅ¨ Ïù¥Ïö©Í∂å',price:6500,imageUrl:'https://via.placeholder.com/300x200/5bc0de/ffffff?text=%EB%B6%80%EC%82%B0+%EC%BD%98%EB%8F%84',available:true},{id:5,name:'ÌïúÏ†ïÏãù ÌäπÏÑ† Î©îÎâ¥ (4Ïù∏)',description:'Ï†ÑÌÜµ ÌïúÏ†ïÏãù ÌäπÏÑ† ÏΩîÏä§ÏöîÎ¶¨ 4Ïù∏Î∂Ñ',price:2500,imageUrl:'https://via.placeholder.com/300x200/d9534f/ffffff?text=%ED%95%9C%EC%A0%95%EC%8B%9D',available:true},{id:6,name:'Ïä§Ìåå & ÎßàÏÇ¨ÏßÄ Ìå®ÌÇ§ÏßÄ',description:'ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä§Ìåå + Ï†ÑÏã† ÎßàÏÇ¨ÏßÄ 90Î∂Ñ ÏΩîÏä§',price:1800,imageUrl:'https://via.placeholder.com/300x200/9b59b6/ffffff?text=%EC%8A%A4%ED%8C%8C',available:true}];try{const response=await fetch('/api/points/items');const items=await response.json();renderPointItems(items)}catch(error){console.log('API Ïã§Ìå®, ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÌëúÏãú');renderPointItems(sampleItems)}}
function renderPointItems(items){const grid=document.getElementById('pointItemsGrid');const userRole='[[${user.role.name()}]]';const isFather=userRole==='FATHER';if(!items||items.length===0){grid.innerHTML='<div class="empty-state"><div class="empty-state-icon"><i class="bi bi-shop"></i></div><div class="empty-state-title">Îì±Î°ùÎêú ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§</div></div>';return}grid.innerHTML=items.map(item=>{const canPurchase=isFather&&item.available&&parseInt(document.getElementById('currentPoints').textContent)>=item.points;return`<div class="point-item-card ${canPurchase?'':'disabled'}" onclick="${canPurchase?`purchaseItem(${item.id})`:''}"><div class="point-item-icon-wrapper" style="background:${item.color||'#e5e7eb'}">${item.icon?`<i class="bi bi-${item.icon}"></i>`:'üéÅ'}</div><div class="point-item-name">${item.name}</div><div class="point-item-desc">${item.description||''}</div><div class="point-item-price"><span class="point-item-price-value">${item.points}</span><span class="point-item-price-unit">pt</span>${!isFather?'<span style="font-size:12px;color:var(--danger);margin-left:auto">ÏïÑÎ≤ÑÏßÄÎßå Íµ¨Îß§ Í∞ÄÎä•</span>':''}</div></div>`}).join('')}
async function purchaseItem(itemId){if(!confirm('Ïù¥ ÏÉÅÌíàÏùÑ Íµ¨Îß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?'))return;try{const response=await fetch(`/api/points/purchase/${itemId}`,{method:'POST'});if(response.ok){const result=await response.json();document.getElementById('currentPoints').textContent=result.remainingPoints;document.getElementById('userPoints').textContent=result.remainingPoints;showToast('ÏÉÅÌíàÏùÑ Íµ¨Îß§ÌñàÏäµÎãàÎã§!','success');await loadPointItems()}else{const error=await response.json();showToast(error.message||'Íµ¨Îß§Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}catch(error){console.error('ÏÉÅÌíà Íµ¨Îß§ Ïã§Ìå®:',error);showToast('ÏÉÅÌíà Íµ¨Îß§Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function calculateExpectedPoints(){try{const today=new Date().toISOString().split('T')[0];const [medicineRes,mealRes]=await Promise.all([fetch(`/api/medicine/today`),fetch(`/api/meals/date/${today}`)]);const medicineRecords=await medicineRes.json();const meals=await mealRes.json();let medicinePoints=0;if(medicineRecords.morning&&medicineRecords.morning.taken)medicinePoints+=10;if(medicineRecords.evening&&medicineRecords.evening.taken)medicinePoints+=10;let mealPoints=0;if(meals&&meals.length>0){const avgScore=meals.reduce((sum,m)=>sum+(m.score||0),0)/meals.length;if(avgScore>=80)mealPoints=70;else if(avgScore>=60)mealPoints=50;else if(avgScore>=40)mealPoints=30;else mealPoints=20}const totalExpected=medicinePoints+mealPoints;const expectedEl=document.getElementById('healthExpectedPointsValue');if(expectedEl)expectedEl.textContent=`${totalExpected} (ÏïΩ: ${medicinePoints}p + ÏãùÎã®: ${mealPoints}p)`}catch(error){console.error('ÏòàÏÉÅ Ìè¨Ïù∏Ìä∏ Í≥ÑÏÇ∞ Ïã§Ìå®:',error);const expectedEl=document.getElementById('healthExpectedPointsValue');if(expectedEl)expectedEl.textContent='Í≥ÑÏÇ∞ Ïã§Ìå®'}}
async function initializeHomeMeals(){try{const today=new Date().toISOString().split('T')[0];const response=await fetch(`/api/meal/date/${today}`);const data=await response.json();if(data.success&&data.meals){data.meals.forEach(meal=>{const mealType=meal.mealType.toLowerCase();const element=document.getElementById(`home${mealType.charAt(0).toUpperCase()+mealType.slice(1)}Meal`);if(element&&meal.imageUrl){element.classList.add('has-image');element.innerHTML=`<img src="${meal.imageUrl}" alt="${meal.mealType}" onclick="showImageModal('${meal.imageUrl}')">`;if(meal.aiEvaluation){element.innerHTML+=`<button class="ai-eval-btn" onclick="event.stopPropagation();showAiEvaluation('${mealType}','${escapeForAttribute(meal.aiEvaluation)}',${meal.score||0})"><i class="bi bi-stars"></i> AIÌèâÍ∞Ä</button>`}}currentMealData[mealType]=meal})}}catch(error){console.error('Ìôà ÏãùÎã® Î°úÎìú Ïã§Ìå®:',error)}}
function escapeForAttribute(text){return text.replace(/'/g,'&apos;').replace(/"/g,'&quot;').replace(/\n/g,' ')}
function showImageModal(imageUrl){document.getElementById('imageModalImage').src=imageUrl;document.getElementById('imageModal').classList.add('active')}
function showAiEvaluation(mealType,evaluation,score){const titles={breakfast:'ÏïÑÏπ® ÏãùÎã®',lunch:'Ï†êÏã¨ ÏãùÎã®',dinner:'Ï†ÄÎÖÅ ÏãùÎã®'};document.getElementById('aiEvalModalTitle').textContent=titles[mealType]+' AI ÌèâÍ∞Ä';const color=getScoreColor(score);document.getElementById('aiEvalModalContent').innerHTML=`<div style="padding:16px;background:${color}15;border-left:4px solid ${color};border-radius:8px;margin-bottom:16px"><div style="font-weight:700;color:${color};font-size:24px;margin-bottom:8px">${score}Ï†ê</div></div><div style="line-height:1.8;white-space:pre-wrap">${evaluation}</div>`;document.getElementById('aiEvaluationModal').classList.add('active')}
async function initializeFirebase(){try{const firebaseConfig={apiKey:"AIzaSyC4oP4zGjT1W5gVsWu0kyOoHVpbieOtVpM",authDomain:"mdedicine.firebaseapp.com",projectId:"mdedicine",storageBucket:"mdedicine.firebasestorage.app",messagingSenderId:"659585584078",appId:"1:659585584078:web:bf9f90d5a2fdcd42f5b99f",measurementId:"G-GETB4S7XM4"};firebase.initializeApp(firebaseConfig);messaging=firebase.messaging();console.log('‚úÖ Firebase initialized');await requestNotificationPermission()}catch(error){console.error('‚ùå Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå®:',error)}}
async function requestNotificationPermission(){try{const permission=await Notification.requestPermission();if(permission==='granted'){console.log('‚úÖ ÏïåÎ¶º Í∂åÌïú ÌóàÏö©Îê®');await registerFcmToken()}else{console.log('‚ö†Ô∏è ÏïåÎ¶º Í∂åÌïú Í±∞Î∂ÄÎê®')}}catch(error){console.error('‚ùå ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠ Ïã§Ìå®:',error)}}
async function registerFcmToken(){try{const VAPID_KEY='BFkmMV5OmNvF6_j5hblhJD9L-y3v3BDaUWcbXr-y0fJrMOi4gGPD1jA4SkBVk4LWqaJvV8gB2qHY5VZL3gW-GyY';if('serviceWorker' in navigator){await navigator.serviceWorker.register('/firebase-messaging-sw.js');console.log('‚úÖ Service Worker Îì±Î°ù ÏôÑÎ£å')}const fcmToken=await messaging.getToken({vapidKey:VAPID_KEY});if(!fcmToken){console.error('‚ùå FCM ÌÜ†ÌÅ∞ ÏÉùÏÑ± Ïã§Ìå®');return}currentFcmToken=fcmToken;console.log('‚úÖ FCM Token:',fcmToken.substring(0,50)+'...');const response=await fetch('/api/push/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:fcmToken})});if(response.ok){console.log('‚úÖ FCM ÌÜ†ÌÅ∞ ÏÑúÎ≤Ñ Îì±Î°ù ÏôÑÎ£å')}else{console.error('‚ùå FCM ÌÜ†ÌÅ∞ ÏÑúÎ≤Ñ Îì±Î°ù Ïã§Ìå®')}messaging.onMessage((payload)=>{console.log('üì® Ìè¨Í∑∏ÎùºÏö¥Îìú Î©îÏãúÏßÄ ÏàòÏã†:',payload);const title=payload.data?.title||payload.notification?.title||'ÏïåÎ¶º';const body=payload.data?.body||payload.notification?.body||'';showToast(body,'info')})}catch(error){console.error('‚ùå FCM ÌÜ†ÌÅ∞ Îì±Î°ù Ïã§Ìå®:',error)}}
let stompClient=null;
function initializeWebSocket(){try{const socket=new SockJS('/ws');stompClient=Stomp.over(socket);stompClient.connect({},function(frame){console.log('‚úÖ WebSocket Ïó∞Í≤∞ ÏÑ±Í≥µ:',frame);stompClient.subscribe('/topic/activities',function(message){const data=JSON.parse(message.body);console.log('üì® ÌôúÎèô ÏïåÎ¶º ÏàòÏã†:',data);handleActivityMessage(data)});stompClient.subscribe('/topic/dailies',function(message){const data=JSON.parse(message.body);console.log('üì® ÏùºÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏ ÏàòÏã†:',data);handleDailyMessage(data)});stompClient.subscribe('/topic/wishes',function(message){const data=JSON.parse(message.body);console.log('üì® ÏúÑÏãú ÏóÖÎç∞Ïù¥Ìä∏ ÏàòÏã†:',data);handleWishMessage(data)})},function(error){console.error('‚ùå WebSocket Ïó∞Í≤∞ Ïã§Ìå®:',error);setTimeout(initializeWebSocket,5000)})}catch(error){console.error('‚ùå WebSocket Ï¥àÍ∏∞Ìôî Ïã§Ìå®:',error)}}
function handleActivityMessage(message){if(message.type==='ACTIVITY'&&message.action==='CREATE'){loadActivities();showToast('ÏÉàÎ°úÏö¥ ÌôúÎèôÏù¥ ÏûàÏäµÎãàÎã§!','info')}}
function handleDailyMessage(message){if(currentTab==='dailyTab'){if(message.action==='CREATE'){loadDailies();showToast('ÏÉà Í≤åÏãúÎ¨ºÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.','info')}else if(message.action==='UPDATE'){loadDailies()}else if(message.action==='DELETE'){loadDailies();showToast('Í≤åÏãúÎ¨ºÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.','info')}}loadHomeRecentDailies()}
function handleWishMessage(message){if(currentTab==='wishTab'){if(message.action==='CREATE'){loadWishes();showToast('ÏÉà ÏúÑÏãúÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.','info')}else if(message.action==='UPDATE'){loadWishes()}else if(message.action==='DELETE'){loadWishes();showToast('ÏúÑÏãúÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.','info')}}}
async function showPointItemManagement(){document.getElementById('pointItemManagementModal').classList.add('active');await loadAdminItems()}
async function loadAdminItems(){try{const response=await fetch('/api/points/admin/items');if(!response.ok){showToast('ÏÉÅÌíà Î™©Î°ù Î°úÎìú Ïã§Ìå®','error');return}const items=await response.json();const container=document.getElementById('adminItemsList');if(!items||items.length===0){container.innerHTML='<div class="empty-state"><p>Îì±Î°ùÎêú ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.</p></div>';return}container.innerHTML=items.map(item=>`<div style="background:white;border:1px solid var(--gray-300);border-radius:12px;padding:16px"><div style="display:flex;justify-content:space-between;align-items:start"><div style="flex:1"><h6 style="font-weight:700;margin-bottom:4px">${item.name}</h6><p style="font-size:14px;color:var(--gray-600);margin-bottom:8px">${item.description||''}</p><div style="display:flex;gap:12px;font-size:14px"><span><i class="bi bi-coin"></i> ${item.points}pt</span><span style="color:${item.available?'var(--success)':'var(--danger)}'}">${item.available?'ÌåêÎß§Ï§ë':'ÌåêÎß§Ï§ëÏßÄ'}</span></div></div><div style="display:flex;gap:8px"><button class="comment-submit-btn" style="padding:8px 12px;background:var(--danger)" onclick="deleteAdminItem(${item.id})"><i class="bi bi-trash"></i></button></div></div>${item.imageUrl?`<img src="${item.imageUrl}" style="width:100%;max-height:200px;object-fit:cover;border-radius:8px;margin-top:12px">`:''}  </div>`).join('')}catch(error){console.error('ÏÉÅÌíà Î™©Î°ù Î°úÎìú Ïã§Ìå®:',error);showToast('ÏÉÅÌíà Î™©Î°ù Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function submitPointItem(event){event.preventDefault();const formData=new FormData();formData.append('name',document.getElementById('itemName').value);formData.append('description',document.getElementById('itemDescription').value);formData.append('points',document.getElementById('itemPoints').value);const icon=document.getElementById('itemIcon').value;const color=document.getElementById('itemColor').value;if(icon)formData.append('icon',icon);if(color)formData.append('color',color);const imageFile=document.getElementById('itemImage').files[0];if(imageFile)formData.append('image',imageFile);try{const response=await fetch('/api/points/admin/items',{method:'POST',body:formData});if(response.ok){showToast('ÏÉÅÌíàÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.','success');document.getElementById('pointItemForm').reset();await loadAdminItems()}else{const error=await response.json();showToast(error.error||'ÏÉÅÌíà Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}catch(error){console.error('ÏÉÅÌíà Îì±Î°ù Ïã§Ìå®:',error);showToast('ÏÉÅÌíà Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function deleteAdminItem(itemId){if(!confirm('Ïù¥ ÏÉÅÌíàÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?'))return;try{const response=await fetch(`/api/points/admin/items/${itemId}`,{method:'DELETE'});if(response.ok){showToast('ÏÉÅÌíàÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.','success');await loadAdminItems();await loadPointItems()}else{const error=await response.json();showToast(error.error||'ÏÉÅÌíà ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}catch(error){console.error('ÏÉÅÌíà ÏÇ≠Ï†ú Ïã§Ìå®:',error);showToast('ÏÉÅÌíà ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
function showPointShop(){document.getElementById('pointShopModal').classList.add('active');loadPointItemsToModal()}
function loadPointShop(){loadPointItemsToModal()}
async function loadPointItemsToModal(){try{const response=await fetch('/api/points/items');const items=await response.json();renderPointItemsInModal(items)}catch(error){console.error('Ìè¨Ïù∏Ìä∏ ÏÉÅÌíà Î°úÎìú Ïã§Ìå®:',error);showToast('ÏÉÅÌíàÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
function renderPointItemsInModal(items){const grid=document.getElementById('modalPointItemsGrid');const userRole='[[${user.role.name()}]]';const isFather=userRole==='FATHER';if(!items||items.length===0){grid.innerHTML='<div class="empty-state"><div class="empty-state-icon"><i class="bi bi-shop"></i></div><div class="empty-state-title">Îì±Î°ùÎêú ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§</div></div>';return}grid.innerHTML=items.map(item=>{const canPurchase=isFather&&item.available&&parseInt(document.getElementById('userPoints').textContent)>=item.points;const imageHtml=item.imageUrl?`<img src="${item.imageUrl}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;margin-bottom:12px">`:`<div class="point-item-icon-wrapper" style="background:${item.color||'#e5e7eb'};width:100%;height:80px;margin-bottom:12px">${item.icon?`<i class="bi bi-${item.icon}"></i>`:'üéÅ'}</div>`;return`<div class="point-item-card ${canPurchase?'':'disabled'}" onclick="${canPurchase?`purchaseItemFromModal(${item.id})`:''}"><div style="display:flex;flex-direction:column;gap:8px">${imageHtml}<div class="point-item-name" style="font-size:14px">${item.name}</div><div class="point-item-desc" style="font-size:12px;min-height:auto;line-height:1.4">${item.description||''}</div><div class="point-item-price" style="padding-top:8px"><span class="point-item-price-value" style="font-size:20px">${item.points}</span><span class="point-item-price-unit">pt</span>${!isFather?'<span style="font-size:12px;color:var(--danger);margin-left:auto">ÏïÑÎ≤ÑÏßÄÎßå Íµ¨Îß§ Í∞ÄÎä•</span>':''}</div></div></div>`}).join('')}
async function purchaseItemFromModal(itemId){if(!confirm('Ïù¥ ÏÉÅÌíàÏùÑ Íµ¨Îß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?'))return;try{const response=await fetch(`/api/points/purchase/${itemId}`,{method:'POST'});if(response.ok){const result=await response.json();document.getElementById('modalCurrentPoints').textContent=result.remainingPoints;document.getElementById('userPoints').textContent=result.remainingPoints;showToast('ÏÉÅÌíàÏùÑ Íµ¨Îß§ÌñàÏäµÎãàÎã§!','success');await loadPointItemsToModal()}else{const error=await response.json();showToast(error.message||'Íµ¨Îß§Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}catch(error){console.error('ÏÉÅÌíà Íµ¨Îß§ Ïã§Ìå®:',error);showToast('ÏÉÅÌíà Íµ¨Îß§Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
function handleDailyMediaSelect(event){const files=event.target.files;if(!files||files.length===0)return;const preview=document.getElementById('dailyMediaPreview');preview.innerHTML='';preview.style.display='grid';Array.from(files).forEach((file,index)=>{const fileType=file.type.startsWith('image')?'image':'video';const reader=new FileReader();reader.onload=function(e){const wrapper=document.createElement('div');wrapper.style.position='relative';wrapper.style.borderRadius='8px';wrapper.style.overflow='hidden';if(fileType==='image'){wrapper.innerHTML=`<img src="${e.target.result}" style="width:100%;height:120px;object-fit:cover">`}else{wrapper.innerHTML=`<video src="${e.target.result}" style="width:100%;height:120px;object-fit:cover"></video>`}preview.appendChild(wrapper)};reader.readAsDataURL(file)})}
function handleWishImageSelect(event){const file=event.target.files[0];if(!file)return;const preview=document.getElementById('wishImagePreview');const reader=new FileReader();reader.onload=function(e){preview.innerHTML=`<img src="${e.target.result}" style="width:100%;max-height:300px;object-fit:cover;border-radius:12px">`;preview.style.display='block'};reader.readAsDataURL(file)}
function showDailyPostModal(){document.getElementById('dailyPostModal').classList.add('active')}
let isSubmittingDaily=false;async function submitDailyPost(event){event.preventDefault();if(isSubmittingDaily){showToast('Í≤åÏãúÎ¨ºÏùÑ ÏûëÏÑ± Ï§ëÏûÖÎãàÎã§. Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.','info');return}const content=document.getElementById('dailyContent').value.trim();const mediaFiles=document.getElementById('dailyMedia').files;if(!content){showToast('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.','error');return}const formData=new FormData();formData.append('content',content);if(mediaFiles&&mediaFiles.length>0){if(mediaFiles.length===1){formData.append('media',mediaFiles[0])}else{showToast('ÌòÑÏû¨Îäî 1Í∞úÏùò ÌååÏùºÎßå ÏóÖÎ°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§. Ï≤´ Î≤àÏß∏ ÌååÏùºÎßå ÏóÖÎ°úÎìúÎê©ÎãàÎã§.','info');formData.append('media',mediaFiles[0])}}isSubmittingDaily=true;try{const response=await fetch('/api/daily',{method:'POST',body:formData});if(response.ok){showToast('Í≤åÏãúÎ¨ºÏù¥ ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§.','success');closeModal('dailyPostModal');document.getElementById('dailyPostForm').reset();document.getElementById('dailyMediaPreview').innerHTML='';document.getElementById('dailyMediaPreview').style.display='none';await loadDailies()}else throw new Error('Í≤åÏãúÎ¨º ÏûëÏÑ± Ïã§Ìå®')}catch(error){console.error('Í≤åÏãúÎ¨º ÏûëÏÑ± Ïã§Ìå®:',error);showToast('Í≤åÏãúÎ¨º ÏûëÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}finally{isSubmittingDaily=false}}
let allDailies=[];let dailyPage=1;const dailyPageSize=5;
async function loadDailies(){try{const response=await fetch('/api/daily');const dailies=await response.json();allDailies=dailies;dailyPage=1;renderDailies()}catch(error){console.error('ÏùºÏÉÅ Î°úÎìú Ïã§Ìå®:',error);showToast('ÏùºÏÉÅÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
function renderDailies(){const grid=document.getElementById('dailyPostsGrid');const start=0;const end=dailyPage*dailyPageSize;const dailies=allDailies.slice(start,end);if(!dailies||dailies.length===0){grid.innerHTML='<div class="empty-state"><div class="empty-state-icon"><i class="bi bi-images"></i></div><div class="empty-state-title">ÏïÑÏßÅ Í≤åÏãúÎ¨ºÏù¥ ÏóÜÏäµÎãàÎã§</div><div class="empty-state-text">Ï≤´ Î≤àÏß∏ ÏùºÏÉÅÏùÑ Í≥µÏú†Ìï¥Î≥¥ÏÑ∏Ïöî!</div></div>';return}let html=dailies.map(daily=>{const rainbowClass=hasRecentProfileUpdate(daily.user)?'rainbow-border':'';const newBadge=daily.isNew?'<span style="display:inline-block;background:#10b981;color:white;font-size:10px;padding:2px 6px;border-radius:4px;margin-left:6px;font-weight:600">NEW</span>':'';let mediaHtml='';if(daily.images&&daily.images.length>0){if(daily.images.length===1){const img=daily.images[0];mediaHtml=img.mediaType==='VIDEO'?`<video controls class="comment-image" style="max-height:500px"><source src="${img.imageUrl}">Your browser does not support the video tag.</video>`:`<img class="comment-image" src="${img.imageUrl}" onclick="showImageModal('${img.imageUrl}')" style="cursor:pointer">`}else{mediaHtml=`<div class="image-slider" id="slider-${daily.id}"><div class="slider-container" id="slider-container-${daily.id}">${daily.images.map((img,idx)=>img.mediaType==='VIDEO'?`<div class="slider-item"><video controls style="max-height:500px;width:100%"><source src="${img.imageUrl}">Your browser does not support the video tag.</video></div>`:`<div class="slider-item"><img src="${img.imageUrl}" onclick="showImageModal('${img.imageUrl}')" style="cursor:pointer"></div>`).join('')}</div>${daily.images.length>1?`<button class="slider-btn prev" onclick="moveSlider(${daily.id},-1)"><i class="bi bi-chevron-left"></i></button><button class="slider-btn next" onclick="moveSlider(${daily.id},1)"><i class="bi bi-chevron-right"></i></button><div class="slider-indicators">${daily.images.map((img,idx)=>`<div class="slider-indicator ${idx===0?'active':''}" onclick="goToSlide(${daily.id},${idx})"></div>`).join('')}</div>`:''}</div>`;sliderStates[daily.id]={current:0,total:daily.images.length}}}else if(daily.mediaUrl){mediaHtml=daily.mediaType==='VIDEO'?`<video controls class="comment-image" style="max-height:500px"><source src="${daily.mediaUrl}">Your browser does not support the video tag.</video>`:`<img class="comment-image" src="${daily.mediaUrl}" onclick="showImageModal('${daily.mediaUrl}')" style="cursor:pointer">`}return`<div class="comment-item" style="padding:20px"><div class="comment-header"><div class="comment-avatar ${rainbowClass}" onclick="showProfileModal('${daily.user.profileImage}','${daily.user.displayName}')">${daily.user.profileImage?`<img src="${daily.user.profileImage}" alt="${daily.user.displayName}">`:daily.user.displayName.substring(0,1)}</div><div class="comment-user-info"><div class="comment-username">${daily.user.displayName}${newBadge}</div><div class="comment-time">${formatTimeAgo(new Date(daily.createdAt))}</div></div>${daily.user.id==currentUserId?`<button class="comment-delete-btn" onclick="deleteDaily(${daily.id})"><i class="bi bi-trash"></i></button>`:''}</div><div class="comment-content" style="margin-bottom:${mediaHtml?'16px':'12px'}">${escapeHtml(daily.content)}</div>${mediaHtml}<div class="comment-actions"><button class="comment-action-btn ${daily.isLiked?'liked':''}" onclick="toggleDailyLike(${daily.id})"><i class="bi bi-heart-fill"></i><span>${daily.likesCount||0}</span></button><button class="comment-action-btn" onclick="showDailyComments(${daily.id})"><i class="bi bi-chat-fill"></i> <span>${daily.commentsCount||0}</span></button></div><div id="dailyComments-${daily.id}" style="display:none;margin-top:16px;padding-top:16px;border-top:1px solid var(--gray-200)"></div></div>`}).join('');if(end<allDailies.length){html+=`<button onclick="loadMoreDailies()" class="comment-submit-btn" style="width:100%;margin-top:12px"><i class="bi bi-arrow-down-circle"></i> Îçî Î≥¥Í∏∞ (${allDailies.length-end}Í∞ú ÎÇ®Ïùå)</button>`}grid.innerHTML=html}
let sliderStates={};function moveSlider(dailyId,direction){const state=sliderStates[dailyId];if(!state)return;state.current+=direction;if(state.current<0)state.current=state.total-1;if(state.current>=state.total)state.current=0;updateSlider(dailyId)}
function goToSlide(dailyId,index){const state=sliderStates[dailyId];if(!state)return;state.current=index;updateSlider(dailyId)}
function updateSlider(dailyId){const state=sliderStates[dailyId];const container=document.getElementById(`slider-container-${dailyId}`);const indicators=document.querySelectorAll(`#slider-${dailyId} .slider-indicator`);if(container){container.style.transform=`translateX(-${state.current*100}%)`}indicators.forEach((ind,idx)=>{ind.classList.toggle('active',idx===state.current)})}
function loadMoreDailies(){dailyPage++;renderDailies()}
function toggleDailySearch(){const panel=document.getElementById('dailySearchPanel');panel.style.display=panel.style.display==='none'?'block':'none';const select=document.getElementById('dailySearchType');select.addEventListener('change',function(){const contentDiv=document.getElementById('dailySearchContent');const dateDiv=document.getElementById('dailySearchDate');if(this.value==='content'){contentDiv.style.display='block';dateDiv.style.display='none'}else{contentDiv.style.display='none';dateDiv.style.display='block'}})}
async function searchDailyPosts(){const type=document.getElementById('dailySearchType').value;if(type==='content'){const query=document.getElementById('dailySearchInput').value.trim();if(!query){showToast('Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî','error');return}allDailies=allDailies.filter(d=>d.content.includes(query));dailyPage=1;renderDailies();showToast(`${allDailies.length}Í∞úÏùò Í≤åÏãúÎ¨ºÏùÑ Ï∞æÏïòÏäµÎãàÎã§`,'success')}else{const date=document.getElementById('dailySearchDateInput').value;if(!date){showToast('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî','error');return}allDailies=allDailies.filter(d=>d.createdAt.startsWith(date));dailyPage=1;renderDailies();showToast(`${allDailies.length}Í∞úÏùò Í≤åÏãúÎ¨ºÏùÑ Ï∞æÏïòÏäµÎãàÎã§`,'success')}}
async function toggleDailyLike(dailyId){try{const response=await fetch(`/api/daily/${dailyId}/like`,{method:'POST'});if(response.ok){await loadDailies()}else throw new Error('Ï¢ãÏïÑÏöî Ïã§Ìå®')}catch(error){console.error('Ï¢ãÏïÑÏöî Ïã§Ìå®:',error);showToast('Ï¢ãÏïÑÏöîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function deleteDaily(dailyId){if(!confirm('Í≤åÏãúÎ¨ºÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?'))return;try{const response=await fetch(`/api/daily/${dailyId}`,{method:'DELETE'});if(response.ok){showToast('Í≤åÏãúÎ¨ºÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.','success');await loadDailies()}else throw new Error('ÏÇ≠Ï†ú Ïã§Ìå®')}catch(error){console.error('ÏÇ≠Ï†ú Ïã§Ìå®:',error);showToast('Í≤åÏãúÎ¨º ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function showDailyComments(dailyId){const commentsDiv=document.getElementById(`dailyComments-${dailyId}`);if(commentsDiv.style.display==='none'){try{const response=await fetch(`/api/daily/${dailyId}/comments`);const comments=await response.json();renderDailyComments(dailyId,comments);commentsDiv.style.display='block'}catch(error){console.error('ÎåìÍ∏Ä Î°úÎìú Ïã§Ìå®:',error);showToast('ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}else{commentsDiv.style.display='none'}}
function renderDailyComments(dailyId,comments){const commentsDiv=document.getElementById(`dailyComments-${dailyId}`);const parentComments=comments.filter(c=>!c.parentCommentId);let html=`<div class="comment-input-row" style="margin-bottom:12px"><input type="text" id="dailyCommentInput-${dailyId}" class="comment-input" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."><button class="comment-submit-btn" onclick="addDailyComment(${dailyId})"><i class="bi bi-send-fill"></i></button></div>`;if(parentComments.length>0){html+='<div style="display:flex;flex-direction:column;gap:12px">';parentComments.forEach(comment=>{const rainbowClass=hasRecentProfileUpdate(comment.user)?'rainbow-border':'';html+=`<div style="background:var(--gray-100);padding:12px;border-radius:8px"><div class="comment-header" style="margin-bottom:8px"><div class="comment-avatar ${rainbowClass}" style="width:32px;height:32px;font-size:14px">${comment.user.profileImage?`<img src="${comment.user.profileImage}" alt="${comment.user.displayName}">`:comment.user.displayName.substring(0,1)}</div><div class="comment-user-info"><div class="comment-username" style="font-size:13px">${comment.user.displayName}</div><div class="comment-time" style="font-size:11px">${formatTimeAgo(new Date(comment.createdAt))}</div></div>${comment.user.id==currentUserId?`<button class="comment-delete-btn" onclick="deleteDailyComment(${comment.id},${dailyId})"><i class="bi bi-trash"></i></button>`:''}</div><div style="font-size:14px;line-height:1.5">${escapeHtml(comment.content)}</div><button class="comment-action-btn" style="font-size:12px;margin-top:8px" onclick="showDailyReplyInput(${comment.id},${dailyId})"><i class="bi bi-reply-fill"></i> ÎãµÍ∏Ä</button><div id="dailyReply-${comment.id}" style="display:none;margin-top:12px"></div>`;const replies=comments.filter(r=>r.parentCommentId===comment.id);if(replies.length>0){replies.forEach(reply=>{const replyRainbowClass=hasRecentProfileUpdate(reply.user)?'rainbow-border':'';html+=`<div style="margin-left:20px;margin-top:8px;padding:8px;background:var(--white);border-radius:6px"><div class="comment-header" style="margin-bottom:6px"><div class="comment-avatar ${replyRainbowClass}" style="width:24px;height:24px;font-size:12px">${reply.user.profileImage?`<img src="${reply.user.profileImage}" alt="${reply.user.displayName}">`:reply.user.displayName.substring(0,1)}</div><div class="comment-user-info"><div class="comment-username" style="font-size:12px">${reply.user.displayName}</div><div class="comment-time" style="font-size:10px">${formatTimeAgo(new Date(reply.createdAt))}</div></div>${reply.user.id==currentUserId?`<button class="comment-delete-btn" onclick="deleteDailyComment(${reply.id},${dailyId})"><i class="bi bi-trash"></i></button>`:''}</div><div style="font-size:13px">${escapeHtml(reply.content)}</div></div>`})}html+='</div>'}); html+='</div>'}commentsDiv.innerHTML=html}
function showDailyReplyInput(commentId,dailyId){const replyDiv=document.getElementById(`dailyReply-${commentId}`);if(replyDiv.style.display==='none'){replyDiv.innerHTML=`<div class="comment-input-row"><input type="text" id="dailyReplyInput-${commentId}" class="comment-input" placeholder="ÎãµÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."><button class="comment-submit-btn" onclick="addDailyComment(${dailyId},${commentId})"><i class="bi bi-send-fill"></i></button><button class="comment-submit-btn" style="background:var(--gray-600)" onclick="document.getElementById('dailyReply-${commentId}').style.display='none'">Ï∑®ÏÜå</button></div>`;replyDiv.style.display='block';document.getElementById(`dailyReplyInput-${commentId}`).focus()}else{replyDiv.style.display='none'}}
async function addDailyComment(dailyId,parentCommentId){const inputId=parentCommentId?`dailyReplyInput-${parentCommentId}`:`dailyCommentInput-${dailyId}`;const input=document.getElementById(inputId);const content=input.value.trim();if(!content){showToast('ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.','error');return}const formData=new FormData();formData.append('content',content);if(parentCommentId)formData.append('parentCommentId',parentCommentId);try{const response=await fetch(`/api/daily/${dailyId}/comments`,{method:'POST',body:formData});if(response.ok){input.value='';if(parentCommentId)document.getElementById(`dailyReply-${parentCommentId}`).style.display='none';showToast('ÎåìÍ∏ÄÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.','success');const commentsResponse=await fetch(`/api/daily/${dailyId}/comments`);const comments=await commentsResponse.json();renderDailyComments(dailyId,comments)}else throw new Error('ÎåìÍ∏Ä Îì±Î°ù Ïã§Ìå®')}catch(error){console.error('ÎåìÍ∏Ä Îì±Î°ù Ïã§Ìå®:',error);showToast('ÎåìÍ∏Ä Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function deleteDailyComment(commentId,dailyId){if(!confirm('ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?'))return;try{const response=await fetch(`/api/daily/comments/${commentId}`,{method:'DELETE'});if(response.ok){showToast('ÎåìÍ∏ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.','success');const commentsResponse=await fetch(`/api/daily/${dailyId}/comments`);const comments=await commentsResponse.json();renderDailyComments(dailyId,comments)}else throw new Error('ÏÇ≠Ï†ú Ïã§Ìå®')}catch(error){console.error('ÏÇ≠Ï†ú Ïã§Ìå®:',error);showToast('ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
let naverMap;let naverMarker;let selectedLat=null;let selectedLng=null;let wishCurrentMonth=new Date().getMonth();let wishCurrentYear=new Date().getFullYear();
async function showWishModal(){document.getElementById('wishModal').classList.add('active');await loadDailyPostsToSelect();setTimeout(()=>{initNaverMap()},300)}
async function loadDailyPostsToSelect(){try{const response=await fetch('/api/daily');const dailies=await response.json();const select=document.getElementById('wishDailyLink');select.innerHTML='<option value="">Ïó∞Í≤∞Ìï† ÏùºÏÉÅ Í≤åÏãúÎ¨º ÏÑ†ÌÉù</option>';dailies.forEach(daily=>{const option=document.createElement('option');option.value=daily.id;option.textContent=`${daily.content.substring(0,50)}${daily.content.length>50?'...':''} (${formatTimeAgo(new Date(daily.createdAt))})`;select.appendChild(option)})}catch(error){console.error('ÏùºÏÉÅ Í≤åÏãúÎ¨º Î°úÎìú Ïã§Ìå®:',error)}}
function initNaverMap(){if(typeof naver==='undefined'||!naver.maps){console.error('Naver Maps APIÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');showToast('ÏßÄÎèÑÎ•º Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.','error');return}const mapDiv=document.getElementById('naverMap');if(naverMap){return}const mapOptions={center:new naver.maps.LatLng(37.5665,126.9780),zoom:15};naverMap=new naver.maps.Map(mapDiv,mapOptions);naverMarker=new naver.maps.Marker({position:naverMap.getCenter(),map:naverMap});naver.maps.Event.addListener(naverMap,'click',function(e){const latlng=e.coord;naverMarker.setPosition(latlng);selectedLat=latlng.lat();selectedLng=latlng.lng();document.getElementById('wishLatitude').value=selectedLat;document.getElementById('wishLongitude').value=selectedLng;naver.maps.Service.reverseGeocode({coords:latlng},function(status,response){if(status===naver.maps.Service.Status.OK){const result=response.v2.address;const address=result.jibunAddress||result.roadAddress;document.getElementById('wishAddress').value=address}else{document.getElementById('wishAddress').value='Ï£ºÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.'}})})}
async function searchLocation(){const query=document.getElementById('wishLocationSearch').value.trim();if(!query){showToast('Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.','error');return}try{naver.maps.Service.geocode({query:query},function(status,response){if(status===naver.maps.Service.Status.OK){const result=response.v2.addresses[0];if(result){const latlng=new naver.maps.LatLng(result.y,result.x);naverMap.setCenter(latlng);naverMap.setZoom(16);naverMarker.setPosition(latlng);selectedLat=result.y;selectedLng=result.x;document.getElementById('wishLatitude').value=selectedLat;document.getElementById('wishLongitude').value=selectedLng;document.getElementById('wishAddress').value=result.jibunAddress||result.roadAddress}else{showToast('Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.','error')}}else{showToast('ÏúÑÏπò Í≤ÄÏÉâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}})}catch(error){console.error('ÏúÑÏπò Í≤ÄÏÉâ Ïã§Ìå®:',error);showToast('ÏúÑÏπò Í≤ÄÏÉâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function submitWish(event){event.preventDefault();const title=document.getElementById('wishTitle').value.trim();const description=document.getElementById('wishDescription').value.trim();const category=document.getElementById('wishCategory').value;const imageFile=document.getElementById('wishImage').files[0];const scheduleDate=document.getElementById('wishScheduleDate').value;const scheduleTime=document.getElementById('wishScheduleTime').value;const dailyId=document.getElementById('wishDailyLink').value;if(!title||!category){showToast('Ï†úÎ™©Í≥º Ïπ¥ÌÖåÍ≥†Î¶¨Îäî ÌïÑÏàòÏûÖÎãàÎã§.','error');return}const formData=new FormData();formData.append('title',title);if(description)formData.append('description',description);formData.append('category',category);if(selectedLat)formData.append('latitude',selectedLat);if(selectedLng)formData.append('longitude',selectedLng);if(document.getElementById('wishAddress').value)formData.append('address',document.getElementById('wishAddress').value);if(imageFile)formData.append('image',imageFile);if(dailyId)formData.append('dailyId',dailyId);if(scheduleDate){let scheduledDateTime=scheduleDate;if(scheduleTime){scheduledDateTime+=`T${scheduleTime}:00`}else{scheduledDateTime+='T00:00:00'}formData.append('scheduleDate',scheduledDateTime)}try{const response=await fetch('/api/wish',{method:'POST',body:formData});if(response.ok){showToast('ÏúÑÏãúÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.','success');closeModal('wishModal');document.getElementById('wishForm').reset();selectedLat=null;selectedLng=null;await loadWishes();await loadWishSchedules()}else{const error=await response.json();showToast(error.error||'ÏúÑÏãú Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}catch(error){console.error('ÏúÑÏãú Ï∂îÍ∞Ä Ïã§Ìå®:',error);showToast('ÏúÑÏãú Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
let allWishes=[];let wishPage=1;const wishPageSize=3;
async function loadWishes(){try{const response=await fetch('/api/wish',{cache:'no-store',headers:{'Cache-Control':'no-cache','Pragma':'no-cache'}});const wishes=await response.json();allWishes=wishes.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));wishPage=1;renderWishes()}catch(error){console.error('ÏúÑÏãúÎ¶¨Ïä§Ìä∏ Î°úÎìú Ïã§Ìå®:',error);showToast('ÏúÑÏãúÎ¶¨Ïä§Ìä∏Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
function renderWishes(){const grid=document.getElementById('wishListGrid');const start=0;const end=wishPage*wishPageSize;const wishes=allWishes.slice(start,end);if(!wishes||wishes.length===0){grid.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon"><i class="bi bi-star-fill"></i></div><div class="empty-state-title">ÏúÑÏãúÎ¶¨Ïä§Ìä∏Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§</div><div class="empty-state-text">Ï≤´ Î≤àÏß∏ ÏúÑÏãúÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</div></div>';return}const categoryColors={RESTAURANT:'rgba(255,182,193,0.7)',TRAVEL:'rgba(173,216,230,0.7)',SHOPPING:'rgba(221,160,221,0.7)',CAFE:'rgba(255,218,185,0.7)',ACTIVITY:'rgba(152,251,152,0.7)',OTHER:'rgba(211,211,211,0.7)'};const categoryColorsDark={RESTAURANT:'rgba(255,182,193,0.2)',TRAVEL:'rgba(173,216,230,0.2)',SHOPPING:'rgba(221,160,221,0.2)',CAFE:'rgba(255,218,185,0.2)',ACTIVITY:'rgba(152,251,152,0.2)',OTHER:'rgba(211,211,211,0.2)'};const categoryIcons={RESTAURANT:'üçΩÔ∏è',TRAVEL:'‚úàÔ∏è',SHOPPING:'üõçÔ∏è',CAFE:'‚òï',ACTIVITY:'üö¥',OTHER:'‚≠ê'};const isDark=document.body.classList.contains('dark-mode');const colors=isDark?categoryColorsDark:categoryColors;let html=wishes.map(wish=>{const scheduleInfo=allWishSchedules.find(s=>s.wishId===wish.id);return`<div class="wish-card" style="${wish.completed?'opacity:0.6;':''}">${wish.imageUrl?`<img src="${wish.imageUrl}" style="width:100%;height:180px;object-fit:cover;cursor:pointer" onclick="showImageModal('${wish.imageUrl}')">`:''}  <div class="wish-card-header"><span class="wish-tag" style="background:${colors[wish.category]||colors.OTHER};color:${isDark?'#e5e5e5':'#333'}">${categoryIcons[wish.category]||'‚≠ê'} ${wish.category}</span><h6 class="wish-card-title" style="${wish.completed?'text-decoration:line-through;color:var(--gray-600)':''}">${escapeHtml(wish.title)}</h6>${wish.user.id==currentUserId?`<button class="wish-menu-btn" onclick="toggleWishMenu(event,${wish.id})"><i class="bi bi-three-dots-vertical"></i></button><div id="wish-menu-${wish.id}" class="wish-dropdown"><button class="wish-dropdown-item" onclick="toggleWishCompletion(${wish.id})"><i class="bi bi-${wish.completed?'arrow-counterclockwise':'check-lg'}"></i> ${wish.completed?'ÎØ∏ÏôÑÎ£åÎ°ú Î≥ÄÍ≤Ω':'ÏôÑÎ£å Ï≤òÎ¶¨'}</button>${wish.dailyId?`<button class="wish-dropdown-item" onclick="showLinkedDaily(${wish.dailyId})"><i class="bi bi-journal-text"></i> ÏùºÏÉÅ Î≥¥Í∏∞</button>`:''}${wish.latitude&&wish.longitude?`<button class="wish-dropdown-item" onclick="openNaverMapLink(${wish.latitude},${wish.longitude},'${escapeForAttribute(wish.title)}')"><i class="bi bi-map"></i> ÏßÄÎèÑ Î≥¥Í∏∞</button>`:''}<button class="wish-dropdown-item" onclick="deleteWish(${wish.id})"><i class="bi bi-trash"></i> ÏÇ≠Ï†ú</button></div>`:''}</div>${wish.description?`<div style="padding:0 16px 8px 16px;font-size:13px;color:var(--gray-600);line-height:1.5">${escapeHtml(wish.description)}</div>`:''}${wish.address?`<div style="padding:0 16px 8px 16px;font-size:12px;color:var(--gray-600);display:flex;align-items:center;gap:4px"><i class="bi bi-geo-alt-fill"></i><span>${escapeHtml(wish.address)}</span></div>`:''}<div class="wish-card-body">${wish.dailyId?`<span class="wish-info-badge"><i class="bi bi-link-45deg"></i> ÏùºÏÉÅ Í≤åÏãúÎ¨º Ïó∞Í≤∞Îê®</span>`:''}${scheduleInfo?`<span class="wish-info-badge"><i class="bi bi-calendar-event"></i> ${new Date(scheduleInfo.scheduledDate).toLocaleDateString()}</span>`:''}<button class="wish-status-btn ${wish.completed?'completed':'incomplete'}" onclick="toggleWishCompletion(${wish.id})">${wish.completed?'‚úì ÏôÑÎ£å':'ÎØ∏ÏôÑÎ£å'}</button></div></div>`}).join('');if(end<allWishes.length){html+=`<button onclick="loadMoreWishes()" class="comment-submit-btn" style="grid-column:1/-1;margin-top:8px"><i class="bi bi-arrow-down-circle"></i> Îçî Î≥¥Í∏∞ (${allWishes.length-end}Í∞ú ÎÇ®Ïùå)</button>`}grid.innerHTML=html}
function showLinkedDaily(dailyId){switchTab('dailyTab');setTimeout(()=>{const dailyElement=document.querySelector(`[data-daily-id="${dailyId}"]`);if(dailyElement){dailyElement.scrollIntoView({behavior:'smooth',block:'center'});dailyElement.style.animation='highlight 2s ease'}else{showToast('Ïó∞Í≤∞Îêú ÏùºÏÉÅ Í≤åÏãúÎ¨ºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.','error')}},300)}
function loadMoreWishes(){wishPage++;renderWishes()}
async function toggleWishCompletion(wishId){try{const response=await fetch(`/api/wish/${wishId}/toggle-complete`,{method:'POST'});if(response.ok){const result=await response.json();showToast(result.completed?'ÏúÑÏãúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!':'ÏúÑÏãúÍ∞Ä ÎØ∏ÏôÑÎ£åÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.','success');await loadWishes()}else throw new Error('ÏôÑÎ£å Ï≤òÎ¶¨ Ïã§Ìå®')}catch(error){console.error('ÏôÑÎ£å Ï≤òÎ¶¨ Ïã§Ìå®:',error);showToast('ÏôÑÎ£å Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function deleteWish(wishId){if(!confirm('Ïù¥ ÏúÑÏãúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?'))return;try{const response=await fetch(`/api/wish/${wishId}`,{method:'DELETE'});if(response.ok){showToast('ÏúÑÏãúÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.','success');await loadWishes();await loadWishSchedules()}else throw new Error('ÏÇ≠Ï†ú Ïã§Ìå®')}catch(error){console.error('ÏÇ≠Ï†ú Ïã§Ìå®:',error);showToast('ÏúÑÏãú ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
function toggleWishMenu(event,wishId){event.stopPropagation();const menu=document.getElementById(`wish-menu-${wishId}`);const allMenus=document.querySelectorAll('.wish-dropdown');allMenus.forEach(m=>{if(m.id!==`wish-menu-${wishId}`)m.classList.remove('active')});menu.classList.toggle('active')}
document.addEventListener('click',function(e){if(!e.target.closest('.wish-menu-btn')){const allMenus=document.querySelectorAll('.wish-dropdown');allMenus.forEach(m=>m.classList.remove('active'))}});
function openNaverMapLink(lat,lng,title){const url=`https://map.naver.com/v5/?c=${lng},${lat},15,0,0,0,dh&p=${lat},${lng},-,-,${encodeURIComponent(title)}`;window.open(url,'_blank')}
let allWishSchedules=[];async function loadWishSchedules(){try{const response=await fetch('/api/wish/schedules',{cache:'no-store',headers:{'Cache-Control':'no-cache','Pragma':'no-cache'}});const schedules=await response.json();allWishSchedules=schedules;renderWishCalendar(schedules);renderWishScheduleList(schedules)}catch(error){console.error('ÏùºÏ†ï Î°úÎìú Ïã§Ìå®:',error)}}
let selectedWishDate=null;function renderWishCalendar(schedules){const title=document.getElementById('wishCalendarTitle');title.textContent=`${wishCurrentYear}ÎÖÑ ${wishCurrentMonth+1}Ïõî`;const grid=document.getElementById('wishCalendarGrid');const firstDay=new Date(wishCurrentYear,wishCurrentMonth,1).getDay();const lastDate=new Date(wishCurrentYear,wishCurrentMonth+1,0).getDate();const today=new Date();today.setHours(0,0,0,0);let html='<div class="calendar-weekdays">';['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'].forEach((day,index)=>{html+=`<div class="calendar-weekday" style="${index===0?'color:#e74c3c':index===6?'color:#3498db':''}">${day}</div>`});html+='</div><div class="calendar-days">';for(let i=0;i<firstDay;i++){html+='<div class="calendar-day empty"></div>'}for(let day=1;day<=lastDate;day++){const date=new Date(wishCurrentYear,wishCurrentMonth,day);date.setHours(0,0,0,0);const dateStr=`${wishCurrentYear}-${String(wishCurrentMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;const isToday=date.getTime()===today.getTime();const isSelected=selectedWishDate===dateStr;const daySchedules=schedules.filter(s=>{const scheduleDate=new Date(s.scheduledDate);return scheduleDate.getFullYear()===wishCurrentYear&&scheduleDate.getMonth()===wishCurrentMonth&&scheduleDate.getDate()===day});html+=`<div class="calendar-day ${isToday?'today':''} ${isSelected?'selected':''}" onclick="selectWishDate('${dateStr}')" style="cursor:pointer;${daySchedules.length>0&&!isSelected&&!isToday?'background:#e3f2fd;font-weight:700':''}">${day}${daySchedules.length>0?`<div style="font-size:10px;color:#1976d2">${daySchedules.length}Í∞ú</div>`:''}</div>`}html+='</div>';grid.innerHTML=html}
function selectWishDate(dateStr){selectedWishDate=dateStr;renderWishCalendar(allWishSchedules);showWishScheduleModal(dateStr)}
function showWishScheduleModal(dateStr){const daySchedules=allWishSchedules.filter(s=>{const scheduleDate=new Date(s.scheduledDate);const targetDate=new Date(dateStr);return scheduleDate.getFullYear()===targetDate.getFullYear()&&scheduleDate.getMonth()===targetDate.getMonth()&&scheduleDate.getDate()===targetDate.getDate()});const categoryColors={RESTAURANT:'rgba(255,182,193,0.7)',TRAVEL:'rgba(173,216,230,0.7)',SHOPPING:'rgba(221,160,221,0.7)',CAFE:'rgba(255,218,185,0.7)',ACTIVITY:'rgba(152,251,152,0.7)',OTHER:'rgba(211,211,211,0.7)'};const categoryColorsDark={RESTAURANT:'rgba(255,182,193,0.2)',TRAVEL:'rgba(173,216,230,0.2)',SHOPPING:'rgba(221,160,221,0.2)',CAFE:'rgba(255,218,185,0.2)',ACTIVITY:'rgba(152,251,152,0.2)',OTHER:'rgba(211,211,211,0.2)'};const categoryIcons={RESTAURANT:'üçΩÔ∏è',TRAVEL:'‚úàÔ∏è',SHOPPING:'üõçÔ∏è',CAFE:'‚òï',ACTIVITY:'üö¥',OTHER:'‚≠ê'};const isDark=document.body.classList.contains('dark-mode');const colors=isDark?categoryColorsDark:categoryColors;const modal=document.getElementById('imageModal');const modalImage=document.getElementById('modalImage');const modalTitle=document.getElementById('profileModalTitle');if(!modal||!modalImage){console.error('Modal not found');return}if(modalTitle){modalTitle.textContent=`üìÖ ${dateStr} ÏúÑÏãú ÏùºÏ†ï`}let html='';if(daySchedules.length===0){html='<div style="padding:40px;text-align:center;color:var(--gray-600)"><i class="bi bi-calendar-x" style="font-size:48px;margin-bottom:16px;display:block"></i><div style="font-size:16px;font-weight:600">Îì±Î°ùÎêú ÏùºÏ†ï ÏóÜÏùå</div><div style="font-size:14px;margin-top:8px">Ïù¥ ÎÇ†ÏßúÏóê Îì±Î°ùÎêú ÏúÑÏãú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§.</div></div>'}else{html=daySchedules.map(schedule=>{const wish=schedule.wish;return`<div class="wish-card" style="margin-bottom:12px;${schedule.completed?'opacity:0.6;':''}"><div class="wish-card-header"><span class="wish-tag" style="background:${colors[wish.category]||colors.OTHER};color:${isDark?'#e5e5e5':'#333'}">${categoryIcons[wish.category]||'‚≠ê'} ${wish.category}</span><h6 class="wish-card-title" style="${schedule.completed?'text-decoration:line-through;color:var(--gray-600)':''}">${escapeHtml(schedule.title)}</h6></div>${wish.description?`<div style="padding:0 16px 8px 16px;font-size:13px;color:var(--gray-600);line-height:1.5">${escapeHtml(wish.description)}</div>`:''}${wish.address?`<div style="padding:0 16px 8px 16px;font-size:12px;color:var(--gray-600);display:flex;align-items:center;gap:4px"><i class="bi bi-geo-alt-fill"></i><span>${escapeHtml(wish.address)}</span></div>`:''}<div style="padding:0 16px 12px 16px;font-size:12px;color:var(--gray-600)"><i class="bi bi-clock"></i> ${formatDateTime(new Date(schedule.scheduledDate))}</div>${wish.dailyId?`<div style="padding:0 16px 8px 16px"><span class="wish-info-badge"><i class="bi bi-link-45deg"></i> ÏùºÏÉÅ Í≤åÏãúÎ¨º Ïó∞Í≤∞Îê®</span></div>`:''}<div style="padding:0 16px 12px 16px;display:flex;gap:8px"><button class="comment-submit-btn" style="padding:8px 16px;font-size:13px;${schedule.completed?'background:var(--gray-600)':'background:var(--success)'}" onclick="toggleScheduleCompletion(${schedule.id});showWishScheduleModal('${dateStr}')"><i class="bi bi-${schedule.completed?'arrow-counterclockwise':'check-lg'}"></i> ${schedule.completed?'ÎØ∏ÏôÑÎ£å':'ÏôÑÎ£å'}</button>${wish.latitude&&wish.longitude?`<button class="comment-submit-btn" style="padding:8px 16px;font-size:13px;background:var(--info)" onclick="openNaverMapLink(${wish.latitude},${wish.longitude},'${escapeForAttribute(wish.title)}')"><i class="bi bi-map"></i> ÏßÄÎèÑ</button>`:''}${wish.dailyId?`<button class="comment-submit-btn" style="padding:8px 16px;font-size:13px;background:var(--primary)" onclick="closeModal('imageModal');showLinkedDaily(${wish.dailyId})"><i class="bi bi-journal-text"></i> ÏùºÏÉÅ</button>`:''}${schedule.wish.user.id==currentUserId?`<button class="comment-submit-btn" style="padding:8px 16px;font-size:13px;background:var(--danger)" onclick="deleteSchedule(${schedule.id})"><i class="bi bi-trash"></i> ÏÇ≠Ï†ú</button>`:''}</div></div>`}).join('')}modalImage.innerHTML=html;modal.classList.add('active')}
function filterWishesByDate(dateStr){const daySchedules=allWishSchedules.filter(s=>{const scheduleDate=new Date(s.scheduledDate);const targetDate=new Date(dateStr);return scheduleDate.getFullYear()===targetDate.getFullYear()&&scheduleDate.getMonth()===targetDate.getMonth()&&scheduleDate.getDate()===targetDate.getDate()});if(daySchedules.length===0){showToast(`${dateStr} ÎÇ†ÏßúÏóê ÏòàÏ†ïÎêú ÏúÑÏãúÍ∞Ä ÏóÜÏäµÎãàÎã§.`,'info');return}const wishIds=daySchedules.map(s=>s.wishId);const filtered=allWishes.filter(w=>wishIds.includes(w.id));if(filtered.length===0){showToast(`${dateStr} ÎÇ†ÏßúÏóê ÏòàÏ†ïÎêú ÏúÑÏãúÍ∞Ä ÏóÜÏäµÎãàÎã§.`,'info');return}const grid=document.getElementById('wishListGrid');const categoryColors={RESTAURANT:'rgba(255,182,193,0.7)',TRAVEL:'rgba(173,216,230,0.7)',SHOPPING:'rgba(221,160,221,0.7)',CAFE:'rgba(255,218,185,0.7)',ACTIVITY:'rgba(152,251,152,0.7)',OTHER:'rgba(211,211,211,0.7)'};const categoryColorsDark={RESTAURANT:'rgba(255,182,193,0.2)',TRAVEL:'rgba(173,216,230,0.2)',SHOPPING:'rgba(221,160,221,0.2)',CAFE:'rgba(255,218,185,0.2)',ACTIVITY:'rgba(152,251,152,0.2)',OTHER:'rgba(211,211,211,0.2)'};const categoryIcons={RESTAURANT:'üçΩÔ∏è',TRAVEL:'‚úàÔ∏è',SHOPPING:'üõçÔ∏è',CAFE:'‚òï',ACTIVITY:'üö¥',OTHER:'‚≠ê'};const isDark=document.body.classList.contains('dark-mode');const colors=isDark?categoryColorsDark:categoryColors;let html='<div style="grid-column:1/-1;padding:12px;background:var(--info-light);border-radius:8px;margin-bottom:12px"><strong>üìÖ '+dateStr+'</strong> ÎÇ†ÏßúÏùò ÏúÑÏãú ('+filtered.length+'Í∞ú) <button onclick="wishPage=1;renderWishes()" style="background:none;border:none;color:var(--primary);text-decoration:underline;cursor:pointer;margin-left:12px">Ï†ÑÏ≤¥ Î≥¥Í∏∞</button></div>';html+=filtered.map(wish=>{const scheduleInfo=allWishSchedules.find(s=>s.wishId===wish.id);return`<div class="wish-card" style="${wish.completed?'opacity:0.6;':''}">${wish.imageUrl?`<img src="${wish.imageUrl}" style="width:100%;height:180px;object-fit:cover;cursor:pointer" onclick="showImageModal('${wish.imageUrl}')">`:''}  <div class="wish-card-header"><span class="wish-tag" style="background:${colors[wish.category]||colors.OTHER};color:${isDark?'#e5e5e5':'#333'}">${categoryIcons[wish.category]||'‚≠ê'} ${wish.category}</span><h6 class="wish-card-title" style="${wish.completed?'text-decoration:line-through;color:var(--gray-600)':''}">${escapeHtml(wish.title)}</h6>${wish.user.id==currentUserId?`<button class="wish-menu-btn" onclick="toggleWishMenu(event,${wish.id})"><i class="bi bi-three-dots-vertical"></i></button><div id="wish-menu-${wish.id}" class="wish-dropdown"><button class="wish-dropdown-item" onclick="toggleWishCompletion(${wish.id})"><i class="bi bi-${wish.completed?'arrow-counterclockwise':'check-lg'}"></i> ${wish.completed?'ÎØ∏ÏôÑÎ£åÎ°ú Î≥ÄÍ≤Ω':'ÏôÑÎ£å Ï≤òÎ¶¨'}</button>${wish.dailyId?`<button class="wish-dropdown-item" onclick="showLinkedDaily(${wish.dailyId})"><i class="bi bi-journal-text"></i> ÏùºÏÉÅ Î≥¥Í∏∞</button>`:''}${wish.latitude&&wish.longitude?`<button class="wish-dropdown-item" onclick="openNaverMapLink(${wish.latitude},${wish.longitude},'${escapeForAttribute(wish.title)}')"><i class="bi bi-map"></i> ÏßÄÎèÑ Î≥¥Í∏∞</button>`:''}<button class="wish-dropdown-item" onclick="deleteWish(${wish.id})"><i class="bi bi-trash"></i> ÏÇ≠Ï†ú</button></div>`:''}</div>${wish.description?`<div style="padding:0 16px 8px 16px;font-size:13px;color:var(--gray-600);line-height:1.5">${escapeHtml(wish.description)}</div>`:''}${wish.address?`<div style="padding:0 16px 8px 16px;font-size:12px;color:var(--gray-600);display:flex;align-items:center;gap:4px"><i class="bi bi-geo-alt-fill"></i><span>${escapeHtml(wish.address)}</span></div>`:''}<div class="wish-card-body">${wish.dailyId?`<span class="wish-info-badge"><i class="bi bi-link-45deg"></i> ÏùºÏÉÅ Í≤åÏãúÎ¨º Ïó∞Í≤∞Îê®</span>`:''}${scheduleInfo?`<span class="wish-info-badge"><i class="bi bi-calendar-event"></i> ${new Date(scheduleInfo.scheduledDate).toLocaleDateString()}</span>`:''}<button class="wish-status-btn ${wish.completed?'completed':'incomplete'}" onclick="toggleWishCompletion(${wish.id})">${wish.completed?'‚úì ÏôÑÎ£å':'ÎØ∏ÏôÑÎ£å'}</button></div></div>`}).join('');grid.innerHTML=html}
function renderWishScheduleList(schedules){const list=document.getElementById('wishScheduleList');const currentMonth=new Date(wishCurrentYear,wishCurrentMonth);const nextMonth=new Date(wishCurrentYear,wishCurrentMonth+1);const monthSchedules=schedules.filter(s=>{const date=new Date(s.scheduledDate);return date>=currentMonth&&date<nextMonth});if(!monthSchedules||monthSchedules.length===0){list.innerHTML='<div class="empty-state"><p>Ïù¥Î≤à Îã¨Ïóê ÏòàÏ†ïÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§.</p></div>';return}const categoryColors={RESTAURANT:'#ff6b6b',TRAVEL:'#4ecdc4',SHOPPING:'#45b7d1',CAFE:'#f9ca24',ACTIVITY:'#ee5a6f',OTHER:'#95a5a6'};list.innerHTML=monthSchedules.map(schedule=>`<div class="comment-item" style="padding:16px;${schedule.completed?'opacity:0.6;':''}"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px"><div style="flex:1"><div style="display:inline-block;padding:4px 12px;background:${categoryColors[schedule.wish.category]||'#95a5a6'};color:white;border-radius:12px;font-size:12px;font-weight:600;margin-bottom:8px">${schedule.wish.category}</div><h6 style="font-weight:700;margin-bottom:4px;${schedule.completed?'text-decoration:line-through;color:var(--gray-600)':''}">${escapeHtml(schedule.title)}</h6><div style="font-size:13px;color:var(--gray-600);margin-bottom:4px"><i class="bi bi-calendar-event"></i> ${formatDateTime(new Date(schedule.scheduledDate))}</div>${schedule.wish.address?`<div style="font-size:13px;color:var(--gray-600)"><i class="bi bi-geo-alt-fill"></i> ${escapeHtml(schedule.wish.address)}</div>`:''}</div><button class="comment-delete-btn" onclick="deleteSchedule(${schedule.id})"><i class="bi bi-trash"></i></button></div><div style="display:flex;gap:8px"><button class="comment-submit-btn" style="padding:8px 16px;font-size:13px;${schedule.completed?'background:var(--gray-600)':'background:var(--success)'}" onclick="toggleScheduleCompletion(${schedule.id})"><i class="bi bi-${schedule.completed?'arrow-counterclockwise':'check-lg'}"></i> ${schedule.completed?'ÎØ∏ÏôÑÎ£å':'ÏôÑÎ£å'}</button></div></div>`).join('')}
async function toggleScheduleCompletion(scheduleId){try{const response=await fetch(`/api/wish/schedules/${scheduleId}/toggle-complete`,{method:'POST'});if(response.ok){const result=await response.json();showToast(result.completed?'ÏùºÏ†ïÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!':'ÏùºÏ†ïÏù¥ ÎØ∏ÏôÑÎ£åÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.','success');await loadWishSchedules()}else throw new Error('ÏôÑÎ£å Ï≤òÎ¶¨ Ïã§Ìå®')}catch(error){console.error('ÏôÑÎ£å Ï≤òÎ¶¨ Ïã§Ìå®:',error);showToast('ÏôÑÎ£å Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function deleteSchedule(scheduleId){if(!confirm('Ïù¥ ÏùºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?'))return;try{const response=await fetch(`/api/wish/schedules/${scheduleId}`,{method:'DELETE'});if(response.ok){showToast('ÏùºÏ†ïÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.','success');await loadWishSchedules()}else throw new Error('ÏÇ≠Ï†ú Ïã§Ìå®')}catch(error){console.error('ÏÇ≠Ï†ú Ïã§Ìå®:',error);showToast('ÏùºÏ†ï ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
function changeWishMonth(delta){wishCurrentMonth+=delta;if(wishCurrentMonth<0){wishCurrentMonth=11;wishCurrentYear--}else if(wishCurrentMonth>11){wishCurrentMonth=0;wishCurrentYear++}loadWishSchedules()}
function formatDateTime(date){return`${date.getFullYear()}ÎÖÑ ${date.getMonth()+1}Ïõî ${date.getDate()}Ïùº ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`}
async function loadHomeRecentDailies(){try{const response=await fetch('/api/daily');const dailies=await response.json();const recentDailies=dailies.slice(0,3);renderHomeRecentDailies(recentDailies)}catch(error){console.error('Ìôà ÏùºÏÉÅ Î°úÎìú Ïã§Ìå®:',error)}}
function renderHomeRecentDailies(dailies){const container=document.getElementById('homeRecentDailies');if(!dailies||dailies.length===0){container.innerHTML='<div class="empty-state"><p>ÏïÑÏßÅ ÏùºÏÉÅ Í≤åÏãúÎ¨ºÏù¥ ÏóÜÏäµÎãàÎã§.</p></div>';return}container.innerHTML=dailies.map(daily=>{const truncatedContent=daily.content&&daily.content.length>50?daily.content.substring(0,50)+'...':daily.content||'';const rainbowClass=hasRecentProfileUpdate(daily.user)?'rainbow-border':'';let thumbnailHtml='';if(daily.images&&daily.images.length>0){const firstImage=daily.images[0];if(firstImage.mediaType==='VIDEO'){thumbnailHtml=`<div style="width:60px;height:60px;border-radius:8px;overflow:hidden;flex-shrink:0;background:#000;display:flex;align-items:center;justify-content:center"><i class="bi bi-play-circle-fill" style="font-size:24px;color:white"></i></div>`}else{thumbnailHtml=`<div style="width:60px;height:60px;border-radius:8px;overflow:hidden;flex-shrink:0"><img src="${firstImage.imageUrl}" style="width:100%;height:100%;object-fit:cover"></div>`}}else if(daily.mediaUrl){if(daily.mediaType==='VIDEO'){thumbnailHtml=`<div style="width:60px;height:60px;border-radius:8px;overflow:hidden;flex-shrink:0;background:#000;display:flex;align-items:center;justify-content:center"><i class="bi bi-play-circle-fill" style="font-size:24px;color:white"></i></div>`}else{thumbnailHtml=`<div style="width:60px;height:60px;border-radius:8px;overflow:hidden;flex-shrink:0"><img src="${daily.mediaUrl}" style="width:100%;height:100%;object-fit:cover"></div>`}}return`<div class="comment-item" style="padding:12px;cursor:pointer;display:flex;gap:12px;align-items:center" onclick="switchTab('dailyTab')"><div style="flex:1;min-width:0"><div class="comment-header" style="margin-bottom:6px"><div class="comment-avatar ${rainbowClass}" style="width:28px;height:28px;font-size:12px">${daily.user.profileImage?`<img src="${daily.user.profileImage}" alt="${daily.user.displayName}">`:daily.user.displayName.substring(0,1)}</div><div class="comment-user-info"><div class="comment-username" style="font-size:12px">${daily.user.displayName}</div><div class="comment-time" style="font-size:10px">${formatTimeAgo(new Date(daily.createdAt))}</div></div></div><div style="font-size:13px;line-height:1.4;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical">${escapeHtml(truncatedContent)}</div></div>${thumbnailHtml}</div>`}).join('')}
function toggleCommentSection(){const content=document.getElementById('commentSectionContent');const icon=document.getElementById('commentToggleIcon');if(content.style.display==='none'){content.style.display='block';icon.style.transform='rotate(180deg)'}else{content.style.display='none';icon.style.transform='rotate(0deg)'}}
let activityPage=1;const activityPageSize=3;let allActivitiesData=[];let activitySSE=null;
async function loadActivities(){try{const response=await fetch('/api/activity',{cache:'no-store',headers:{'Cache-Control':'no-cache'}});const data=await response.json();allActivitiesData=data.activities||[];activityPage=1;renderActivities()}catch(error){console.error('ÌôúÎèô Î°úÎìú Ïã§Ìå®:',error)}}
function initActivitySSE(){if(activitySSE){activitySSE.close()}try{activitySSE=new EventSource('/api/activity/stream');activitySSE.addEventListener('connected',function(e){console.log('‚úÖ SSE Ïó∞Í≤∞Îê®:',e.data)});activitySSE.addEventListener('activity',function(e){console.log('üì® SSE ÌôúÎèô ÏïåÎ¶º:',e.data);loadActivities()});activitySSE.onerror=function(err){console.error('‚ùå SSE Ïò§Î•ò:',err);setTimeout(initActivitySSE,5000)}}catch(error){console.error('‚ùå SSE Ï¥àÍ∏∞Ìôî Ïã§Ìå®:',error)}}
function renderActivities(){const container=document.getElementById('activityList');if(!allActivitiesData||allActivitiesData.length===0){container.innerHTML='<div class="empty-state"><p>ÌôúÎèô ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p></div>';return}const activityIcons={COMMENT:'chat-heart-fill',COMMENT_REPLY:'reply-fill',DAILY_POST:'images',DAILY_COMMENT:'chat-dots-fill',DAILY_LIKE:'heart-fill',WISH_ADDED:'star-fill',SCHEDULE_ADDED:'calendar-plus-fill',PROFILE_UPDATED:'person-circle',MEDICINE_TAKEN:'capsule',MEAL_UPLOADED:'egg-fried'};const activityTabs={COMMENT:'homeTab',COMMENT_REPLY:'homeTab',DAILY_POST:'dailyTab',DAILY_COMMENT:'dailyTab',DAILY_LIKE:'dailyTab',WISH_ADDED:'wishTab',SCHEDULE_ADDED:'wishTab',PROFILE_UPDATED:'homeTab',MEDICINE_TAKEN:'healthTab',MEAL_UPLOADED:'healthTab'};const displayActivities=allActivitiesData.slice(0,activityPage*activityPageSize);let html=displayActivities.map(activity=>{const rainbowClass=hasRecentProfileUpdate(activity.user)?'rainbow-border':'';return`<div class="comment-item activity-item-${activity.id}" style="padding:12px;background:var(--white);border:1px solid var(--gray-200)" data-activity-id="${activity.id}" class="activity-item-modern"><div style="display:flex;justify-content:space-between;align-items:start"><div style="flex:1"><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><div class="comment-avatar ${rainbowClass}" style="width:32px;height:32px;font-size:14px">${activity.user.profileImage?`<img src="${activity.user.profileImage}" alt="${activity.user.displayName}">`:activity.user.displayName.substring(0,1)}</div><span style="font-size:14px;line-height:1.4;color:var(--text-primary)">${escapeHtml(activity.message)}</span></div><div style="font-size:11px;color:var(--gray-600);margin-left:40px">${formatTimeAgo(new Date(activity.createdAt))}</div></div><div style="display:flex;gap:4px"><button onclick="navigateToActivity('${activityTabs[activity.activityType]}',${activity.id})" style="background:var(--primary);color:white;border:none;border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer;white-space:nowrap;transition:all .2s" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'"><i class="bi bi-${activityIcons[activity.activityType]||'arrow-right'}"></i> Î≥¥Í∏∞</button><button onclick="deleteActivity(${activity.id})" style="background:var(--danger);color:white;border:none;border-radius:6px;padding:6px 8px;font-size:12px;cursor:pointer;transition:all .2s" title="ÏÇ≠Ï†ú"><i class="bi bi-trash"></i></button></div></div></div>`}).join('');if(displayActivities.length<allActivitiesData.length){html+=`<button onclick="loadMoreActivities()" class="comment-submit-btn" style="width:100%;margin-top:12px"><i class="bi bi-arrow-down-circle"></i> Îçî Î≥¥Í∏∞ (${allActivitiesData.length-displayActivities.length}Í∞ú ÎÇ®Ïùå)</button>`}if(allActivitiesData.length>0){html=`<div style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:12px;margin-bottom:12px;box-shadow:0 4px 15px rgba(102,126,234,0.4)" class="activity-header"><div style="font-weight:700;color:#fff;font-size:15px"><i class="bi bi-bell-fill"></i> ÌôúÎèôÏïåÎ¶º ${allActivitiesData.length}Í∞ú</div><button onclick="deleteAllActivities()" class="comment-submit-btn" style="padding:6px 14px;font-size:12px;background:rgba(255,255,255,0.3);color:#fff;font-weight:600;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.4)" onmouseover="this.style.background='rgba(255,255,255,0.4)'" onmouseout="this.style.background='rgba(255,255,255,0.3)'"><i class="bi bi-trash-fill"></i> Î™®Îëê ÏÇ≠Ï†ú</button></div>`+html}container.innerHTML=html}
function loadMoreActivities(){activityPage++;renderActivities()}
async function deleteActivity(activityId){try{const response=await fetch(`/api/activity/${activityId}`,{method:'DELETE'});if(response.ok){allActivitiesData=allActivitiesData.filter(a=>a.id!==activityId);renderActivities();showToast('ÌôúÎèôÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.','success')}else{throw new Error('ÏÇ≠Ï†ú Ïã§Ìå®')}}catch(error){console.error('ÌôúÎèô ÏÇ≠Ï†ú Ïã§Ìå®:',error);showToast('ÌôúÎèô ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function deleteAllActivities(){if(!confirm('Î™®Îì† ÌôúÎèôÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?'))return;try{const response=await fetch('/api/activity/delete-all',{method:'DELETE'});if(response.ok){allActivitiesData=[];renderActivities();showToast('Î™®Îì† ÌôúÎèôÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.','success')}else{throw new Error('ÏÇ≠Ï†ú Ïã§Ìå®')}}catch(error){console.error('Î™®Îì† ÌôúÎèô ÏÇ≠Ï†ú Ïã§Ìå®:',error);showToast('Î™®Îì† ÌôúÎèô ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
async function navigateToActivity(tabId,activityId){try{await fetch(`/api/activity/${activityId}/read`,{method:'POST'});allActivitiesData=allActivitiesData.filter(a=>a.id!==activityId);renderActivities();switchTab(tabId)}catch(error){console.error('ÌôúÎèô ÏùΩÏùå Ï≤òÎ¶¨ Ïã§Ìå®:',error);switchTab(tabId)}}
let healthCurrentMonth=new Date().getMonth();let healthCurrentYear=new Date().getFullYear();let healthMedicineRecordsCache=[];let selectedHealthDate=null;
async function renderHealthCalendar(){const title=document.getElementById('healthCalendarTitle');title.textContent=`${healthCurrentYear}ÎÖÑ ${healthCurrentMonth+1}Ïõî`;const today=new Date().toISOString().split('T')[0];try{const [medicineRes,mealsRes]=await Promise.all([fetch(`/api/medicine/calendar/${healthCurrentYear}/${healthCurrentMonth+1}`),fetch(`/api/meal/calendar/${healthCurrentYear}/${healthCurrentMonth+1}`)]);const medicineData=await medicineRes.json();const mealData=await mealsRes.json();const medicineRecords=medicineData.records||[];const dailyMealStats=mealData.dailyStats||[];healthMedicineRecordsCache=medicineRecords;const grid=document.getElementById('healthCalendarGrid');const firstDay=new Date(healthCurrentYear,healthCurrentMonth,1).getDay();const lastDate=new Date(healthCurrentYear,healthCurrentMonth+1,0).getDate();const todayDate=new Date();todayDate.setHours(0,0,0,0);let html='<div class="calendar-weekdays">';['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'].forEach((day,index)=>{html+=`<div class="calendar-weekday" style="${index===0?'color:#e74c3c':index===6?'color:#3498db':''}">${day}</div>`});html+='</div><div class="calendar-days">';for(let i=0;i<firstDay;i++){html+='<div class="calendar-day empty"></div>'}for(let day=1;day<=lastDate;day++){const date=new Date(healthCurrentYear,healthCurrentMonth,day);date.setHours(0,0,0,0);const dateStr=`${healthCurrentYear}-${String(healthCurrentMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;const isToday=date.getTime()===todayDate.getTime();const isSelected=selectedHealthDate===dateStr;let medicineStatus='';const dayMedicineRecords=medicineRecords.filter(r=>r.date===dateStr);let morningTaken=false,eveningTaken=false;dayMedicineRecords.forEach(r=>{if(r.medicineType==='MORNING'&&r.taken)morningTaken=true;if(r.medicineType==='EVENING'&&r.taken)eveningTaken=true});if(morningTaken&&eveningTaken)medicineStatus='<div style="font-size:10px;color:#10b981">ÏïΩüíä</div>';else if(morningTaken||eveningTaken)medicineStatus='<div style="font-size:10px;color:#f59e0b">ÏïΩüíä</div>';let mealStatus='';const dayMealStat=dailyMealStats.find(m=>m.date===dateStr);if(dayMealStat&&dayMealStat.averageScore>0){const avgScore=dayMealStat.averageScore;mealStatus=`<div style="font-size:10px;color:${avgScore>=80?'#10b981':avgScore>=60?'#f59e0b':'#ef4444'}">ÏãùüçΩÔ∏è</div>`}html+=`<div class="calendar-day ${isToday?'today':''} ${isSelected?'selected':''}" onclick="selectHealthDate('${dateStr}')" style="cursor:pointer">${day}${medicineStatus}${mealStatus}</div>`}html+='</div>';grid.innerHTML=html}catch(error){console.error('Í±¥Í∞ï Ï∫òÎ¶∞Îçî Î°úÎìú Ïã§Ìå®:',error);showToast('Í±¥Í∞ï Ï∫òÎ¶∞ÎçîÎ•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
function selectHealthDate(dateStr){selectedHealthDate=dateStr;renderHealthCalendar();showHealthDayDetails(dateStr)}
function changeHealthMonth(delta){healthCurrentMonth+=delta;if(healthCurrentMonth<0){healthCurrentMonth=11;healthCurrentYear--}else if(healthCurrentMonth>11){healthCurrentMonth=0;healthCurrentYear++}renderHealthCalendar()}
async function showHealthDayDetails(dateStr){try{const mealsRes=await fetch(`/api/meal/date/${dateStr}`);const mealsData=await mealsRes.json();const dayMeals=mealsData.meals||[];const dayMedicineRecords=healthMedicineRecordsCache.filter(r=>r.date===dateStr);let morningTaken=false,eveningTaken=false;dayMedicineRecords.forEach(r=>{if(r.medicineType==='MORNING'&&r.taken)morningTaken=true;if(r.medicineType==='EVENING'&&r.taken)eveningTaken=true});const detailsDiv=document.getElementById('healthDayDetails');let html=`<div style="padding:16px;background:var(--gray-100);border-radius:12px"><h6 style="font-weight:700;margin-bottom:12px">${dateStr} Í±¥Í∞ï Í∏∞Î°ù</h6>`;html+='<div style="margin-bottom:16px"><div style="font-weight:600;margin-bottom:8px"><i class="bi bi-capsule"></i> ÏïΩ Î≥µÏö©</div>';if(dayMedicineRecords.length>0){html+=`<div style="display:flex;gap:12px"><span style="padding:4px 12px;border-radius:8px;background:${morningTaken?'#dcfce7':'#fee2e2'};color:${morningTaken?'#065f46':'#991b1b'}">ÏïÑÏπ®: ${morningTaken?'Î≥µÏö©ÏôÑÎ£å':'ÎØ∏Î≥µÏö©'}</span><span style="padding:4px 12px;border-radius:8px;background:${eveningTaken?'#dcfce7':'#fee2e2'};color:${eveningTaken?'#065f46':'#991b1b'}">Ï†ÄÎÖÅ: ${eveningTaken?'Î≥µÏö©ÏôÑÎ£å':'ÎØ∏Î≥µÏö©'}</span></div>`}else{html+='<div style="color:var(--gray-600)">Í∏∞Î°ù ÏóÜÏùå</div>'}html+='</div>';html+='<div><div style="font-weight:600;margin-bottom:8px"><i class="bi bi-egg-fried"></i> ÏãùÎã® (ÏÇ¨ÏßÑ ÌÅ¥Î¶≠ Ïãú AI ÌèâÍ∞Ä Î≥¥Í∏∞)</div>';if(dayMeals&&dayMeals.length>0){html+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px">';dayMeals.forEach(meal=>{const mealTypeText=meal.mealType==='BREAKFAST'?'ÏïÑÏπ®':meal.mealType==='LUNCH'?'Ï†êÏã¨':'Ï†ÄÎÖÅ';const mealJson=JSON.stringify(meal).replace(/'/g,"&#39;");html+=`<div style="border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid var(--gray-300);transition:all .2s" onclick='showMealEvaluation(${mealJson})' onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--gray-300)'">${meal.imageUrl?`<img src="${meal.imageUrl}" style="width:100%;height:100px;object-fit:cover">`:'<div style="width:100%;height:100px;background:var(--gray-300);display:flex;align-items:center;justify-content:center"><i class="bi bi-image" style="font-size:32px;color:var(--gray-600)"></i></div>'}<div style="padding:8px;background:var(--white)"><div style="font-weight:600;font-size:13px">${mealTypeText}</div>${meal.score?`<div style="font-size:12px;color:${meal.score>=80?'#10b981':meal.score>=60?'#f59e0b':'#ef4444'};font-weight:600">${meal.score}Ï†ê</div>`:''}</div></div>`});html+='</div>'}else{html+='<div style="color:var(--gray-600)">Í∏∞Î°ù ÏóÜÏùå</div>'}html+='</div></div>';detailsDiv.innerHTML=html;detailsDiv.style.display='block'}catch(error){console.error('ÎÇ†Ïßú ÏÉÅÏÑ∏ Î°úÎìú Ïã§Ìå®:',error);showToast('Ìï¥Îãπ ÎÇ†ÏßúÏùò Í∏∞Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.','error')}}
function showMealEvaluation(meal){const modal=document.getElementById('imageModal');if(!modal){console.error('imageModal not found');return}if(!meal.imageUrl&&!meal.aiEvaluation){showToast('ÏãùÎã® Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.','info');return}const modalImage=document.getElementById('modalImage');const modalTitle=document.getElementById('profileModalTitle');if(!modalImage){console.error('modalImage not found');return}const mealTypeText=meal.mealType==='BREAKFAST'?'ÏïÑÏπ®':meal.mealType==='LUNCH'?'Ï†êÏã¨':'Ï†ÄÎÖÅ';if(modalTitle){modalTitle.textContent=`${mealTypeText} ÏãùÎã® ÌèâÍ∞Ä`}let html='';if(meal.imageUrl){html+=`<img src="${meal.imageUrl}" style="width:100%;max-height:400px;object-fit:contain;border-radius:12px;margin-bottom:16px">`}if(meal.aiEvaluation){const scoreColor=meal.score>=80?'#10b981':meal.score>=60?'#f59e0b':'#ef4444';html+=`<div style="padding:16px;background:${scoreColor}20;border-left:4px solid ${scoreColor};border-radius:8px"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><div style="font-size:32px;font-weight:700;color:${scoreColor}">${meal.score||0}Ï†ê</div><div style="flex:1;font-size:14px;color:var(--gray-600)">AI ÏòÅÏñë ÌèâÍ∞Ä</div></div><div style="font-size:14px;line-height:1.6;white-space:pre-wrap">${escapeHtml(meal.aiEvaluation)}</div></div>`}else{html+=`<div style="padding:16px;background:var(--gray-100);border-radius:8px;text-align:center;color:var(--gray-600)">AI ÌèâÍ∞ÄÍ∞Ä ÏïÑÏßÅ ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.</div>`}modalImage.innerHTML=html;modal.classList.add('active')}
</script>
</body>
</html>
