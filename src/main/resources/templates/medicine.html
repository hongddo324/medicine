<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4A90E2">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ì•½ë³µìš©">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>ì•½ ë³µìš© ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        *{-webkit-tap-highlight-color:transparent;margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#4A90E2;--success:#5cb85c;--danger:#d9534f;--warning:#f0ad4e;--info:#5bc0de;--gray-100:#f8f9fa;--gray-200:#e9ecef;--gray-300:#dee2e6;--gray-600:#6c757d;--gray-900:#212529;--nav-height:65px}
        body{background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 40%,#dbeafe 100%);min-height:100vh;padding-bottom:var(--nav-height);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;overflow-x:hidden}
        .tab-content-wrapper{display:none;animation:fadeIn .3s ease-in}
        .tab-content-wrapper.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .app-container{max-width:600px;margin:0 auto;padding:20px 16px}
        .custom-card{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-radius:16px;box-shadow:0 2px 16px rgba(0,0,0,.06);padding:20px;margin-bottom:16px;border:1px solid rgba(0,0,0,.04)}
        .user-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:16px;border-bottom:1px solid var(--gray-200)}
        .user-info{display:flex;align-items:center;gap:12px}
        .user-avatar{width:48px;height:48px;background:linear-gradient(135deg,var(--primary) 0%,#0284c7 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 4px 12px rgba(74,144,226,.3);overflow:hidden;cursor:pointer}
        .user-avatar img{width:100%;height:100%;object-fit:cover}
        .user-details h5{margin:0;font-size:16px;font-weight:700;color:var(--gray-900)}
        .role-badge{display:inline-block;padding:4px 12px;background:linear-gradient(135deg,#cffafe 0%,#a5f3fc 100%);color:#0369a1;border-radius:12px;font-size:12px;font-weight:600}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:var(--nav-height);background:rgba(255,255,255,.98);backdrop-filter:blur(20px);border-top:1px solid rgba(0,0,0,.06);box-shadow:0 -2px 16px rgba(0,0,0,.06);display:flex;justify-content:space-around;align-items:center;z-index:1000}
        .nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;height:100%;color:var(--gray-600);text-decoration:none;transition:all .3s;cursor:pointer;user-select:none}
        .nav-item i{font-size:24px;margin-bottom:4px;transition:transform .3s}
        .nav-item span{font-size:11px;font-weight:500}
        .nav-item.active{color:var(--primary)}
        .nav-item.active i{transform:scale(1.1)}
        .comment-section{margin-top:20px}
        .comment-input-wrapper{display:flex;flex-direction:column;gap:12px;margin-bottom:20px}
        .comment-input-row{display:flex;gap:8px}
        .comment-input{flex:1;padding:12px 16px;border:1px solid var(--gray-300);border-radius:24px;font-size:14px;outline:none;transition:all .3s}
        .comment-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(74,144,226,.1)}
        .comment-image-btn{padding:12px;background:white;color:var(--gray-600);border:1px solid var(--gray-300);border-radius:50%;cursor:pointer;transition:all .3s;width:48px;height:48px;display:flex;align-items:center;justify-content:center}
        .comment-image-btn:hover{background:var(--gray-100);color:var(--primary)}
        .comment-image-btn.active{background:var(--primary);color:white}
        .comment-submit-btn{padding:12px 24px;background:var(--primary);color:white;border:none;border-radius:24px;font-weight:600;cursor:pointer;transition:all .3s}
        .comment-submit-btn:hover{background:#357abd;transform:scale(1.05)}
        .comment-image-preview{width:100%;max-height:200px;border-radius:12px;object-fit:cover;margin-top:8px}
        .comment-image-preview-wrapper{position:relative;display:inline-block}
        .comment-image-remove{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.7);color:white;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .reply-input-wrapper{margin-left:52px;margin-top:12px;display:none}
        .reply-input-wrapper.active{display:block}
        .comment-list{display:flex;flex-direction:column;gap:16px}
        .comment-item{background:white;border-radius:12px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.05);position:relative}
        .comment-item.new::before{content:'NEW';position:absolute;top:-8px;right:12px;background:#ef4444;color:white;padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700}
        .comment-item.reply{margin-left:52px;background:var(--gray-100);border-left:3px solid var(--primary)}
        .comment-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
        .comment-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--primary) 0%,#0284c7 100%);display:flex;align-items:center;justify-content:center;color:white;font-weight:600;overflow:hidden;cursor:pointer;transition:transform .3s}
        .comment-avatar:hover{transform:scale(1.1)}
        .comment-avatar img{width:100%;height:100%;object-fit:cover}
        .comment-user-info{flex:1}
        .comment-username{font-weight:600;color:var(--gray-900);font-size:14px}
        .comment-time{font-size:12px;color:var(--gray-600)}
        .comment-content{margin-bottom:12px;line-height:1.5;color:var(--gray-900)}
        .comment-image{width:100%;border-radius:8px;margin-bottom:12px;cursor:pointer}
        .comment-actions{display:flex;gap:16px;padding-top:12px;border-top:1px solid var(--gray-200)}
        .comment-action-btn{display:flex;align-items:center;gap:4px;background:none;border:none;color:var(--gray-600);cursor:pointer;font-size:14px;transition:all .3s}
        .comment-action-btn:hover{color:var(--primary)}
        .comment-action-btn.liked{color:#ef4444}
        .pagination-wrapper{display:flex;justify-content:center;margin-top:24px}
        .pagination{display:flex;gap:8px}
        .page-btn{padding:8px 12px;border:1px solid var(--gray-300);background:white;border-radius:8px;cursor:pointer;transition:all .3s}
        .page-btn:hover{background:var(--gray-100)}
        .page-btn.active{background:var(--primary);color:white;border-color:var(--primary)}
        .medicine-buttons{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
        .medicine-btn{padding:32px 16px;border:2px solid var(--gray-300);background:white;border-radius:16px;cursor:pointer;transition:all .3s;text-align:center}
        .medicine-btn:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.1)}
        .medicine-btn.taken{background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 100%);border-color:var(--success)}
        .medicine-btn.disabled{opacity:.6;cursor:not-allowed}
        .medicine-icon{font-size:48px;margin-bottom:12px}
        .medicine-label{font-size:18px;font-weight:700;margin-bottom:8px;color:var(--gray-900)}
        .medicine-status{font-size:14px;color:var(--gray-600)}
        .calendar-wrapper{margin-top:20px}
        .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .calendar-title{font-size:18px;font-weight:700}
        .calendar-nav-btn{padding:8px 12px;background:white;border:1px solid var(--gray-300);border-radius:8px;cursor:pointer;transition:all .3s}
        .calendar-nav-btn:hover{background:var(--gray-100)}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
        .calendar-day-header{text-align:center;font-size:12px;font-weight:600;color:var(--gray-600);padding:8px 0}
        .calendar-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:white;border-radius:8px;cursor:pointer;transition:all .3s;position:relative}
        .calendar-day:hover{background:var(--gray-100)}
        .calendar-day.today{background:var(--primary);color:white}
        .calendar-day.has-record::after{content:'';position:absolute;bottom:4px;width:6px;height:6px;background:var(--success);border-radius:50%}
        .meal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
        .meal-item{aspect-ratio:1;background:white;border-radius:12px;padding:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;border:2px dashed var(--gray-300)}
        .meal-item:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(0,0,0,.1)}
        .meal-item.has-image{border:2px solid var(--success);padding:0;overflow:hidden}
        .meal-item img{width:100%;height:100%;object-fit:cover}
        .meal-placeholder{font-size:32px;margin-bottom:8px}
        .meal-label{font-size:12px;font-weight:600;color:var(--gray-600)}
        .settings-list{display:flex;flex-direction:column;gap:12px}
        .settings-item{background:white;border-radius:12px;padding:16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:all .3s}
        .settings-item:hover{background:var(--gray-100)}
        .settings-item-content{display:flex;align-items:center;gap:12px}
        .settings-item-icon{font-size:24px;color:var(--primary)}
        .settings-item-text h6{margin:0;font-size:16px;font-weight:600}
        .settings-item-text p{margin:0;font-size:12px;color:var(--gray-600)}
        .empty-state{text-align:center;padding:60px 20px}
        .empty-state-icon{font-size:64px;color:var(--gray-300);margin-bottom:16px}
        .empty-state-title{font-size:18px;font-weight:700;color:var(--gray-600);margin-bottom:8px}
        .empty-state-text{font-size:14px;color:var(--gray-600)}
        .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.75);z-index:2000;align-items:center;justify-content:center;animation:fadeIn .3s}
        .modal-overlay.active{display:flex}
        .modal-content{background:white;border-radius:16px;padding:24px;max-width:90%;max-height:90vh;overflow:auto;animation:slideUp .3s}
        @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .modal-title{font-size:20px;font-weight:700}
        .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--gray-600)}
        .modal-image{width:100%;border-radius:12px}
        .loading{text-align:center;padding:20px}
        .loading-spinner{width:40px;height:40px;border:4px solid var(--gray-200);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
        @keyframes spin{to{transform:rotate(360deg)}}
        .toast-container{position:fixed;top:20px;right:20px;z-index:3000}
        .toast{background:white;border-radius:12px;padding:16px 24px;box-shadow:0 4px 16px rgba(0,0,0,.2);margin-bottom:12px;animation:slideInRight .3s}
        @keyframes slideInRight{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
        .toast.success{border-left:4px solid var(--success)}
        .toast.error{border-left:4px solid var(--danger)}
        .toast.info{border-left:4px solid var(--info)}
        @media (max-width:480px){.app-container{padding:16px 12px}.custom-card{padding:16px}}
        .switch{position:relative;display:inline-block;width:51px;height:28px}
        .switch input{opacity:0;width:0;height:0}
        .switch-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--gray-300);transition:.4s;border-radius:28px}
        .switch-slider:before{position:absolute;content:"";height:20px;width:20px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}
        input:checked+.switch-slider{background-color:var(--success)}
        input:checked+.switch-slider:before{transform:translateX(23px)}
        .points-display{text-align:center;padding:24px 16px;margin:16px 0;background:linear-gradient(135deg,#fef3c7 0%,#fde68a 50%,#fcd34d 100%);border-radius:16px;box-shadow:0 4px 12px rgba(252,211,77,.3);position:relative;overflow:hidden}
        .points-display::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.3) 0%,transparent 70%);animation:shimmer 3s infinite}
        @keyframes shimmer{0%,100%{transform:translate(-50%,-50%) rotate(0deg)}50%{transform:translate(-50%,-50%) rotate(180deg)}}
        .points-label{font-size:14px;font-weight:600;color:#92400e;margin-bottom:12px;position:relative;z-index:1}
        .points-content{display:flex;align-items:center;justify-content:center;gap:12px;position:relative;z-index:1}
        .points-icon{font-size:48px;color:#fbbf24;filter:drop-shadow(0 2px 4px rgba(251,191,36,.4));animation:bounce 2s infinite}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
        .points-value{font-size:36px;font-weight:900;color:#78350f;text-shadow:2px 2px 4px rgba(120,53,15,.2)}
        .points-unit{font-size:24px;font-weight:700;color:#92400e;margin-left:4px}
        .point-items-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
        .point-item-card{background:white;border-radius:16px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);transition:all .3s;cursor:pointer;border:2px solid transparent}
        .point-item-card:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.15);border-color:var(--primary)}
        .point-item-card.disabled{opacity:.6;cursor:not-allowed}
        .point-item-card.disabled:hover{transform:none;box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .point-item-icon-wrapper{width:64px;height:64px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:32px;margin-bottom:16px}
        .point-item-name{font-size:18px;font-weight:700;margin-bottom:8px;color:var(--gray-900)}
        .point-item-desc{font-size:14px;color:var(--gray-600);margin-bottom:16px;min-height:40px}
        .point-item-price{display:flex;align-items:center;gap:8px;padding-top:16px;border-top:1px solid var(--gray-200)}
        .point-item-price-value{font-size:24px;font-weight:900;color:var(--primary)}
        .point-item-price-unit{font-size:16px;font-weight:600;color:var(--gray-600)}
        .expected-points-display{background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 100%);border-radius:16px;padding:20px;margin-bottom:20px;border:2px solid #86efac}
        .expected-points-label{font-size:14px;font-weight:600;color:#166534;margin-bottom:8px}
        .expected-points-value{font-size:28px;font-weight:900;color:#15803d}
    </style>
</head>
<body>
<div id="homeTab" class="tab-content-wrapper active">
    <div class="app-container">
        <div class="custom-card">
            <div th:if="${user.role.name() == 'FATHER'}" class="expected-points-display" id="expectedPointsDisplay">
                <div class="expected-points-label">ğŸ’š ë‚´ì¼ ì ë¦½ ì˜ˆì • í¬ì¸íŠ¸</div>
                <div class="expected-points-value" id="expectedPointsValue">ê³„ì‚° ì¤‘...</div>
            </div>
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar" id="headerUserAvatar"
                         th:data-profile-image="${user.profileImage}"
                         th:data-display-name="${user.displayName}"
                         onclick="showProfileModalFromData(this)">
                        <img th:if="${user.profileImage!=null}" th:src="${user.profileImage}" alt="í”„ë¡œí•„">
                        <span th:if="${user.profileImage==null}" th:text="${user.displayName!=null?user.displayName.substring(0,1):user.username.substring(0,1)}"></span>
                    </div>
                    <div class="user-details">
                        <h5 th:text="${user.displayName!=null?user.displayName:user.username}">ì‚¬ìš©ì</h5>
                        <span class="role-badge" th:text="${user.role.displayName}">ì—­í• </span>
                    </div>
                </div>
            </div>
            <div class="points-display">
                <div class="points-label">ì›”ê³¡ì•„ë²„ë‹˜ì´ ëª¨ì€í¬ì¸íŠ¸ëŠ”?</div>
                <div class="points-content">
                    <i class="bi bi-trophy-fill points-icon"></i>
                    <div>
                        <span class="points-value" id="userPoints" th:text="${user.points != null ? user.points : 0}">0</span>
                        <span class="points-unit">P</span>
                    </div>
                </div>
            </div>
            <div class="comment-section">
                <h6 style="margin-bottom:16px;font-weight:700"><i class="bi bi-chat-heart"></i> ì‘ì› ë©”ì‹œì§€</h6>
                <div class="comment-input-wrapper">
                    <div class="comment-input-row">
                        <input type="text" id="commentInput" class="comment-input" placeholder="ì‘ì› ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”...">
                        <input type="file" id="commentImageInput" accept="image/*" style="display:none" onchange="handleCommentImageSelect(event)">
                        <button class="comment-image-btn" onclick="document.getElementById('commentImageInput').click()" title="ì´ë¯¸ì§€ ì²¨ë¶€">
                            <i class="bi bi-image"></i>
                        </button>
                        <button class="comment-submit-btn" onclick="submitComment()"><i class="bi bi-send-fill"></i></button>
                    </div>
                    <div id="commentImagePreviewWrapper" class="comment-image-preview-wrapper" style="display:none">
                        <img id="commentImagePreview" class="comment-image-preview">
                        <button class="comment-image-remove" onclick="removeCommentImage()"><i class="bi bi-x"></i></button>
                    </div>
                </div>
                <div class="comment-list" id="commentList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p style="margin-top:12px;color:var(--gray-600)">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
                <div class="pagination-wrapper" id="commentPagination"></div>
            </div>
        </div>
    </div>
</div>
<div id="medicineTab" class="tab-content-wrapper">
    <div class="app-container">
        <div class="custom-card">
            <h5 style="margin-bottom:20px;font-weight:700"><i class="bi bi-capsule"></i> ì˜¤ëŠ˜ì˜ ì•½ ë³µìš©</h5>
            <div class="medicine-buttons">
                <div class="medicine-btn" id="morningBtn" th:classappend="${!canTakeMedicine}?'disabled'" th:onclick="${canTakeMedicine}?'toggleMedicine(\'MORNING\')':''">
                    <div class="medicine-icon">ğŸŒ…</div>
                    <div class="medicine-label">ì•„ì¹¨</div>
                    <div class="medicine-status" id="morningStatus">
                        <span th:text="${morningRecord.taken}?'ë³µìš©ì™„ë£Œ':'ë¯¸ë³µìš©'">ë¯¸ë³µìš©</span>
                    </div>
                </div>
                <div class="medicine-btn" id="eveningBtn" th:classappend="${!canTakeMedicine}?'disabled'" th:onclick="${canTakeMedicine}?'toggleMedicine(\'EVENING\')':''">
                    <div class="medicine-icon">ğŸŒ™</div>
                    <div class="medicine-label">ì €ë…</div>
                    <div class="medicine-status" id="eveningStatus">
                        <span th:text="${eveningRecord.taken}?'ë³µìš©ì™„ë£Œ':'ë¯¸ë³µìš©'">ë¯¸ë³µìš©</span>
                    </div>
                </div>
            </div>
            <div class="calendar-wrapper">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="changeMonth(-1)"><i class="bi bi-chevron-left"></i></button>
                    <div class="calendar-title" id="calendarTitle">2025ë…„ 1ì›”</div>
                    <button class="calendar-nav-btn" onclick="changeMonth(1)"><i class="bi bi-chevron-right"></i></button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </div>
    </div>
</div>
<div id="mealTab" class="tab-content-wrapper">
    <div class="app-container">
        <div class="custom-card">
            <h5 style="margin-bottom:20px;font-weight:700"><i class="bi bi-egg-fried"></i> ì˜¤ëŠ˜ì˜ ì‹ë‹¨</h5>
            <div class="meal-grid">
                <div class="meal-item" id="breakfastMeal" onclick="uploadMeal('BREAKFAST')">
                    <div class="meal-placeholder">ğŸ³</div>
                    <div class="meal-label">ì•„ì¹¨</div>
                </div>
                <div class="meal-item" id="lunchMeal" onclick="uploadMeal('LUNCH')">
                    <div class="meal-placeholder">ğŸ±</div>
                    <div class="meal-label">ì ì‹¬</div>
                </div>
                <div class="meal-item" id="dinnerMeal" onclick="uploadMeal('DINNER')">
                    <div class="meal-placeholder">ğŸ½ï¸</div>
                    <div class="meal-label">ì €ë…</div>
                </div>
            </div>
            <input type="file" id="mealImageInput" accept="image/*" style="display:none" onchange="handleMealImageUpload()">
            <div id="mealEvaluationSection" style="display:none;margin-top:20px">
                <div class="custom-card" style="background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%)">
                    <h6 style="font-weight:700;margin-bottom:12px"><i class="bi bi-robot"></i> AI ì˜ì–‘ í‰ê°€</h6>
                    <div id="mealEvaluationContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="pointTab" class="tab-content-wrapper">
    <div class="app-container">
        <div class="custom-card">
            <h5 style="margin-bottom:20px;font-weight:700"><i class="bi bi-shop"></i> í¬ì¸íŠ¸ ìƒì </h5>
            <div class="points-display" style="margin-bottom:24px">
                <div class="points-label">ë³´ìœ  í¬ì¸íŠ¸</div>
                <div class="points-content">
                    <i class="bi bi-trophy-fill points-icon"></i>
                    <div>
                        <span class="points-value" id="currentPoints" th:text="${user.points != null ? user.points : 0}">0</span>
                        <span class="points-unit">pt</span>
                    </div>
                </div>
            </div>
            <div class="point-items-grid" id="pointItemsGrid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p style="margin-top:12px;color:var(--gray-600)">ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="settingsTab" class="tab-content-wrapper">
    <div class="app-container">
        <div class="custom-card">
            <h5 style="margin-bottom:20px;font-weight:700"><i class="bi bi-gear"></i> ì„¤ì •</h5>
            <div class="settings-list">
                <div class="settings-item" onclick="showProfileSettings()">
                    <div class="settings-item-content">
                        <div class="settings-item-icon"><i class="bi bi-person-circle"></i></div>
                        <div class="settings-item-text">
                            <h6>í”„ë¡œí•„ ë³€ê²½</h6>
                            <p>í”„ë¡œí•„ ì‚¬ì§„ ë° í‘œì‹œ ì´ë¦„ ë³€ê²½</p>
                        </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
                <div class="settings-item" onclick="showPasswordSettings()">
                    <div class="settings-item-content">
                        <div class="settings-item-icon"><i class="bi bi-shield-lock"></i></div>
                        <div class="settings-item-text">
                            <h6>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h6>
                            <p>ê³„ì • ë³´ì•ˆì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</p>
                        </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
                <div class="settings-item">
                    <div class="settings-item-content">
                        <div class="settings-item-icon"><i class="bi bi-bell"></i></div>
                        <div class="settings-item-text">
                            <h6>Push ì•Œë¦¼</h6>
                            <p>ì•½ ë³µìš© ì•Œë¦¼ ì„¤ì •</p>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="pushNotificationSwitch" onchange="togglePushNotification()">
                        <span class="switch-slider"></span>
                    </label>
                </div>
                <div class="settings-item" onclick="logout()">
                    <div class="settings-item-content">
                        <div class="settings-item-icon" style="color:var(--danger)"><i class="bi bi-box-arrow-right"></i></div>
                        <div class="settings-item-text">
                            <h6 style="color:var(--danger)">ë¡œê·¸ì•„ì›ƒ</h6>
                            <p>ê³„ì •ì—ì„œ ë¡œê·¸ì•„ì›ƒ</p>
                        </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
            </div>
        </div>
    </div>
</div>
<nav class="bottom-nav">
    <div class="nav-item active" data-tab="homeTab"><i class="bi bi-house-door-fill"></i><span>í™ˆ</span></div>
    <div class="nav-item" data-tab="medicineTab"><i class="bi bi-capsule-pill"></i><span>ì•½ë³µìš©</span></div>
    <div class="nav-item" data-tab="mealTab"><i class="bi bi-egg-fried"></i><span>ì‹ë‹¨ê´€ë¦¬</span></div>
    <div class="nav-item" data-tab="pointTab"><i class="bi bi-trophy"></i><span>í¬ì¸íŠ¸</span></div>
    <div class="nav-item" data-tab="settingsTab"><i class="bi bi-gear"></i><span>ì„¤ì •</span></div>
</nav>
<div class="modal-overlay" id="profileModal" onclick="closeProfileModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title" id="profileModalTitle">í”„ë¡œí•„</div>
            <button class="modal-close" onclick="closeProfileModal()"><i class="bi bi-x"></i></button>
        </div>
        <img class="modal-image" id="profileModalImage" src="" alt="í”„ë¡œí•„">
    </div>
</div>
<div class="modal-overlay" id="profileSettingsModal" onclick="closeModal('profileSettingsModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:400px">
        <div class="modal-header">
            <div class="modal-title">í”„ë¡œí•„ ë³€ê²½</div>
            <button class="modal-close" onclick="closeModal('profileSettingsModal')"><i class="bi bi-x"></i></button>
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">í‘œì‹œ ì´ë¦„</label>
            <input type="text" id="displayNameInput" class="comment-input" style="width:100%" th:value="${user.displayName}" placeholder="í‘œì‹œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">í”„ë¡œí•„ ì‚¬ì§„</label>
            <input type="file" id="profileImageInput" accept="image/*" style="width:100%">
        </div>
        <button class="comment-submit-btn" style="width:100%" onclick="updateProfile()">ì €ì¥</button>
    </div>
</div>
<div class="modal-overlay" id="passwordSettingsModal" onclick="closeModal('passwordSettingsModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:400px">
        <div class="modal-header">
            <div class="modal-title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
            <button class="modal-close" onclick="closeModal('passwordSettingsModal')"><i class="bi bi-x"></i></button>
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="currentPassword" class="comment-input" style="width:100%" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸">
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="newPassword" class="comment-input" style="width:100%" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="confirmPassword" class="comment-input" style="width:100%" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
        </div>
        <button class="comment-submit-btn" style="width:100%" onclick="updatePassword()">ë³€ê²½</button>
    </div>
</div>
<div class="toast-container" id="toastContainer"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const currentUserId='[[${user.id}]]';
const canTakeMedicine=[[${canTakeMedicine}]];
let currentTab='homeTab',currentPage=1,commentsPerPage=10,allComments=[],currentMealType=null,currentCalendarDate=new Date();
document.addEventListener('DOMContentLoaded',function(){initializeNavigation();loadComments();initializeMedicineStatus();initializeCalendar();initializeMealStatus();checkPushNotificationStatus();calculateExpectedPoints()});
function initializeNavigation(){document.querySelectorAll('.nav-item').forEach(item=>{item.addEventListener('click',function(){switchTab(this.getAttribute('data-tab'))})})}
function switchTab(tabId){document.querySelectorAll('.tab-content-wrapper').forEach(tab=>tab.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(item=>item.classList.remove('active'));document.getElementById(tabId).classList.add('active');document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');currentTab=tabId;if(tabId==='medicineTab'){initializeCalendar()}else if(tabId==='mealTab'){initializeMealStatus()}else if(tabId==='pointTab'){loadPointItems()}}
async function loadComments(){try{const response=await fetch('/api/comments');allComments=await response.json();renderComments()}catch(error){console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:',error);showToast('ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
let commentImageData=null;
function handleCommentImageSelect(event){const file=event.target.files[0];if(!file)return;if(file.size>5*1024*1024){showToast('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.','error');return}const reader=new FileReader();reader.onload=function(e){commentImageData=e.target.result;document.getElementById('commentImagePreview').src=commentImageData;document.getElementById('commentImagePreviewWrapper').style.display='block';document.querySelector('.comment-image-btn').classList.add('active')};reader.readAsDataURL(file)}
function removeCommentImage(){commentImageData=null;document.getElementById('commentImageInput').value='';document.getElementById('commentImagePreviewWrapper').style.display='none';document.querySelector('.comment-image-btn').classList.remove('active')}
function showReplyInput(commentId){const existingReplyWrapper=document.querySelector('.reply-input-wrapper.active');if(existingReplyWrapper)existingReplyWrapper.remove();const replyHtml=`<div class="reply-input-wrapper active" id="reply-${commentId}"><div class="comment-input-row"><input type="text" id="replyInput-${commentId}" class="comment-input" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."><button class="comment-submit-btn" onclick="submitReply(${commentId})"><i class="bi bi-send-fill"></i></button><button class="comment-submit-btn" style="background:var(--gray-600)" onclick="cancelReply(${commentId})">ì·¨ì†Œ</button></div></div>`;const commentEl=document.querySelector(`[data-comment-id="${commentId}"]`);if(commentEl){commentEl.insertAdjacentHTML('afterend',replyHtml);document.getElementById(`replyInput-${commentId}`).focus()}}
function cancelReply(commentId){const replyWrapper=document.getElementById(`reply-${commentId}`);if(replyWrapper)replyWrapper.remove()}
async function submitReply(parentCommentId){const input=document.getElementById(`replyInput-${parentCommentId}`);const content=input.value.trim();if(!content){showToast('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');return}try{const response=await fetch('/api/comments',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content,parentCommentId})});if(response.ok){input.value='';showToast('ë‹µê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.','success');cancelReply(parentCommentId);await loadComments()}else throw new Error('ë‹µê¸€ ë“±ë¡ ì‹¤íŒ¨')}catch(error){console.error('ë‹µê¸€ ë“±ë¡ ì‹¤íŒ¨:',error);showToast('ë‹µê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function renderComments(){const commentList=document.getElementById('commentList');const parentComments=allComments.filter(c=>!c.parentComment);const totalPages=Math.ceil(parentComments.length/commentsPerPage);const startIndex=(currentPage-1)*commentsPerPage;const pageComments=parentComments.slice(startIndex,startIndex+commentsPerPage);if(!pageComments.length){commentList.innerHTML='<div class="empty-state"><div class="empty-state-icon"><i class="bi bi-chat"></i></div><div class="empty-state-title">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div><div class="empty-state-text">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div></div>';return}const oneDayAgo=new Date(Date.now()-864e5);let html='';pageComments.forEach(comment=>{const createdAt=new Date(comment.createdAt);const isNew=createdAt>oneDayAgo;html+=`<div class="comment-item ${isNew?'new':''}" data-comment-id="${comment.id}"><div class="comment-header"><div class="comment-avatar" onclick="showProfileModal('${comment.user?.profileImage||''}','${comment.user?.displayName||''}')">${comment.user?.profileImage?`<img src="${comment.user.profileImage}" alt="${comment.user.displayName}">`:comment.user?.displayName?.substring(0,1)||'U'}</div><div class="comment-user-info"><div class="comment-username">${comment.user?.displayName||'ì‚¬ìš©ì'}</div><div class="comment-time">${formatTimeAgo(createdAt)}</div></div></div><div class="comment-content">${escapeHtml(comment.content)}</div>${comment.imageUrl?`<img class="comment-image" src="${comment.imageUrl}" onclick="showImageModal('${comment.imageUrl}')">`:''}<div class="comment-actions"><button class="comment-action-btn ${comment.likedUserIds&&comment.likedUserIds.includes(parseInt(currentUserId))?'liked':''}" onclick="toggleLike(${comment.id})"><i class="bi bi-heart-fill"></i><span>${comment.likesCount||0}</span></button><button class="comment-action-btn" onclick="showReplyInput(${comment.id})"><i class="bi bi-reply-fill"></i> ë‹µê¸€</button></div></div>`;const replies=allComments.filter(r=>r.parentComment&&r.parentComment.id===comment.id);replies.forEach(reply=>{const replyCreatedAt=new Date(reply.createdAt);const replyIsNew=replyCreatedAt>oneDayAgo;html+=`<div class="comment-item reply ${replyIsNew?'new':''}" data-comment-id="${reply.id}"><div class="comment-header"><div class="comment-avatar" onclick="showProfileModal('${reply.user?.profileImage||''}','${reply.user?.displayName||''}')">${reply.user?.profileImage?`<img src="${reply.user.profileImage}" alt="${reply.user.displayName}">`:reply.user?.displayName?.substring(0,1)||'U'}</div><div class="comment-user-info"><div class="comment-username">${reply.user?.displayName||'ì‚¬ìš©ì'}</div><div class="comment-time">${formatTimeAgo(replyCreatedAt)}</div></div></div><div class="comment-content">${escapeHtml(reply.content)}</div>${reply.imageUrl?`<img class="comment-image" src="${reply.imageUrl}" onclick="showImageModal('${reply.imageUrl}')">`:''}<div class="comment-actions"><button class="comment-action-btn ${reply.likedUserIds&&reply.likedUserIds.includes(parseInt(currentUserId))?'liked':''}" onclick="toggleLike(${reply.id})"><i class="bi bi-heart-fill"></i><span>${reply.likesCount||0}</span></button></div></div>`})});commentList.innerHTML=html;renderPagination(totalPages)}
function renderPagination(totalPages){const paginationWrapper=document.getElementById('commentPagination');if(totalPages<=1){paginationWrapper.innerHTML='';return}let html='<div class="pagination">';if(currentPage>1)html+=`<button class="page-btn" onclick="changePage(${currentPage-1})"><i class="bi bi-chevron-left"></i></button>`;for(let i=1;i<=totalPages;i++){if(i===1||i===totalPages||(i>=currentPage-1&&i<=currentPage+1))html+=`<button class="page-btn ${i===currentPage?'active':''}" onclick="changePage(${i})">${i}</button>`;else if(i===currentPage-2||i===currentPage+2)html+='<span style="padding:8px">...</span>'}if(currentPage<totalPages)html+=`<button class="page-btn" onclick="changePage(${currentPage+1})"><i class="bi bi-chevron-right"></i></button>`;paginationWrapper.innerHTML=html+'</div>'}
function changePage(page){currentPage=page;renderComments();window.scrollTo({top:0,behavior:'smooth'})}
async function submitComment(){const input=document.getElementById('commentInput');const content=input.value.trim();if(!content){showToast('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');return}try{const response=await fetch('/api/comments',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content,imageData:commentImageData})});if(response.ok){input.value='';removeCommentImage();showToast('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.','success');await loadComments()}else throw new Error('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨')}catch(error){console.error('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:',error);showToast('ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function toggleLike(commentId){try{const response=await fetch(`/api/comments/${commentId}/like`,{method:'POST'});if(response.ok)await loadComments();else throw new Error('ì¢‹ì•„ìš” ì‹¤íŒ¨')}catch(error){console.error('ì¢‹ì•„ìš” ì‹¤íŒ¨:',error);showToast('ì¢‹ì•„ìš”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function initializeMedicineStatus(){const morningTaken=[[${morningRecord.taken}]];const eveningTaken=[[${eveningRecord.taken}]];if(morningTaken)document.getElementById('morningBtn').classList.add('taken');if(eveningTaken)document.getElementById('eveningBtn').classList.add('taken')}
async function toggleMedicine(type){if(!canTakeMedicine){showToast('ì•½ ë³µìš© ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.','error');return}const btn=type==='MORNING'?document.getElementById('morningBtn'):document.getElementById('eveningBtn');const isTaken=btn.classList.contains('taken');try{const response=await fetch(isTaken?'/api/medicine/cancel':'/api/medicine/take',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:`medicineType=${type}`});if(response.ok){btn.classList.toggle('taken');document.getElementById(type.toLowerCase()+'Status').textContent=isTaken?'ë¯¸ë³µìš©':'ë³µìš©ì™„ë£Œ';showToast(isTaken?'ì•½ ë³µìš©ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.':'ì•½ ë³µìš©ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.','success')}else throw new Error('ì•½ ë³µìš© ì²˜ë¦¬ ì‹¤íŒ¨')}catch(error){console.error('ì•½ ë³µìš© ì²˜ë¦¬ ì‹¤íŒ¨:',error);showToast('ì•½ ë³µìš© ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function initializeCalendar(){renderCalendar()}
function renderCalendar(){const year=currentCalendarDate.getFullYear(),month=currentCalendarDate.getMonth();document.getElementById('calendarTitle').textContent=`${year}ë…„ ${month+1}ì›”`;const firstDay=new Date(year,month,1).getDay(),daysInMonth=new Date(year,month+1,0).getDate(),today=new Date();let html='';['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(day=>html+=`<div class="calendar-day-header">${day}</div>`);for(let i=0;i<firstDay;i++)html+='<div></div>';for(let day=1;day<=daysInMonth;day++){const date=new Date(year,month,day);html+=`<div class="calendar-day ${date.toDateString()===today.toDateString()?'today':''}" onclick="selectDate('${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}')">${day}</div>`}document.getElementById('calendarGrid').innerHTML=html}
function changeMonth(delta){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+delta);renderCalendar()}
function selectDate(dateStr){showToast(`${dateStr} ì„ íƒë¨`,'info')}
async function initializeMealStatus(){try{const today=new Date().toISOString().split('T')[0];const response=await fetch(`/api/meals/date/${today}`);const meals=await response.json();meals.forEach(meal=>{const mealElement=document.getElementById(meal.mealType.toLowerCase()+'Meal');if(mealElement&&meal.imageUrl){mealElement.classList.add('has-image');mealElement.innerHTML=`<img src="${meal.imageUrl}" alt="${meal.mealType}">`}})}catch(error){console.error('ì‹ë‹¨ ì¡°íšŒ ì‹¤íŒ¨:',error)}}
function uploadMeal(mealType){currentMealType=mealType;document.getElementById('mealImageInput').click()}
async function handleMealImageUpload(){const input=document.getElementById('mealImageInput'),file=input.files[0];if(!file)return;const formData=new FormData();formData.append('file',file);formData.append('mealType',currentMealType);try{showToast('ì‹ë‹¨ì„ ì—…ë¡œë“œí•˜ëŠ” ì¤‘...','info');const response=await fetch('/api/meals/upload',{method:'POST',body:formData});if(response.ok){const result=await response.json();showToast('ì‹ë‹¨ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.','success');await initializeMealStatus();if(result.aiEvaluation){document.getElementById('mealEvaluationSection').style.display='block';document.getElementById('mealEvaluationContent').innerHTML=`<p style="margin:0;line-height:1.6">${escapeHtml(result.aiEvaluation)}</p>${result.score?`<p style="margin-top:12px;font-weight:700;color:var(--primary)">ì ìˆ˜: ${result.score}ì </p>`:''}`}}else throw new Error('ì‹ë‹¨ ì—…ë¡œë“œ ì‹¤íŒ¨')}catch(error){console.error('ì‹ë‹¨ ì—…ë¡œë“œ ì‹¤íŒ¨:',error);showToast('ì‹ë‹¨ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}input.value=''}
function showProfileSettings(){document.getElementById('profileSettingsModal').classList.add('active')}
function showPasswordSettings(){document.getElementById('passwordSettingsModal').classList.add('active')}
async function updateProfile(){const displayName=document.getElementById('displayNameInput').value.trim(),file=document.getElementById('profileImageInput').files[0],formData=new FormData();if(displayName)formData.append('displayName',displayName);if(file)formData.append('profileImage',file);try{const response=await fetch('/api/profile/update',{method:'POST',body:formData});if(response.ok){showToast('í”„ë¡œí•„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.','success');closeModal('profileSettingsModal');setTimeout(()=>location.reload(),1e3)}else throw new Error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨')}catch(error){console.error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:',error);showToast('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function updatePassword(){const currentPassword=document.getElementById('currentPassword').value,newPassword=document.getElementById('newPassword').value,confirmPassword=document.getElementById('confirmPassword').value;if(!currentPassword||!newPassword||!confirmPassword){showToast('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');return}if(newPassword!==confirmPassword){showToast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.','error');return}try{const response=await fetch('/api/profile/password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({currentPassword,newPassword})});if(response.ok){showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.','success');closeModal('passwordSettingsModal');document.getElementById('currentPassword').value='';document.getElementById('newPassword').value='';document.getElementById('confirmPassword').value=''}else throw new Error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨')}catch(error){console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨:',error);showToast('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function checkPushNotificationStatus(){}
async function togglePushNotification(){const isEnabled=document.getElementById('pushNotificationSwitch').checked;showToast(isEnabled?'Push ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.':'Push ì•Œë¦¼ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.','success')}
function logout(){if(confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))location.href='/logout'}
function showProfileModal(imageUrl,displayName){if(!imageUrl){showToast('í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.','info');return}document.getElementById('profileModalTitle').textContent=displayName||'í”„ë¡œí•„';document.getElementById('profileModalImage').src=imageUrl;document.getElementById('profileModal').classList.add('active')}
function showProfileModalFromData(element){const imageUrl=element.getAttribute('data-profile-image');const displayName=element.getAttribute('data-display-name');showProfileModal(imageUrl,displayName)}
function closeProfileModal(){document.getElementById('profileModal').classList.remove('active')}
function closeModal(modalId){document.getElementById(modalId).classList.remove('active')}
function showToast(message,type='info'){const container=document.getElementById('toastContainer'),toast=document.createElement('div');toast.className=`toast ${type}`;toast.innerHTML=`<i class="bi bi-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i><span style="margin-left:8px">${message}</span>`;container.appendChild(toast);setTimeout(()=>toast.remove(),3e3)}
function formatTimeAgo(date){const seconds=Math.floor((new Date()-date)/1e3);if(seconds<60)return'ë°©ê¸ˆ ì „';if(seconds<3600)return`${Math.floor(seconds/60)}ë¶„ ì „`;if(seconds<86400)return`${Math.floor(seconds/3600)}ì‹œê°„ ì „`;if(seconds<604800)return`${Math.floor(seconds/86400)}ì¼ ì „`;return date.toLocaleDateString('ko-KR')}
function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML}
async function loadPointItems(){try{const response=await fetch('/api/points/items');const items=await response.json();renderPointItems(items)}catch(error){console.error('í¬ì¸íŠ¸ ì•„ì´í…œ ë¡œë“œ ì‹¤íŒ¨:',error);document.getElementById('pointItemsGrid').innerHTML='<div class="empty-state"><div class="empty-state-icon"><i class="bi bi-exclamation-triangle"></i></div><div class="empty-state-title">ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨</div></div>'}}
function renderPointItems(items){const grid=document.getElementById('pointItemsGrid');const userRole='[[${user.role.name()}]]';const isFather=userRole==='FATHER';if(!items||items.length===0){grid.innerHTML='<div class="empty-state"><div class="empty-state-icon"><i class="bi bi-shop"></i></div><div class="empty-state-title">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div></div>';return}grid.innerHTML=items.map(item=>{const canPurchase=isFather&&item.available&&parseInt(document.getElementById('currentPoints').textContent)>=item.points;return`<div class="point-item-card ${canPurchase?'':'disabled'}" onclick="${canPurchase?`purchaseItem(${item.id})`:''}"><div class="point-item-icon-wrapper" style="background:${item.color||'#e5e7eb'}">${item.icon?`<i class="bi bi-${item.icon}"></i>`:'ğŸ'}</div><div class="point-item-name">${item.name}</div><div class="point-item-desc">${item.description||''}</div><div class="point-item-price"><span class="point-item-price-value">${item.points}</span><span class="point-item-price-unit">pt</span>${!isFather?'<span style="font-size:12px;color:var(--danger);margin-left:auto">ì•„ë²„ì§€ë§Œ êµ¬ë§¤ ê°€ëŠ¥</span>':''}</div></div>`}).join('')}
async function purchaseItem(itemId){if(!confirm('ì´ ìƒí’ˆì„ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{const response=await fetch(`/api/points/purchase/${itemId}`,{method:'POST'});if(response.ok){const result=await response.json();document.getElementById('currentPoints').textContent=result.remainingPoints;document.getElementById('userPoints').textContent=result.remainingPoints;showToast('ìƒí’ˆì„ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!','success');await loadPointItems()}else{const error=await response.json();showToast(error.message||'êµ¬ë§¤ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}catch(error){console.error('ìƒí’ˆ êµ¬ë§¤ ì‹¤íŒ¨:',error);showToast('ìƒí’ˆ êµ¬ë§¤ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function calculateExpectedPoints(){try{const today=new Date().toISOString().split('T')[0];const [medicineRes,mealRes]=await Promise.all([fetch(`/api/medicine/today`),fetch(`/api/meals/date/${today}`)]);const medicineRecords=await medicineRes.json();const meals=await mealRes.json();let medicinePoints=0;if(medicineRecords.morning&&medicineRecords.morning.taken)medicinePoints+=10;if(medicineRecords.evening&&medicineRecords.evening.taken)medicinePoints+=10;let mealPoints=0;if(meals&&meals.length>0){const avgScore=meals.reduce((sum,m)=>sum+(m.score||0),0)/meals.length;if(avgScore>=80)mealPoints=70;else if(avgScore>=60)mealPoints=50;else if(avgScore>=40)mealPoints=30;else mealPoints=20}const totalExpected=medicinePoints+mealPoints;const expectedEl=document.getElementById('expectedPointsValue');if(expectedEl)expectedEl.textContent=`${totalExpected}pt (ì•½: ${medicinePoints}pt + ì‹ë‹¨: ${mealPoints}pt)`}catch(error){console.error('ì˜ˆìƒ í¬ì¸íŠ¸ ê³„ì‚° ì‹¤íŒ¨:',error);const expectedEl=document.getElementById('expectedPointsValue');if(expectedEl)expectedEl.textContent='ê³„ì‚° ì‹¤íŒ¨'}}
</script>
</body>
</html>
