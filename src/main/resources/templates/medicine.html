<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4A90E2">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ì•½ë³µìš©">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>ì•½ ë³µìš© ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        *{-webkit-tap-highlight-color:transparent;margin:0;padding:0;box-sizing:border-box}
        :root{
            --primary:#4A90E2;--success:#5cb85c;--danger:#d9534f;--warning:#f0ad4e;--info:#5bc0de;
            --gray-100:#f8f9fa;--gray-200:#e9ecef;--gray-300:#dee2e6;--gray-600:#6c757d;--gray-900:#212529;
            --nav-height:65px;
            --bg-gradient-start:#f0f9ff;--bg-gradient-mid:#e0f2fe;--bg-gradient-end:#dbeafe;
            --card-bg:rgba(255,255,255,.95);--card-border:rgba(0,0,0,.04);
            --text-primary:#212529;--text-secondary:#6c757d;
            --white:#ffffff;--hover-bg:#f8f9fa;
        }
        body.dark-mode{
            --primary:#6ba3e8;--success:#72c472;--danger:#e06b67;--warning:#f3ba65;--info:#6fcce4;
            --gray-100:#2a2a2a;--gray-200:#3a3a3a;--gray-300:#4a4a4a;--gray-600:#b0b0b0;--gray-900:#e5e5e5;
            --bg-gradient-start:#0f1419;--bg-gradient-mid:#1a1f26;--bg-gradient-end:#141922;
            --card-bg:rgba(30,35,42,.95);--card-border:rgba(255,255,255,.08);
            --text-primary:#e5e5e5;--text-secondary:#b0b0b0;
            --white:#1e232a;--hover-bg:#2a2a2a;
        }
        body{
            background:linear-gradient(135deg,var(--bg-gradient-start) 0%,var(--bg-gradient-mid) 40%,var(--bg-gradient-end) 100%);
            min-height:100vh;padding-bottom:var(--nav-height);
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Helvetica,Arial,sans-serif;overflow-x:hidden;
            color:var(--text-primary);transition:background .3s,color .3s;
        }
        .tab-content-wrapper{display:none;animation:fadeIn .3s ease-in}
        .tab-content-wrapper.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .app-container{max-width:600px;margin:0 auto;padding:20px 16px}
        .custom-card{background:var(--card-bg);backdrop-filter:blur(20px);border-radius:16px;box-shadow:0 2px 16px rgba(0,0,0,.06);padding:20px;margin-bottom:16px;border:1px solid var(--card-border)}
        .user-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:16px;border-bottom:1px solid var(--gray-200)}
        .user-info{display:flex;align-items:center;gap:12px}
        .user-avatar{width:48px;height:48px;background:linear-gradient(135deg,var(--primary) 0%,#0284c7 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 4px 12px rgba(74,144,226,.3);overflow:hidden;cursor:pointer}
        .user-avatar img{width:100%;height:100%;object-fit:cover}
        .user-details h5{margin:0;font-size:16px;font-weight:700;color:var(--text-primary)}
        .role-badge{display:inline-block;padding:4px 12px;background:linear-gradient(135deg,#cffafe 0%,#a5f3fc 100%);color:#0369a1;border-radius:12px;font-size:12px;font-weight:600}
        body.dark-mode .role-badge{background:linear-gradient(135deg,#164e63 0%,#155e75 100%);color:#a5f3fc}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:var(--nav-height);background:var(--card-bg);backdrop-filter:blur(20px);border-top:1px solid var(--card-border);box-shadow:0 -2px 16px rgba(0,0,0,.06);display:flex;justify-content:space-around;align-items:center;z-index:1000}
        .nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;height:100%;color:var(--gray-600);text-decoration:none;transition:all .3s;cursor:pointer;user-select:none}
        .nav-item i{font-size:24px;margin-bottom:4px;transition:transform .3s}
        .nav-item span{font-size:11px;font-weight:500}
        .nav-item.active{color:var(--primary)}
        .nav-item.active i{transform:scale(1.1)}
        .comment-section{margin-top:20px}
        .comment-input-wrapper{display:flex;flex-direction:column;gap:12px;margin-bottom:20px}
        .comment-input-row{display:flex;gap:8px}
        .comment-input{flex:1;padding:12px 16px;border:1px solid var(--gray-300);border-radius:24px;font-size:14px;outline:none;transition:all .3s;background:var(--white);color:var(--text-primary)}
        .comment-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(74,144,226,.1)}
        .comment-image-btn{padding:12px;background:var(--white);color:var(--text-secondary);border:1px solid var(--gray-300);border-radius:50%;cursor:pointer;transition:all .3s;width:48px;height:48px;display:flex;align-items:center;justify-content:center}
        .comment-image-btn:hover{background:var(--hover-bg);color:var(--primary)}
        .comment-image-btn.active{background:var(--primary);color:white}
        .comment-submit-btn{padding:12px 24px;background:var(--primary);color:white;border:none;border-radius:24px;font-weight:600;cursor:pointer;transition:all .3s}
        .comment-submit-btn:hover{background:#357abd;transform:scale(1.05)}
        .comment-image-preview{width:100%;max-height:200px;border-radius:12px;object-fit:cover;margin-top:8px}
        .comment-image-preview-wrapper{position:relative;display:inline-block}
        .comment-image-remove{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.7);color:white;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .reply-input-wrapper{margin-left:52px;margin-top:12px;display:none}
        .reply-input-wrapper.active{display:block}
        .comment-list{display:flex;flex-direction:column;gap:16px}
        .comment-item{background:var(--white);border-radius:12px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.05);position:relative}
        body.dark-mode .comment-item{box-shadow:0 1px 4px rgba(0,0,0,.3)}
        .comment-item.new::before{content:'NEW';position:absolute;top:-8px;right:12px;background:#ef4444;color:white;padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700}
        .comment-item.reply{margin-left:52px;background:var(--gray-100);border-left:3px solid var(--primary)}
        .comment-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
        .comment-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--primary) 0%,#0284c7 100%);display:flex;align-items:center;justify-content:center;color:white;font-weight:600;overflow:hidden;cursor:pointer;transition:transform .3s;position:relative}
        .comment-avatar:hover{transform:scale(1.1)}
        .comment-avatar img{width:100%;height:100%;object-fit:cover}
        .comment-avatar.rainbow-border::before{content:'';position:absolute;inset:-3px;border-radius:50%;background:linear-gradient(45deg,#ff0000,#ff7f00,#ffff00,#00ff00,#0000ff,#4b0082,#9400d3);animation:rainbow-rotate 3s linear infinite;z-index:-1}
        @keyframes rainbow-rotate{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .comment-user-info{flex:1}
        .comment-username{font-weight:600;color:var(--text-primary);font-size:14px}
        .comment-time{font-size:12px;color:var(--text-secondary)}
        .comment-content{margin-bottom:12px;line-height:1.5;color:var(--text-primary)}
        .comment-image{width:100%;border-radius:8px;margin-bottom:12px;cursor:pointer}
        .comment-actions{display:flex;gap:16px;padding-top:12px;border-top:1px solid var(--gray-200)}
        .comment-action-btn{display:flex;align-items:center;gap:4px;background:none;border:none;color:var(--gray-600);cursor:pointer;font-size:14px;transition:all .3s}
        .comment-action-btn:hover{color:var(--primary)}
        .comment-action-btn.liked{color:#ef4444}
        .pagination-wrapper{display:flex;justify-content:center;margin-top:24px}
        .pagination{display:flex;gap:8px}
        .page-btn{padding:8px 12px;border:1px solid var(--gray-300);background:var(--white);border-radius:8px;cursor:pointer;transition:all .3s}
        .page-btn:hover{background:var(--hover-bg)}
        .page-btn.active{background:var(--primary);color:white;border-color:var(--primary)}
        .medicine-buttons{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
        .medicine-btn{padding:32px 16px;border:2px solid var(--gray-300);background:var(--white);border-radius:16px;cursor:pointer;transition:all .3s;text-align:center}
        .medicine-btn:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.1)}
        .medicine-btn.taken{background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 100%);border-color:var(--success)}
        body.dark-mode .medicine-btn.taken{background:linear-gradient(135deg,#064e3b 0%,#065f46 100%);color:#a7f3d0}
        .medicine-btn.disabled{opacity:.6;cursor:not-allowed}
        .medicine-icon{font-size:48px;margin-bottom:12px}
        .medicine-label{font-size:18px;font-weight:700;margin-bottom:8px;color:var(--text-primary)}
        .medicine-status{font-size:14px;color:var(--text-secondary)}
        .calendar-wrapper{margin-top:20px}
        .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .calendar-title{font-size:18px;font-weight:700;color:var(--text-primary)}
        .calendar-nav-btn{padding:8px 12px;background:var(--white);border:1px solid var(--gray-300);border-radius:8px;cursor:pointer;transition:all .3s}
        .calendar-nav-btn:hover{background:var(--hover-bg)}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
        .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:8px}
        .calendar-weekday{text-align:center;font-size:12px;font-weight:600;color:var(--text-secondary);padding:8px 0}
        .calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
        .calendar-day-header{text-align:center;font-size:12px;font-weight:600;color:var(--text-secondary);padding:8px 0}
        .calendar-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--white);border-radius:8px;cursor:pointer;transition:all .3s;position:relative;color:var(--text-primary)}
        .calendar-day.empty{background:transparent;cursor:default}
        .calendar-day:hover:not(.empty){background:var(--hover-bg)}
        .calendar-day.today{background:var(--primary);color:white}
        .calendar-day.has-record::after{content:'';position:absolute;bottom:4px;width:6px;height:6px;background:var(--success);border-radius:50%}
        .meal-grid{display:grid;grid-template-columns:1fr;gap:16px;margin-bottom:20px}
        .meal-item{aspect-ratio:16/9;background:var(--white);border-radius:12px;padding:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;border:2px dashed var(--gray-300)}
        .meal-item:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(0,0,0,.1)}
        .meal-item.has-image{border:2px solid var(--success);padding:0;overflow:hidden}
        .meal-item img{width:100%;height:100%;object-fit:cover}
        .meal-placeholder{font-size:32px;margin-bottom:8px}
        .meal-label{font-size:12px;font-weight:600;color:var(--text-secondary)}
        .settings-list{display:flex;flex-direction:column;gap:12px}
        .settings-item{background:var(--white);border-radius:12px;padding:16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:all .3s}
        .settings-item:hover{background:var(--hover-bg)}
        .settings-item-content{display:flex;align-items:center;gap:12px}
        .settings-item-icon{font-size:24px;color:var(--primary)}
        .settings-item-text h6{margin:0;font-size:16px;font-weight:600;color:var(--text-primary)}
        .settings-item-text p{margin:0;font-size:12px;color:var(--text-secondary)}
        .empty-state{text-align:center;padding:60px 20px}
        .empty-state-icon{font-size:64px;color:var(--gray-300);margin-bottom:16px}
        .empty-state-title{font-size:18px;font-weight:700;color:var(--text-secondary);margin-bottom:8px}
        .empty-state-text{font-size:14px;color:var(--text-secondary)}
        .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.75);z-index:2000;align-items:center;justify-content:center;animation:fadeIn .3s}
        body.dark-mode .modal-overlay{background:rgba(0,0,0,.85)}
        .modal-overlay.active{display:flex}
        .modal-content{background:var(--card-bg);border-radius:16px;padding:24px;max-width:90%;max-height:90vh;overflow:auto;animation:slideUp .3s;color:var(--text-primary)}
        @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .modal-title{font-size:20px;font-weight:700;color:var(--text-primary)}
        .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-secondary)}
        .modal-image{width:100%;border-radius:12px}
        .loading{text-align:center;padding:20px}
        .loading-spinner{width:40px;height:40px;border:4px solid var(--gray-200);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
        @keyframes spin{to{transform:rotate(360deg)}}
        .toast-container{position:fixed;top:20px;right:20px;z-index:3000}
        .toast{background:var(--card-bg);border-radius:12px;padding:16px 24px;box-shadow:0 4px 16px rgba(0,0,0,.2);margin-bottom:12px;animation:slideInRight .3s;color:var(--text-primary)}
        @keyframes slideInRight{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
        .toast.success{border-left:4px solid var(--success)}
        .toast.error{border-left:4px solid var(--danger)}
        .toast.info{border-left:4px solid var(--info)}
        @media (max-width:480px){.app-container{padding:16px 12px}.custom-card{padding:16px}}
        .switch{position:relative;display:inline-block;width:51px;height:28px}
        .switch input{opacity:0;width:0;height:0}
        .switch-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--gray-300);transition:.4s;border-radius:28px}
        .switch-slider:before{position:absolute;content:"";height:20px;width:20px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}
        input:checked+.switch-slider{background-color:var(--success)}
        input:checked+.switch-slider:before{transform:translateX(23px)}
        .points-display{text-align:center;padding:24px 16px;margin:16px 0;background:linear-gradient(135deg,#fef3c7 0%,#fde68a 50%,#fcd34d 100%);border-radius:16px;box-shadow:0 4px 12px rgba(252,211,77,.3);position:relative;overflow:hidden}
        body.dark-mode .points-display{background:linear-gradient(135deg,#422006 0%,#713f12 50%,#854d0e 100%);box-shadow:0 4px 12px rgba(133,77,14,.3)}
        .points-display::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.3) 0%,transparent 70%);animation:shimmer 3s infinite}
        @keyframes shimmer{0%,100%{transform:translate(-50%,-50%) rotate(0deg)}50%{transform:translate(-50%,-50%) rotate(180deg)}}
        .points-label{font-size:14px;font-weight:600;color:#92400e;margin-bottom:12px;position:relative;z-index:1}
        body.dark-mode .points-label{color:#fef3c7}
        .points-content{display:flex;align-items:center;justify-content:center;gap:12px;position:relative;z-index:1}
        .points-icon{font-size:48px;color:#fbbf24;filter:drop-shadow(0 2px 4px rgba(251,191,36,.4));animation:bounce 2s infinite}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
        .points-value{font-size:36px;font-weight:900;color:#78350f;text-shadow:2px 2px 4px rgba(120,53,15,.2)}
        body.dark-mode .points-value{color:#fde68a;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
        .points-unit{font-size:24px;font-weight:700;color:#92400e;margin-left:4px}
        body.dark-mode .points-unit{color:#fde68a}
        .point-items-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
        .point-item-card{background:var(--white);border-radius:16px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);transition:all .3s;cursor:pointer;border:2px solid transparent}
        body.dark-mode .point-item-card{box-shadow:0 2px 8px rgba(0,0,0,.3)}
        .point-item-card:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.15);border-color:var(--primary)}
        body.dark-mode .point-item-card:hover{box-shadow:0 8px 20px rgba(0,0,0,.5)}
        .point-item-card.disabled{opacity:.6;cursor:not-allowed}
        .point-item-card.disabled:hover{transform:none;box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .point-item-icon-wrapper{width:64px;height:64px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:32px;margin-bottom:16px}
        .point-item-name{font-size:18px;font-weight:700;margin-bottom:8px;color:var(--text-primary)}
        .point-item-desc{font-size:14px;color:var(--text-secondary);margin-bottom:16px;min-height:40px}
        .point-item-price{display:flex;align-items:center;gap:8px;padding-top:16px;border-top:1px solid var(--gray-200)}
        .point-item-price-value{font-size:24px;font-weight:900;color:var(--primary)}
        .point-item-price-unit{font-size:16px;font-weight:600;color:var(--gray-600)}
        .expected-points-display{background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 100%);border-radius:16px;padding:20px;margin-bottom:20px;border:2px solid #86efac}
        body.dark-mode .expected-points-display{background:linear-gradient(135deg,#064e3b 0%,#065f46 100%);border-color:#10b981}
        .expected-points-label{font-size:14px;font-weight:600;color:#166534;margin-bottom:8px}
        body.dark-mode .expected-points-label{color:#d1fae5}
        .expected-points-value{font-size:28px;font-weight:900;color:#15803d}
        body.dark-mode .expected-points-value{color:#6ee7b7}
        .meal-item-wrapper{display:flex;flex-direction:column}
        .meal-evaluation{font-size:13px;color:var(--gray-700);animation:fadeIn .3s ease-in}
        .meal-item img{cursor:pointer;transition:transform .2s}
        .meal-item img:hover{transform:scale(1.05)}
        .comment-delete-btn{background:none;border:none;color:var(--danger);cursor:pointer;padding:4px 8px;border-radius:6px;transition:all .2s;margin-left:auto}
        .comment-delete-btn:hover{background:rgba(217,83,79,.1)}
        .calendar-marker{position:absolute;bottom:2px;left:50%;transform:translateX(-50%);display:flex;gap:2px}
        .marker-dot{width:4px;height:4px;border-radius:50%;background:#10b981}
        .marker-dot.meal{background:#f59e0b}
        @media (max-width:768px){
            .meal-grid{flex-direction:column;gap:16px}
            .meal-item-wrapper{width:100%}
            .meal-item{min-height:120px}
        }
        .home-medicine-status{margin-top:20px}
        .medicine-status-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
        .medicine-status-item{background:var(--white);border-radius:12px;padding:16px;text-align:center;border:2px solid var(--gray-300)}
        .medicine-status-item.taken{background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 100%);border-color:var(--success)}
        body.dark-mode .medicine-status-item.taken{background:linear-gradient(135deg,#064e3b 0%,#065f46 100%)}
        .medicine-status-icon{font-size:32px;margin-bottom:8px}
        .medicine-status-label{font-size:14px;font-weight:600;color:var(--text-primary)}
        .medicine-status-text{font-size:12px;color:var(--text-secondary);margin-top:4px}
        .home-meals-section{margin-top:20px}
        .home-meal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
        .home-meal-item{position:relative;aspect-ratio:1;background:var(--white);border-radius:12px;overflow:hidden;border:2px dashed var(--gray-300)}
        .home-meal-item.has-image{border:2px solid var(--success)}
        .home-meal-item img{width:100%;height:100%;object-fit:cover;cursor:pointer}
        .home-meal-placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--gray-400)}
        .home-meal-placeholder i{font-size:32px;margin-bottom:8px}
        .home-meal-label{font-size:12px;font-weight:600}
        .ai-eval-btn{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);background:rgba(74,144,226,0.9);color:white;border:none;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;cursor:pointer;transition:all .3s;backdrop-filter:blur(10px)}
        .ai-eval-btn:hover{background:rgba(74,144,226,1);transform:translateX(-50%) scale(1.05)}
        .calendar-day-content{position:relative;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center}
        .calendar-score{font-size:10px;font-weight:600;margin-top:2px}
        .calendar-medicine-status{display:flex;gap:2px;margin-top:2px}
        .medicine-dot{width:5px;height:5px;border-radius:50%}
        .medicine-dot.morning{background:#fbbf24}
        .medicine-dot.evening{background:#a78bfa}
        @media (max-width:768px){
            .home-meal-grid{grid-template-columns:1fr;gap:16px}
            .home-meal-item{max-width:100%;aspect-ratio:16/9}
        }
        .dark-mode-toggle{
            width:40px;height:40px;border-radius:50%;background:var(--card-bg);border:2px solid var(--gray-300);
            display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;font-size:20px;
            color:var(--text-primary);
        }
        .dark-mode-toggle:hover{transform:scale(1.1);background:var(--hover-bg)}
        .dark-mode-toggle:active{transform:scale(0.95)}
        body.dark-mode .shop-icon-btn{color:#ffffff;border-color:#4a4a4a}
        body.dark-mode .shop-icon-btn:hover{background:rgba(255,255,255,0.1)}
        .shop-icon-btn{position:relative}
        .shop-icon-btn::before{content:'';position:absolute;inset:-12px;border-radius:50%;z-index:-1}
    </style>
</head>
<body>
<div id="homeTab" class="tab-content-wrapper active">
    <div class="app-container">
        <div class="custom-card">
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar" id="headerUserAvatar"
                         th:data-profile-image="${user.profileImage}"
                         th:data-display-name="${user.displayName}"
                         onclick="showProfileModalFromData(this)">
                        <img th:if="${user.profileImage!=null}" th:src="${user.profileImage}" alt="í”„ë¡œí•„">
                        <span th:if="${user.profileImage==null}" th:text="${user.displayName!=null?user.displayName.substring(0,1):user.username.substring(0,1)}"></span>
                    </div>
                    <div class="user-details">
                        <h5 th:text="${user.displayName!=null?user.displayName:user.username}">ì‚¬ìš©ì</h5>
                        <span class="role-badge" th:text="${user.role.displayName}">ì—­í• </span>
                    </div>
                </div>
                <div class="dark-mode-toggle" onclick="toggleDarkMode()" id="homeDarkModeToggle">
                    <i class="bi bi-moon-fill"></i>
                </div>
            </div>
            <div class="points-display" style="position:relative">
                <div class="points-label">ì›”ê³¡ì•„ë²„ë‹˜ì´ ëª¨ì€í¬ì¸íŠ¸ëŠ”?</div>
                <div class="points-content">
                    <i class="bi bi-trophy-fill points-icon"></i>
                    <div>
                        <span class="points-value" id="userPoints" th:text="${user.points != null ? user.points : 0}">0</span>
                        <span class="points-unit">P</span>
                    </div>
                </div>
                <button class="dark-mode-toggle shop-icon-btn" onclick="openModal('pointShopModal');loadPointShop()" style="position:absolute;top:16px;right:16px" title="í¬ì¸íŠ¸ ìƒì ">
                    <i class="bi bi-shop"></i>
                </button>
            </div>

            <div class="comment-section" style="margin-top:20px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;cursor:pointer" onclick="toggleCommentSection()">
                    <h6 style="font-weight:700;margin:0"><i class="bi bi-chat-heart"></i> ì‘ì› ë©”ì‹œì§€</h6>
                    <i class="bi bi-chevron-down" id="commentToggleIcon" style="font-size:18px;color:var(--primary);transition:transform .3s"></i>
                </div>
                <div id="commentSectionContent" style="display:none">
                <div class="comment-input-wrapper">
                    <div class="comment-input-row">
                        <input type="text" id="commentInput" class="comment-input" placeholder="ì‘ì› ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”...">
                        <input type="file" id="commentImageInput" accept="image/*" style="display:none" onchange="handleCommentImageSelect(event)">
                        <button class="comment-image-btn" onclick="document.getElementById('commentImageInput').click()" title="ì´ë¯¸ì§€ ì²¨ë¶€">
                            <i class="bi bi-image"></i>
                        </button>
                        <button class="comment-submit-btn" onclick="submitComment()"><i class="bi bi-send-fill"></i></button>
                    </div>
                    <div id="commentImagePreviewWrapper" class="comment-image-preview-wrapper" style="display:none">
                        <img id="commentImagePreview" class="comment-image-preview">
                        <button class="comment-image-remove" onclick="removeCommentImage()"><i class="bi bi-x"></i></button>
                    </div>
                </div>
                <div class="comment-list" id="commentList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p style="margin-top:12px;color:var(--gray-600)">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
                <div class="pagination-wrapper" id="commentPagination"></div>
                </div>
            </div>

            <div class="activity-section" style="margin-top:20px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <h6 style="font-weight:700;margin:0"><i class="bi bi-bell-fill"></i> í™œë™ ì•Œë¦¼</h6>
                    <button onclick="markAllActivitiesAsRead()" style="background:none;border:none;color:var(--primary);font-size:13px;cursor:pointer;padding:4px 8px;border-radius:6px;transition:background .2s" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='none'">
                        ëª¨ë‘ ì½ìŒ
                    </button>
                </div>
                <div id="activityList" style="display:flex;flex-direction:column;gap:8px;max-height:400px;overflow-y:auto">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p style="margin-top:12px;color:var(--gray-600)">í™œë™ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>

            <div class="home-daily-section" style="margin-top:20px">
                <h6 style="margin-bottom:16px;font-weight:700"><i class="bi bi-images"></i> ìµœê·¼ ì¼ìƒ</h6>
                <div id="homeRecentDailies" style="display:flex;flex-direction:column;gap:12px">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p style="margin-top:12px;color:var(--gray-600)">ì¼ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="healthTab" class="tab-content-wrapper">
    <div class="app-container">
        <!-- í†µí•© ìº˜ë¦°ë” -->
        <div class="custom-card">
            <h5 style="margin-bottom:20px;font-weight:700"><i class="bi bi-calendar3"></i> ê±´ê°• ìº˜ë¦°ë”</h5>
            <div class="calendar-wrapper">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="changeHealthMonth(-1)"><i class="bi bi-chevron-left"></i></button>
                    <div class="calendar-title" id="healthCalendarTitle">2025ë…„ 1ì›”</div>
                    <button class="calendar-nav-btn" onclick="changeHealthMonth(1)"><i class="bi bi-chevron-right"></i></button>
                </div>
                <div id="healthCalendarGrid"></div>
            </div>
            <div id="healthDayDetails" style="margin-top:20px;display:none"></div>
        </div>

        <!-- ì˜ˆìƒ í¬ì¸íŠ¸ -->
        <div th:if="${user.role.name() == 'FATHER'}" class="expected-points-display" id="healthExpectedPointsDisplay" style="margin-bottom:16px;padding:12px;background:linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%);border-radius:12px">
            <div style="font-size:13px;color:#065f46;font-weight:600;margin-bottom:4px">ğŸ’š ë‚´ì¼ ì ë¦½ ì˜ˆì • í¬ì¸íŠ¸</div>
            <div style="font-size:20px;font-weight:700;color:#047857"><span id="healthExpectedPointsValue">ê³„ì‚° ì¤‘...</span><span style="font-size:14px;margin-left:4px">p</span></div>
        </div>

        <!-- ì•½ë³µìš© ì„¹ì…˜ -->
        <div class="custom-card">
            <h5 style="margin-bottom:20px;font-weight:700"><i class="bi bi-capsule"></i> ì˜¤ëŠ˜ì˜ ì•½ ë³µìš©</h5>
            <div class="medicine-buttons">
                <div class="medicine-btn" id="morningBtn"
                     th:classappend="${morningRecord.taken}?'taken':''"
                     th:data-can-take="${canTakeMedicine}"
                     onclick="handleMedicineClick('MORNING', this)">
                    <div class="medicine-icon">ğŸŒ…</div>
                    <div class="medicine-label">ì•„ì¹¨</div>
                    <div class="medicine-status" id="morningStatus">
                        <span th:text="${morningRecord.taken}?'ë³µìš©ì™„ë£Œ':'ë¯¸ë³µìš©'">ë¯¸ë³µìš©</span>
                    </div>
                </div>
                <div class="medicine-btn" id="eveningBtn"
                     th:classappend="${eveningRecord.taken}?'taken':''"
                     th:data-can-take="${canTakeMedicine}"
                     onclick="handleMedicineClick('EVENING', this)">
                    <div class="medicine-icon">ğŸŒ™</div>
                    <div class="medicine-label">ì €ë…</div>
                    <div class="medicine-status" id="eveningStatus">
                        <span th:text="${eveningRecord.taken}?'ë³µìš©ì™„ë£Œ':'ë¯¸ë³µìš©'">ë¯¸ë³µìš©</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì‹ë‹¨ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="custom-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h5 style="margin:0;font-weight:700"><i class="bi bi-egg-fried"></i> ì˜¤ëŠ˜ì˜ ì‹ë‹¨</h5>
                <div id="dailyAverageScore" style="display:none;padding:8px 16px;border-radius:12px;font-weight:700"></div>
            </div>
            <div class="meal-grid">
                <div class="meal-item-wrapper">
                    <div class="meal-item" id="breakfastMeal" onclick="uploadMeal('BREAKFAST')">
                        <div class="meal-placeholder">ğŸ³</div>
                        <div class="meal-label">ì•„ì¹¨</div>
                    </div>
                    <div id="breakfastEvaluation" class="meal-evaluation" style="display:none;margin-top:12px"></div>
                </div>
                <div class="meal-item-wrapper">
                    <div class="meal-item" id="lunchMeal" onclick="uploadMeal('LUNCH')">
                        <div class="meal-placeholder">ğŸ±</div>
                        <div class="meal-label">ì ì‹¬</div>
                    </div>
                    <div id="lunchEvaluation" class="meal-evaluation" style="display:none;margin-top:12px"></div>
                </div>
                <div class="meal-item-wrapper">
                    <div class="meal-item" id="dinnerMeal" onclick="uploadMeal('DINNER')">
                        <div class="meal-placeholder">ğŸ½ï¸</div>
                        <div class="meal-label">ì €ë…</div>
                    </div>
                    <div id="dinnerEvaluation" class="meal-evaluation" style="display:none;margin-top:12px"></div>
                </div>
            </div>
            <input type="file" id="mealImageInput" accept="image/*" style="display:none" onchange="handleMealImageUpload()">
        </div>
    </div>
</div>
<div id="dailyTab" class="tab-content-wrapper">
    <div class="app-container">
        <div class="custom-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <div style="display:flex;align-items:center;gap:12px">
                    <h5 style="margin:0;font-weight:700"><i class="bi bi-images"></i> ì¼ìƒ</h5>
                    <button onclick="toggleDailySearch()" style="width:36px;height:36px;border-radius:50%;background:var(--white);color:var(--text-primary);border:2px solid var(--gray-300);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--gray-300)'" title="ê²€ìƒ‰">
                        <i class="bi bi-search" style="font-size:16px"></i>
                    </button>
                </div>
                <button onclick="showDailyPostModal()" style="width:40px;height:40px;border-radius:50%;background:var(--primary);color:white;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;box-shadow:0 2px 8px rgba(74,144,226,.3)" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="ê²Œì‹œë¬¼ ì‘ì„±">
                    <i class="bi bi-plus-lg" style="font-size:20px"></i>
                </button>
            </div>
            <div id="dailySearchPanel" style="display:none;margin-bottom:16px;padding:16px;background:var(--white);border-radius:12px;border:1px solid var(--gray-300)">
                <div style="margin-bottom:12px">
                    <label style="display:block;margin-bottom:8px;font-weight:600;font-size:14px">ê²€ìƒ‰ ìœ í˜•</label>
                    <select id="dailySearchType" class="comment-input" style="width:100%">
                        <option value="content">ë‚´ìš© ê²€ìƒ‰</option>
                        <option value="date">ë‚ ì§œ ê²€ìƒ‰</option>
                    </select>
                </div>
                <div id="dailySearchContent" style="margin-bottom:12px">
                    <label style="display:block;margin-bottom:8px;font-weight:600;font-size:14px">ê²€ìƒ‰ì–´</label>
                    <input type="text" id="dailySearchInput" class="comment-input" style="width:100%" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div id="dailySearchDate" style="display:none;margin-bottom:12px">
                    <label style="display:block;margin-bottom:8px;font-weight:600;font-size:14px">ë‚ ì§œ</label>
                    <input type="date" id="dailySearchDateInput" class="comment-input" style="width:100%">
                </div>
                <button onclick="searchDailyPosts()" class="comment-submit-btn" style="width:100%">
                    <i class="bi bi-search"></i> ê²€ìƒ‰
                </button>
            </div>
            <div id="dailyPostsGrid" style="display:flex;flex-direction:column;gap:20px">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p style="margin-top:12px;color:var(--gray-600)">ì¼ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wishTab" class="tab-content-wrapper">
    <div class="app-container">
        <div class="custom-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h5 style="margin:0;font-weight:700"><i class="bi bi-star-fill"></i> ìœ„ì‹œë¦¬ìŠ¤íŠ¸</h5>
                <button onclick="showWishModal()" style="width:40px;height:40px;border-radius:50%;background:var(--primary);color:white;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;box-shadow:0 2px 8px rgba(74,144,226,.3)" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="ìœ„ì‹œ ì¶”ê°€">
                    <i class="bi bi-plus-lg" style="font-size:20px"></i>
                </button>
            </div>
            <div id="wishListGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p style="margin-top:12px;color:var(--gray-600)">ìœ„ì‹œë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>

        <div class="custom-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h5 style="margin:0;font-weight:700"><i class="bi bi-calendar-event"></i> ì¼ì •</h5>
            </div>
            <div class="calendar-wrapper">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="changeWishMonth(-1)"><i class="bi bi-chevron-left"></i></button>
                    <div class="calendar-title" id="wishCalendarTitle">2025ë…„ 1ì›”</div>
                    <button class="calendar-nav-btn" onclick="changeWishMonth(1)"><i class="bi bi-chevron-right"></i></button>
                </div>
                <div id="wishCalendarGrid"></div>
            </div>
            <div id="wishScheduleList" style="margin-top:20px;display:flex;flex-direction:column;gap:12px"></div>
        </div>
    </div>
</div>
<div id="settingsTab" class="tab-content-wrapper">
    <div class="app-container">
        <div class="custom-card">
            <h5 style="margin-bottom:20px;font-weight:700"><i class="bi bi-gear"></i> ì„¤ì •</h5>
            <div class="settings-list">
                <div class="settings-item" onclick="showProfileSettings()">
                    <div class="settings-item-content">
                        <div class="settings-item-icon"><i class="bi bi-person-circle"></i></div>
                        <div class="settings-item-text">
                            <h6>í”„ë¡œí•„ ë³€ê²½</h6>
                            <p>í”„ë¡œí•„ ì‚¬ì§„ ë° í‘œì‹œ ì´ë¦„ ë³€ê²½</p>
                        </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
                <div class="settings-item" onclick="showPasswordSettings()">
                    <div class="settings-item-content">
                        <div class="settings-item-icon"><i class="bi bi-shield-lock"></i></div>
                        <div class="settings-item-text">
                            <h6>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h6>
                            <p>ê³„ì • ë³´ì•ˆì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</p>
                        </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
                <div class="settings-item">
                    <div class="settings-item-content">
                        <div class="settings-item-icon"><i class="bi bi-moon-stars"></i></div>
                        <div class="settings-item-text">
                            <h6>ë‹¤í¬ ëª¨ë“œ</h6>
                            <p>í™”ë©´ í…Œë§ˆ ë³€ê²½</p>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode()">
                        <span class="switch-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <div class="settings-item-content">
                        <div class="settings-item-icon"><i class="bi bi-bell"></i></div>
                        <div class="settings-item-text">
                            <h6>Push ì•Œë¦¼</h6>
                            <p>ì•½ ë³µìš© ì•Œë¦¼ ì„¤ì •</p>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="pushNotificationSwitch" onchange="togglePushNotification()">
                        <span class="switch-slider"></span>
                    </label>
                </div>
                <div class="settings-item" onclick="openModal('pointShopModal');loadPointShop()">
                    <div class="settings-item-content">
                        <div class="settings-item-icon" style="color:#f59e0b"><i class="bi bi-shop"></i></div>
                        <div class="settings-item-text">
                            <h6>í¬ì¸íŠ¸ ìƒì </h6>
                            <p>í¬ì¸íŠ¸ë¡œ ìƒí’ˆ êµ¬ë§¤í•˜ê¸°</p>
                        </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
                <div class="settings-item" th:if="${user.role.name() == 'ADMIN'}" onclick="showPointItemManagement()">
                    <div class="settings-item-content">
                        <div class="settings-item-icon" style="color:var(--primary)"><i class="bi bi-shop-window"></i></div>
                        <div class="settings-item-text">
                            <h6>í¬ì¸íŠ¸ ìƒí’ˆ ê´€ë¦¬</h6>
                            <p>í¬ì¸íŠ¸ ìƒí’ˆ ë“±ë¡ ë° ì‚­ì œ (ê´€ë¦¬ì ì „ìš©)</p>
                        </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
                <div class="settings-item" onclick="logout()">
                    <div class="settings-item-content">
                        <div class="settings-item-icon" style="color:var(--danger)"><i class="bi bi-box-arrow-right"></i></div>
                        <div class="settings-item-text">
                            <h6 style="color:var(--danger)">ë¡œê·¸ì•„ì›ƒ</h6>
                            <p>ê³„ì •ì—ì„œ ë¡œê·¸ì•„ì›ƒ</p>
                        </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </div>
            </div>
        </div>
    </div>
</div>
<nav class="bottom-nav">
    <div class="nav-item active" data-tab="homeTab"><i class="bi bi-house-door-fill"></i><span>í™ˆ</span></div>
    <div class="nav-item" data-tab="healthTab"><i class="bi bi-heart-pulse-fill"></i><span>ê±´ê°•</span></div>
    <div class="nav-item" data-tab="wishTab"><i class="bi bi-star-fill"></i><span>ìœ„ì‹œ</span></div>
    <div class="nav-item" data-tab="dailyTab"><i class="bi bi-images"></i><span>ì¼ìƒ</span></div>
    <div class="nav-item" data-tab="settingsTab"><i class="bi bi-gear"></i><span>ì„¤ì •</span></div>
</nav>
<div class="modal-overlay" id="profileModal" onclick="closeProfileModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title" id="profileModalTitle">í”„ë¡œí•„</div>
            <button class="modal-close" onclick="closeProfileModal()"><i class="bi bi-x"></i></button>
        </div>
        <img class="modal-image" id="profileModalImage" src="" alt="í”„ë¡œí•„">
    </div>
</div>
<div class="modal-overlay" id="profileSettingsModal" onclick="closeModal('profileSettingsModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:400px">
        <div class="modal-header">
            <div class="modal-title">í”„ë¡œí•„ ë³€ê²½</div>
            <button class="modal-close" onclick="closeModal('profileSettingsModal')"><i class="bi bi-x"></i></button>
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">í‘œì‹œ ì´ë¦„</label>
            <input type="text" id="displayNameInput" class="comment-input" style="width:100%" th:value="${user.displayName}" placeholder="í‘œì‹œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">í”„ë¡œí•„ ì‚¬ì§„</label>
            <input type="file" id="profileImageInput" accept="image/*" style="width:100%">
        </div>
        <button class="comment-submit-btn" style="width:100%" onclick="updateProfile()">ì €ì¥</button>
    </div>
</div>
<div class="modal-overlay" id="passwordSettingsModal" onclick="closeModal('passwordSettingsModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:400px">
        <div class="modal-header">
            <div class="modal-title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
            <button class="modal-close" onclick="closeModal('passwordSettingsModal')"><i class="bi bi-x"></i></button>
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="currentPassword" class="comment-input" style="width:100%" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸">
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="newPassword" class="comment-input" style="width:100%" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
        </div>
        <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:600">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="confirmPassword" class="comment-input" style="width:100%" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
        </div>
        <button class="comment-submit-btn" style="width:100%" onclick="updatePassword()">ë³€ê²½</button>
    </div>
</div>
<div class="modal-overlay" id="aiEvaluationModal" onclick="closeModal('aiEvaluationModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:500px">
        <div class="modal-header">
            <div class="modal-title" id="aiEvalModalTitle">AI ì‹ë‹¨ í‰ê°€</div>
            <button class="modal-close" onclick="closeModal('aiEvaluationModal')"><i class="bi bi-x"></i></button>
        </div>
        <div id="aiEvalModalContent" style="line-height:1.8">
            <p>í‰ê°€ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>
</div>
<div class="modal-overlay" id="imageModal" onclick="closeModal('imageModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title">ì´ë¯¸ì§€</div>
            <button class="modal-close" onclick="closeModal('imageModal')"><i class="bi bi-x"></i></button>
        </div>
        <img class="modal-image" id="imageModalImage" src="" alt="ì´ë¯¸ì§€">
    </div>
</div>
<div class="modal-overlay" id="pointItemManagementModal" onclick="closeModal('pointItemManagementModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:800px;max-height:90vh;overflow-y:auto">
        <div class="modal-header">
            <div class="modal-title">í¬ì¸íŠ¸ ìƒí’ˆ ê´€ë¦¬</div>
            <button class="modal-close" onclick="closeModal('pointItemManagementModal')"><i class="bi bi-x"></i></button>
        </div>
        <div style="margin-bottom:20px">
            <h6 style="font-weight:700;margin-bottom:12px">ìƒˆ ìƒí’ˆ ë“±ë¡</h6>
            <form id="pointItemForm" onsubmit="submitPointItem(event)">
                <input type="hidden" id="editItemId" value="">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
                    <div>
                        <label style="display:block;margin-bottom:4px;font-weight:600;font-size:14px">ìƒí’ˆëª… *</label>
                        <input type="text" id="itemName" class="comment-input" style="width:100%" placeholder="ìƒí’ˆëª…" required>
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:4px;font-weight:600;font-size:14px">í•„ìš” í¬ì¸íŠ¸ *</label>
                        <input type="number" id="itemPoints" class="comment-input" style="width:100%" placeholder="1000" required>
                    </div>
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:block;margin-bottom:4px;font-weight:600;font-size:14px">ìƒì„¸ ì„¤ëª…</label>
                    <textarea id="itemDescription" class="comment-input" style="width:100%;min-height:80px;border-radius:12px" placeholder="ìƒí’ˆ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
                    <div>
                        <label style="display:block;margin-bottom:4px;font-weight:600;font-size:14px">ì•„ì´ì½˜ (Bootstrap)</label>
                        <input type="text" id="itemIcon" class="comment-input" style="width:100%" placeholder="gift">
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:4px;font-weight:600;font-size:14px">ìƒ‰ìƒ (HEX)</label>
                        <input type="text" id="itemColor" class="comment-input" style="width:100%" placeholder="#4A90E2">
                    </div>
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:block;margin-bottom:4px;font-weight:600;font-size:14px">ìƒí’ˆ ì´ë¯¸ì§€</label>
                    <input type="file" id="itemImage" accept="image/*" style="width:100%">
                </div>
                <button type="submit" class="comment-submit-btn" style="width:100%">
                    <i class="bi bi-plus-circle"></i> ìƒí’ˆ ë“±ë¡
                </button>
            </form>
        </div>
        <div>
            <h6 style="font-weight:700;margin-bottom:12px">ë“±ë¡ëœ ìƒí’ˆ ëª©ë¡</h6>
            <div id="adminItemsList" style="display:flex;flex-direction:column;gap:12px"></div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="pointShopModal" onclick="closeModal('pointShopModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:800px;max-height:90vh;overflow-y:auto">
        <div class="modal-header">
            <div class="modal-title">í¬ì¸íŠ¸ ìƒì </div>
            <button class="modal-close" onclick="closeModal('pointShopModal')"><i class="bi bi-x"></i></button>
        </div>
        <div class="points-display" style="margin-bottom:24px">
            <div class="points-label">ë³´ìœ  í¬ì¸íŠ¸</div>
            <div class="points-content">
                <i class="bi bi-trophy-fill points-icon"></i>
                <div>
                    <span class="points-value" id="modalCurrentPoints" th:text="${user.points != null ? user.points : 0}">0</span>
                    <span class="points-unit">pt</span>
                </div>
            </div>
        </div>
        <div class="point-items-grid" id="modalPointItemsGrid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p style="margin-top:12px;color:var(--gray-600)">ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="dailyPostModal" onclick="closeModal('dailyPostModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:600px">
        <div class="modal-header">
            <div class="modal-title">ì¼ìƒ ê²Œì‹œë¬¼ ì‘ì„±</div>
            <button class="modal-close" onclick="closeModal('dailyPostModal')"><i class="bi bi-x"></i></button>
        </div>
        <form id="dailyPostForm" onsubmit="submitDailyPost(event)">
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ë‚´ìš©</label>
                <textarea id="dailyContent" class="comment-input" style="width:100%;min-height:120px;border-radius:12px;resize:vertical" placeholder="ì˜¤ëŠ˜ì˜ ì¼ìƒì„ ê³µìœ í•´ì£¼ì„¸ìš”..." required></textarea>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ì‚¬ì§„/ì˜ìƒ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</label>
                <input type="file" id="dailyMedia" accept="image/*,video/*" multiple style="display:none" onchange="handleDailyMediaSelect(event)">
                <button type="button" class="comment-submit-btn" onclick="document.getElementById('dailyMedia').click()" style="width:100%;justify-content:center;gap:8px">
                    <i class="bi bi-image-fill"></i> ì‚¬ì§„/ì˜ìƒ ì„ íƒ
                </button>
                <div id="dailyMediaPreview" style="margin-top:12px;display:none;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px"></div>
            </div>
            <button type="submit" class="comment-submit-btn" style="width:100%">
                <i class="bi bi-send-fill"></i> ê²Œì‹œí•˜ê¸°
            </button>
        </form>
    </div>
</div>
<div class="modal-overlay" id="wishModal" onclick="closeModal('wishModal')">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:700px;max-height:90vh;overflow-y:auto">
        <div class="modal-header">
            <div class="modal-title">ìœ„ì‹œ ì¶”ê°€</div>
            <button class="modal-close" onclick="closeModal('wishModal')"><i class="bi bi-x"></i></button>
        </div>
        <form id="wishForm" onsubmit="submitWish(event)">
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ì œëª©</label>
                <input type="text" id="wishTitle" class="comment-input" style="width:100%;border-radius:12px" placeholder="ì˜ˆ: ê°•ë‚¨ ë§›ì§‘ ë°©ë¬¸" required>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ì„¤ëª…</label>
                <textarea id="wishDescription" class="comment-input" style="width:100%;min-height:100px;border-radius:12px;resize:vertical" placeholder="ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ì¹´í…Œê³ ë¦¬</label>
                <select id="wishCategory" class="comment-input" style="width:100%;border-radius:12px" required>
                    <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                    <option value="RESTAURANT">ë§›ì§‘</option>
                    <option value="TRAVEL">ì—¬í–‰ì§€</option>
                    <option value="SHOPPING">ì‡¼í•‘</option>
                    <option value="CAFE">ì¹´í˜</option>
                    <option value="ACTIVITY">ì•¡í‹°ë¹„í‹°</option>
                    <option value="OTHER">ê¸°íƒ€</option>
                </select>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ìœ„ì¹˜ ê²€ìƒ‰</label>
                <div style="display:flex;gap:8px;margin-bottom:8px">
                    <input type="text" id="wishLocationSearch" class="comment-input" style="flex:1;border-radius:12px" placeholder="ì¥ì†Œëª… ë˜ëŠ” ì£¼ì†Œ ê²€ìƒ‰">
                    <button type="button" class="comment-submit-btn" onclick="searchLocation()">
                        <i class="bi bi-search"></i> ê²€ìƒ‰
                    </button>
                </div>
                <div id="naverMap" style="width:100%;height:300px;border-radius:12px;overflow:hidden;margin-bottom:8px"></div>
                <input type="hidden" id="wishLatitude">
                <input type="hidden" id="wishLongitude">
                <input type="text" id="wishAddress" class="comment-input" style="width:100%;border-radius:12px" placeholder="ì„ íƒëœ ì£¼ì†Œ" readonly>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ì´ë¯¸ì§€ (ì„ íƒ)</label>
                <input type="file" id="wishImage" accept="image/*" style="display:none" onchange="handleWishImageSelect(event)">
                <button type="button" class="comment-submit-btn" onclick="document.getElementById('wishImage').click()" style="width:100%;justify-content:center;gap:8px">
                    <i class="bi bi-image-fill"></i> ì´ë¯¸ì§€ ì„ íƒ
                </button>
                <div id="wishImagePreview" style="margin-top:12px;display:none"></div>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:600">ì¼ì • ì¶”ê°€ (ì„ íƒ)</label>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div>
                        <label style="display:block;margin-bottom:4px;font-size:12px;color:var(--gray-600)">ë‚ ì§œ</label>
                        <input type="date" id="wishScheduleDate" class="comment-input" style="width:100%;border-radius:12px">
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:4px;font-size:12px;color:var(--gray-600)">ì‹œê°„</label>
                        <input type="time" id="wishScheduleTime" class="comment-input" style="width:100%;border-radius:12px">
                    </div>
                </div>
            </div>
            <button type="submit" class="comment-submit-btn" style="width:100%">
                <i class="bi bi-star-fill"></i> ìœ„ì‹œ ì¶”ê°€í•˜ê¸°
            </button>
        </form>
    </div>
</div>
<div class="toast-container" id="toastContainer"></div>
<script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=YOUR_CLIENT_ID&submodules=geocoder"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
<script>
const currentUserId='[[${user.id}]]';
const currentUsername='[[${user.username}]]';
const canTakeMedicine=[[${canTakeMedicine}]];
let currentTab='homeTab',currentPage=1,commentsPerPage=10,allComments=[],currentMealType=null,currentCalendarDate=new Date();
let messaging=null,currentFcmToken=null,currentMealData={};
document.addEventListener('DOMContentLoaded',function(){initializeDarkMode();initializeNavigation();loadComments();initializeMedicineStatus();initializeMealStatus();loadHomeRecentDailies();loadActivities();checkPushNotificationStatus();calculateExpectedPoints();initializeFirebase();initializeWebSocket()});
function initializeDarkMode(){const darkMode=localStorage.getItem('darkMode')==='true';if(darkMode){document.body.classList.add('dark-mode');updateDarkModeUI(true)}else{updateDarkModeUI(false)}}
function toggleDarkMode(){const isDark=document.body.classList.toggle('dark-mode');localStorage.setItem('darkMode',isDark);updateDarkModeUI(isDark);showToast(isDark?'ë‹¤í¬ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.':'ë¼ì´íŠ¸ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.','success')}
function updateDarkModeUI(isDark){const homeToggle=document.getElementById('homeDarkModeToggle');const settingsSwitch=document.getElementById('darkModeSwitch');if(homeToggle){homeToggle.innerHTML=isDark?'<i class="bi bi-sun-fill"></i>':'<i class="bi bi-moon-fill"></i>'}if(settingsSwitch){settingsSwitch.checked=isDark}}
function initializeNavigation(){document.querySelectorAll('.nav-item').forEach(item=>{item.addEventListener('click',function(){switchTab(this.getAttribute('data-tab'))})})}
function switchTab(tabId){document.querySelectorAll('.tab-content-wrapper').forEach(tab=>tab.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(item=>item.classList.remove('active'));document.getElementById(tabId).classList.add('active');document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');currentTab=tabId;if(tabId==='healthTab'){initializeMedicineStatus();initializeMealStatus();renderHealthCalendar()}else if(tabId==='dailyTab'){loadDailies()}else if(tabId==='wishTab'){loadWishes();loadWishSchedules()}}
async function loadComments(){try{const response=await fetch('/api/comments');allComments=await response.json();renderComments()}catch(error){console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:',error);showToast('ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
let commentImageData=null;
function handleCommentImageSelect(event){const file=event.target.files[0];if(!file)return;if(file.size>5*1024*1024){showToast('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.','error');return}const reader=new FileReader();reader.onload=function(e){const img=new Image();img.onload=function(){const maxWidth=600;const maxHeight=600;let width=img.width;let height=img.height;if(width>height){if(width>maxWidth){height*=maxWidth/width;width=maxWidth}}else{if(height>maxHeight){width*=maxHeight/height;height=maxHeight}}const canvas=document.createElement('canvas');canvas.width=width;canvas.height=height;const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0,width,height);commentImageData=canvas.toDataURL('image/jpeg',0.85);document.getElementById('commentImagePreview').src=commentImageData;document.getElementById('commentImagePreviewWrapper').style.display='block';document.querySelector('.comment-image-btn').classList.add('active')};img.src=e.target.result};reader.readAsDataURL(file)}
function removeCommentImage(){commentImageData=null;document.getElementById('commentImageInput').value='';document.getElementById('commentImagePreviewWrapper').style.display='none';document.querySelector('.comment-image-btn').classList.remove('active')}
function showReplyInput(commentId){const existingReplyWrapper=document.querySelector('.reply-input-wrapper.active');if(existingReplyWrapper)existingReplyWrapper.remove();const replyHtml=`<div class="reply-input-wrapper active" id="reply-${commentId}"><div class="comment-input-row"><input type="text" id="replyInput-${commentId}" class="comment-input" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."><button class="comment-submit-btn" onclick="submitReply(${commentId})"><i class="bi bi-send-fill"></i></button><button class="comment-submit-btn" style="background:var(--gray-600)" onclick="cancelReply(${commentId})">ì·¨ì†Œ</button></div></div>`;const commentEl=document.querySelector(`[data-comment-id="${commentId}"]`);if(commentEl){commentEl.insertAdjacentHTML('afterend',replyHtml);document.getElementById(`replyInput-${commentId}`).focus()}}
function cancelReply(commentId){const replyWrapper=document.getElementById(`reply-${commentId}`);if(replyWrapper)replyWrapper.remove()}
async function submitReply(parentCommentId){const input=document.getElementById(`replyInput-${parentCommentId}`);const content=input.value.trim();if(!content){showToast('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');return}try{const response=await fetch('/api/comments',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content,parentCommentId})});if(response.ok){input.value='';showToast('ë‹µê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.','success');cancelReply(parentCommentId);await loadComments()}else throw new Error('ë‹µê¸€ ë“±ë¡ ì‹¤íŒ¨')}catch(error){console.error('ë‹µê¸€ ë“±ë¡ ì‹¤íŒ¨:',error);showToast('ë‹µê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function renderComments(){const commentList=document.getElementById('commentList');const parentComments=allComments.filter(c=>!c.parentComment);const totalPages=Math.ceil(parentComments.length/commentsPerPage);const startIndex=(currentPage-1)*commentsPerPage;const pageComments=parentComments.slice(startIndex,startIndex+commentsPerPage);if(!pageComments.length){commentList.innerHTML='<div class="empty-state"><div class="empty-state-icon"><i class="bi bi-chat"></i></div><div class="empty-state-title">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div><div class="empty-state-text">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div></div>';return}const oneDayAgo=new Date(Date.now()-864e5);let html='';pageComments.forEach(comment=>{const createdAt=new Date(comment.createdAt);const isNew=createdAt>oneDayAgo;html+=`<div class="comment-item ${isNew?'new':''}" data-comment-id="${comment.id}"><div class="comment-header"><div class="comment-avatar" onclick="showProfileModal('${comment.user?.profileImage||''}','${comment.user?.displayName||''}')">${comment.user?.profileImage?`<img src="${comment.user.profileImage}" alt="${comment.user.displayName}">`:comment.user?.displayName?.substring(0,1)||'U'}</div><div class="comment-user-info"><div class="comment-username">${comment.user?.displayName||'ì‚¬ìš©ì'}</div><div class="comment-time">${formatTimeAgo(createdAt)}</div></div>${comment.user?.id==currentUserId?`<button class="comment-delete-btn" onclick="event.stopPropagation();deleteComment(${comment.id})" title="ì‚­ì œ"><i class="bi bi-trash"></i></button>`:''}</div><div class="comment-content">${escapeHtml(comment.content)}</div>${comment.imageUrl?`<img class="comment-image" src="${comment.imageUrl}" onclick="showImageModal('${comment.imageUrl}')">`:''}<div class="comment-actions"><button class="comment-action-btn ${comment.likedUserIds&&comment.likedUserIds.includes(parseInt(currentUserId))?'liked':''}" onclick="toggleLike(${comment.id})"><i class="bi bi-heart-fill"></i><span>${comment.likesCount||0}</span></button><button class="comment-action-btn" onclick="showReplyInput(${comment.id})"><i class="bi bi-reply-fill"></i> ë‹µê¸€</button></div></div>`;const replies=allComments.filter(r=>r.parentComment&&r.parentComment.id===comment.id);replies.forEach(reply=>{const replyCreatedAt=new Date(reply.createdAt);const replyIsNew=replyCreatedAt>oneDayAgo;html+=`<div class="comment-item reply ${replyIsNew?'new':''}" data-comment-id="${reply.id}"><div class="comment-header"><div class="comment-avatar" onclick="showProfileModal('${reply.user?.profileImage||''}','${reply.user?.displayName||''}')">${reply.user?.profileImage?`<img src="${reply.user.profileImage}" alt="${reply.user.displayName}">`:reply.user?.displayName?.substring(0,1)||'U'}</div><div class="comment-user-info"><div class="comment-username">${reply.user?.displayName||'ì‚¬ìš©ì'}</div><div class="comment-time">${formatTimeAgo(replyCreatedAt)}</div></div>${reply.user?.id==currentUserId?`<button class="comment-delete-btn" onclick="event.stopPropagation();deleteComment(${reply.id})" title="ì‚­ì œ"><i class="bi bi-trash"></i></button>`:''}</div><div class="comment-content">${escapeHtml(reply.content)}</div>${reply.imageUrl?`<img class="comment-image" src="${reply.imageUrl}" onclick="showImageModal('${reply.imageUrl}')">`:''}<div class="comment-actions"><button class="comment-action-btn ${reply.likedUserIds&&reply.likedUserIds.includes(parseInt(currentUserId))?'liked':''}" onclick="toggleLike(${reply.id})"><i class="bi bi-heart-fill"></i><span>${reply.likesCount||0}</span></button></div></div>`})});commentList.innerHTML=html;renderPagination(totalPages)}
function renderPagination(totalPages){const paginationWrapper=document.getElementById('commentPagination');if(totalPages<=1){paginationWrapper.innerHTML='';return}let html='<div class="pagination">';if(currentPage>1)html+=`<button class="page-btn" onclick="changePage(${currentPage-1})"><i class="bi bi-chevron-left"></i></button>`;for(let i=1;i<=totalPages;i++){if(i===1||i===totalPages||(i>=currentPage-1&&i<=currentPage+1))html+=`<button class="page-btn ${i===currentPage?'active':''}" onclick="changePage(${i})">${i}</button>`;else if(i===currentPage-2||i===currentPage+2)html+='<span style="padding:8px">...</span>'}if(currentPage<totalPages)html+=`<button class="page-btn" onclick="changePage(${currentPage+1})"><i class="bi bi-chevron-right"></i></button>`;paginationWrapper.innerHTML=html+'</div>'}
function changePage(page){currentPage=page;renderComments();window.scrollTo({top:0,behavior:'smooth'})}
async function submitComment(){const input=document.getElementById('commentInput');const content=input.value.trim();if(!content){showToast('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');return}try{const response=await fetch('/api/comments',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content,imageData:commentImageData})});if(response.ok){input.value='';removeCommentImage();showToast('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.','success');await loadComments()}else throw new Error('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨')}catch(error){console.error('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:',error);showToast('ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function toggleLike(commentId){try{const response=await fetch(`/api/comments/${commentId}/like`,{method:'POST'});if(response.ok)await loadComments();else throw new Error('ì¢‹ì•„ìš” ì‹¤íŒ¨')}catch(error){console.error('ì¢‹ì•„ìš” ì‹¤íŒ¨:',error);showToast('ì¢‹ì•„ìš”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function deleteComment(commentId){if(!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{const response=await fetch(`/api/comments/${commentId}`,{method:'DELETE'});if(response.ok){showToast('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.','success');await loadComments()}else{const error=await response.json();showToast(error.error||'ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}catch(error){console.error('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨:',error);showToast('ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function initializeMedicineStatus(){const morningTaken=[[${morningRecord.taken}]];const eveningTaken=[[${eveningRecord.taken}]];if(morningTaken)document.getElementById('morningBtn').classList.add('taken');if(eveningTaken)document.getElementById('eveningBtn').classList.add('taken')}
function handleMedicineClick(type,element){toggleMedicine(type,element)}
async function toggleMedicine(type,element){const btn=element||document.getElementById(type==='MORNING'?'morningBtn':'eveningBtn');const isTaken=btn.classList.contains('taken');const canTake=btn.getAttribute('data-can-take')==='true';if(!isTaken&&!canTake){showToast('ì•½ ë³µìš© ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.','error');return}btn.classList.toggle('taken');const statusEl=document.getElementById(type.toLowerCase()+'Status').querySelector('span');statusEl.textContent=isTaken?'ë¯¸ë³µìš©':'ë³µìš©ì™„ë£Œ';try{const response=await fetch(isTaken?'/api/medicine/cancel':'/api/medicine/take',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:`medicineType=${type}`});if(response.ok){showToast(isTaken?'ì•½ ë³µìš©ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.':'ì•½ ë³µìš©ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.','success')}else{btn.classList.toggle('taken');statusEl.textContent=isTaken?'ë³µìš©ì™„ë£Œ':'ë¯¸ë³µìš©';throw new Error('ì•½ ë³µìš© ì²˜ë¦¬ ì‹¤íŒ¨')}}catch(error){console.error('ì•½ ë³µìš© ì²˜ë¦¬ ì‹¤íŒ¨:',error);showToast('ì•½ ë³µìš© ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function initializeCalendar(){renderCalendar()}
async function renderCalendar(){const year=currentCalendarDate.getFullYear(),month=currentCalendarDate.getMonth();document.getElementById('calendarTitle').textContent=`${year}ë…„ ${month+1}ì›”`;const firstDay=new Date(year,month,1).getDay(),daysInMonth=new Date(year,month+1,0).getDate(),today=new Date();let medicineData={};try{const response=await fetch(`/api/medicine/calendar/${year}/${month+1}`);const data=await response.json();if(data.records){data.records.forEach(record=>{const day=new Date(record.date).getDate();if(!medicineData[day])medicineData[day]={morning:false,evening:false};if(record.medicineType==='MORNING')medicineData[day].morning=record.taken;else if(record.medicineType==='EVENING')medicineData[day].evening=record.taken})}}catch(error){console.error('ì•½ë³µìš© ë‹¬ë ¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:',error)}let html='';['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(day=>html+=`<div class="calendar-day-header">${day}</div>`);for(let i=0;i<firstDay;i++)html+='<div></div>';for(let day=1;day<=daysInMonth;day++){const date=new Date(year,month,day);const medData=medicineData[day];let statusHtml='';if(medData){statusHtml='<div class="calendar-medicine-status">';if(medData.morning)statusHtml+='<div class="medicine-dot morning"></div>';if(medData.evening)statusHtml+='<div class="medicine-dot evening"></div>';statusHtml+='</div>'}html+=`<div class="calendar-day ${date.toDateString()===today.toDateString()?'today':''}" onclick="selectDate('${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}')"><div class="calendar-day-content">${day}${statusHtml}</div></div>`}document.getElementById('calendarGrid').innerHTML=html}
function changeMonth(delta){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+delta);renderCalendar()}
function changeMealMonth(delta){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+delta);renderMealCalendar()}
function selectDate(dateStr){showToast(`${dateStr} ì„ íƒë¨`,'info');loadDateData(dateStr)}
function selectMealDate(dateStr){loadDateData(dateStr)}
async function loadDateData(dateStr){try{const response=await fetch(`/api/meal/date/${dateStr}`);const data=await response.json();if(data.success){updateMealDisplay(data.meals||[],data.stats)}}catch(error){console.error('ë‚ ì§œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:',error)}}
async function renderMealCalendar(){const year=currentCalendarDate.getFullYear(),month=currentCalendarDate.getMonth();document.getElementById('mealCalendarTitle').textContent=`${year}ë…„ ${month+1}ì›”`;const firstDay=new Date(year,month,1).getDay(),daysInMonth=new Date(year,month+1,0).getDate(),today=new Date();let mealScores={};try{const response=await fetch(`/api/meal/calendar/${year}/${month+1}`);const data=await response.json();if(data.dailyStats){data.dailyStats.forEach(stat=>{const day=new Date(stat.date).getDate();mealScores[day]=stat.averageScore})}}catch(error){console.error('ì‹ë‹¨ ë‹¬ë ¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:',error)}let html='';['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(day=>html+=`<div class="calendar-day-header">${day}</div>`);for(let i=0;i<firstDay;i++)html+='<div></div>';for(let day=1;day<=daysInMonth;day++){const date=new Date(year,month,day);const score=mealScores[day];let scoreHtml='';if(score){const color=getScoreColor(score);scoreHtml=`<div class="calendar-score" style="color:${color}">${score}ì </div>`}html+=`<div class="calendar-day ${date.toDateString()===today.toDateString()?'today':''}" onclick="selectMealDate('${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}')"><div class="calendar-day-content">${day}${scoreHtml}</div></div>`}document.getElementById('mealCalendarGrid').innerHTML=html}
function getScoreColor(score){if(score>=80)return'#10b981';if(score>=60)return'#3b82f6';if(score>=40)return'#f59e0b';if(score>=20)return'#ef4444';return'#991b1b'}
function updateMealDisplay(meals,stats){meals.forEach(meal=>{const mealType=meal.mealType.toLowerCase();const mealElement=document.getElementById(mealType+'Meal');const evalElement=document.getElementById(mealType+'Evaluation');if(mealElement&&meal.imageUrl){mealElement.classList.add('has-image');mealElement.innerHTML=`<img src="${meal.imageUrl}" alt="${meal.mealType}" onclick="showImageModal('${meal.imageUrl}')">`}if(evalElement&&meal.aiEvaluation){const color=getScoreColor(meal.score||0);evalElement.style.display='block';evalElement.innerHTML=`<div style="padding:12px;background:${color}15;border-left:4px solid ${color};border-radius:8px"><div style="font-weight:700;color:${color};margin-bottom:8px">ì ìˆ˜: ${meal.score||0}ì </div><div style="font-size:14px;line-height:1.6">${escapeHtml(meal.aiEvaluation)}</div></div>`}});if(stats&&stats.averageScore>0){const avgElement=document.getElementById('dailyAverageScore');const avgColor=getScoreColor(stats.averageScore);avgElement.style.display='block';avgElement.style.background=`${avgColor}15`;avgElement.style.color=avgColor;avgElement.style.border=`2px solid ${avgColor}`;avgElement.textContent=`í‰ê·  ${stats.averageScore}ì  ${stats.emoji}`}}
async function initializeMealStatus(){try{const today=new Date().toISOString().split('T')[0];const response=await fetch(`/api/meal/date/${today}`);const data=await response.json();if(data.success){updateMealDisplay(data.meals||[],data.stats)}}catch(error){console.error('ì‹ë‹¨ ì¡°íšŒ ì‹¤íŒ¨:',error)}}
function uploadMeal(mealType){currentMealType=mealType;document.getElementById('mealImageInput').click()}
async function handleMealImageUpload(){const input=document.getElementById('mealImageInput'),file=input.files[0];if(!file)return;const mealId=currentMealType.toLowerCase()+'Meal';const mealItem=document.getElementById(mealId);const originalHTML=mealItem.innerHTML;mealItem.innerHTML='<div class="loading-spinner"></div><div style="margin-top:8px;font-size:12px">ì—…ë¡œë“œ ì¤‘...</div>';const formData=new FormData();formData.append('image',file);formData.append('mealType',currentMealType);formData.append('date',new Date().toISOString().split('T')[0]);try{const response=await fetch('/api/meal/upload',{method:'POST',body:formData});if(response.ok){const result=await response.json();showToast('ì‹ë‹¨ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.','success');await initializeMealStatus()}else{const errorData=await response.json();showToast(errorData.error||'ì‹ë‹¨ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error');mealItem.innerHTML=originalHTML}}catch(error){console.error('ì‹ë‹¨ ì—…ë¡œë“œ ì‹¤íŒ¨:',error);showToast('ì‹ë‹¨ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error');mealItem.innerHTML=originalHTML}input.value=''}
function showProfileSettings(){document.getElementById('profileSettingsModal').classList.add('active')}
function showPasswordSettings(){document.getElementById('passwordSettingsModal').classList.add('active')}
async function updateProfile(){const displayName=document.getElementById('displayNameInput').value.trim(),file=document.getElementById('profileImageInput').files[0],formData=new FormData();if(displayName)formData.append('displayName',displayName);if(file)formData.append('profileImage',file);try{const response=await fetch('/api/profile/update',{method:'POST',body:formData});if(response.ok){showToast('í”„ë¡œí•„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.','success');closeModal('profileSettingsModal');setTimeout(()=>location.reload(),1e3)}else throw new Error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨')}catch(error){console.error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:',error);showToast('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function updatePassword(){const currentPassword=document.getElementById('currentPassword').value,newPassword=document.getElementById('newPassword').value,confirmPassword=document.getElementById('confirmPassword').value;if(!currentPassword||!newPassword||!confirmPassword){showToast('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');return}if(newPassword!==confirmPassword){showToast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.','error');return}try{const response=await fetch('/api/profile/password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({currentPassword,newPassword})});if(response.ok){showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.','success');closeModal('passwordSettingsModal');document.getElementById('currentPassword').value='';document.getElementById('newPassword').value='';document.getElementById('confirmPassword').value=''}else throw new Error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨')}catch(error){console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨:',error);showToast('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function checkPushNotificationStatus(){}
async function togglePushNotification(){const isEnabled=document.getElementById('pushNotificationSwitch').checked;showToast(isEnabled?'Push ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.':'Push ì•Œë¦¼ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.','success')}
function logout(){if(confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))location.href='/logout'}
function showProfileModal(imageUrl,displayName){if(!imageUrl){showToast('í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.','info');return}document.getElementById('profileModalTitle').textContent=displayName||'í”„ë¡œí•„';document.getElementById('profileModalImage').src=imageUrl;document.getElementById('profileModal').classList.add('active')}
function showProfileModalFromData(element){const imageUrl=element.getAttribute('data-profile-image');const displayName=element.getAttribute('data-display-name');showProfileModal(imageUrl,displayName)}
function closeProfileModal(){document.getElementById('profileModal').classList.remove('active')}
function openModal(modalId){document.getElementById(modalId).classList.add('active')}
function closeModal(modalId){document.getElementById(modalId).classList.remove('active')}
function showToast(message,type='info'){const container=document.getElementById('toastContainer'),toast=document.createElement('div');toast.className=`toast ${type}`;toast.innerHTML=`<i class="bi bi-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i><span style="margin-left:8px">${message}</span>`;container.appendChild(toast);setTimeout(()=>toast.remove(),3e3)}
function formatTimeAgo(date){const seconds=Math.floor((new Date()-date)/1e3);if(seconds<60)return'ë°©ê¸ˆ ì „';if(seconds<3600)return`${Math.floor(seconds/60)}ë¶„ ì „`;if(seconds<86400)return`${Math.floor(seconds/3600)}ì‹œê°„ ì „`;if(seconds<604800)return`${Math.floor(seconds/86400)}ì¼ ì „`;return date.toLocaleDateString('ko-KR')}
function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML}
function hasRecentProfileUpdate(user){if(!user||!user.profileImageUpdatedAt)return false;const updateTime=new Date(user.profileImageUpdatedAt);const now=new Date();const daysDiff=(now-updateTime)/(1000*60*60*24);return daysDiff<=3}
async function loadPointItems(){const sampleItems=[{id:1,name:'ì œì£¼ ì½˜ë„ 1ë°•',description:'ì•„ë¦„ë‹¤ìš´ ì œì£¼ë„ì—ì„œì˜ íë§ íƒ€ì„! ì˜¤ì…˜ë·° ì½˜ë„ì—ì„œ í¸ì•ˆí•œ íœ´ì‹ì„ ì¦ê¸°ì„¸ìš”.',price:5000,imageUrl:'https://via.placeholder.com/300x200/4A90E2/ffffff?text=%EC%A0%9C%EC%A3%BC+%EC%BD%98%EB%8F%84',available:true},{id:2,name:'ì„œìš¸ 5ì„±ê¸‰ í˜¸í…” 1ë°•',description:'ê°•ë‚¨ í”„ë¦¬ë¯¸ì—„ í˜¸í…” ìŠ¤ìœ„íŠ¸ë£¸ 1ë°• 2ì¼ + ì¡°ì‹ 2ì¸ í¬í•¨',price:8000,imageUrl:'https://via.placeholder.com/300x200/5cb85c/ffffff?text=%ED%98%B8%ED%85%94+%EC%88%99%EB%B0%95',available:true},{id:3,name:'ê³ ê¸‰ ë ˆìŠ¤í† ë‘ ë””ë„ˆ 2ì¸',description:'ë¯¸ìŠë­ ê°€ì´ë“œ ì„ ì • ë ˆìŠ¤í† ë‘ ë””ë„ˆ ì½”ìŠ¤ (2ì¸)',price:3000,imageUrl:'https://via.placeholder.com/300x200/f0ad4e/ffffff?text=%EB%94%94%EB%84%88+%EC%BD%94%EC%8A%A4',available:true},{id:4,name:'ë¶€ì‚° í•´ìš´ëŒ€ ì½˜ë„ 2ë°•',description:'ë¶€ì‚° í•´ìš´ëŒ€ ì˜¤ì…˜ë·° ì½˜ë„ 2ë°• 3ì¼ + ì›Œí„°íŒŒí¬ ì´ìš©ê¶Œ',price:6500,imageUrl:'https://via.placeholder.com/300x200/5bc0de/ffffff?text=%EB%B6%80%EC%82%B0+%EC%BD%98%EB%8F%84',available:true},{id:5,name:'í•œì •ì‹ íŠ¹ì„  ë©”ë‰´ (4ì¸)',description:'ì „í†µ í•œì •ì‹ íŠ¹ì„  ì½”ìŠ¤ìš”ë¦¬ 4ì¸ë¶„',price:2500,imageUrl:'https://via.placeholder.com/300x200/d9534f/ffffff?text=%ED%95%9C%EC%A0%95%EC%8B%9D',available:true},{id:6,name:'ìŠ¤íŒŒ & ë§ˆì‚¬ì§€ íŒ¨í‚¤ì§€',description:'í”„ë¦¬ë¯¸ì—„ ìŠ¤íŒŒ + ì „ì‹  ë§ˆì‚¬ì§€ 90ë¶„ ì½”ìŠ¤',price:1800,imageUrl:'https://via.placeholder.com/300x200/9b59b6/ffffff?text=%EC%8A%A4%ED%8C%8C',available:true}];try{const response=await fetch('/api/points/items');const items=await response.json();renderPointItems(items)}catch(error){console.log('API ì‹¤íŒ¨, ìƒ˜í”Œ ë°ì´í„° í‘œì‹œ');renderPointItems(sampleItems)}}
function renderPointItems(items){const grid=document.getElementById('pointItemsGrid');const userRole='[[${user.role.name()}]]';const isFather=userRole==='FATHER';if(!items||items.length===0){grid.innerHTML='<div class="empty-state"><div class="empty-state-icon"><i class="bi bi-shop"></i></div><div class="empty-state-title">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div></div>';return}grid.innerHTML=items.map(item=>{const canPurchase=isFather&&item.available&&parseInt(document.getElementById('currentPoints').textContent)>=item.points;return`<div class="point-item-card ${canPurchase?'':'disabled'}" onclick="${canPurchase?`purchaseItem(${item.id})`:''}"><div class="point-item-icon-wrapper" style="background:${item.color||'#e5e7eb'}">${item.icon?`<i class="bi bi-${item.icon}"></i>`:'ğŸ'}</div><div class="point-item-name">${item.name}</div><div class="point-item-desc">${item.description||''}</div><div class="point-item-price"><span class="point-item-price-value">${item.points}</span><span class="point-item-price-unit">pt</span>${!isFather?'<span style="font-size:12px;color:var(--danger);margin-left:auto">ì•„ë²„ì§€ë§Œ êµ¬ë§¤ ê°€ëŠ¥</span>':''}</div></div>`}).join('')}
async function purchaseItem(itemId){if(!confirm('ì´ ìƒí’ˆì„ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{const response=await fetch(`/api/points/purchase/${itemId}`,{method:'POST'});if(response.ok){const result=await response.json();document.getElementById('currentPoints').textContent=result.remainingPoints;document.getElementById('userPoints').textContent=result.remainingPoints;showToast('ìƒí’ˆì„ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!','success');await loadPointItems()}else{const error=await response.json();showToast(error.message||'êµ¬ë§¤ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}catch(error){console.error('ìƒí’ˆ êµ¬ë§¤ ì‹¤íŒ¨:',error);showToast('ìƒí’ˆ êµ¬ë§¤ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function calculateExpectedPoints(){try{const today=new Date().toISOString().split('T')[0];const [medicineRes,mealRes]=await Promise.all([fetch(`/api/medicine/today`),fetch(`/api/meals/date/${today}`)]);const medicineRecords=await medicineRes.json();const meals=await mealRes.json();let medicinePoints=0;if(medicineRecords.morning&&medicineRecords.morning.taken)medicinePoints+=10;if(medicineRecords.evening&&medicineRecords.evening.taken)medicinePoints+=10;let mealPoints=0;if(meals&&meals.length>0){const avgScore=meals.reduce((sum,m)=>sum+(m.score||0),0)/meals.length;if(avgScore>=80)mealPoints=70;else if(avgScore>=60)mealPoints=50;else if(avgScore>=40)mealPoints=30;else mealPoints=20}const totalExpected=medicinePoints+mealPoints;const expectedEl=document.getElementById('healthExpectedPointsValue');if(expectedEl)expectedEl.textContent=`${totalExpected} (ì•½: ${medicinePoints}p + ì‹ë‹¨: ${mealPoints}p)`}catch(error){console.error('ì˜ˆìƒ í¬ì¸íŠ¸ ê³„ì‚° ì‹¤íŒ¨:',error);const expectedEl=document.getElementById('healthExpectedPointsValue');if(expectedEl)expectedEl.textContent='ê³„ì‚° ì‹¤íŒ¨'}}
async function initializeHomeMeals(){try{const today=new Date().toISOString().split('T')[0];const response=await fetch(`/api/meal/date/${today}`);const data=await response.json();if(data.success&&data.meals){data.meals.forEach(meal=>{const mealType=meal.mealType.toLowerCase();const element=document.getElementById(`home${mealType.charAt(0).toUpperCase()+mealType.slice(1)}Meal`);if(element&&meal.imageUrl){element.classList.add('has-image');element.innerHTML=`<img src="${meal.imageUrl}" alt="${meal.mealType}" onclick="showImageModal('${meal.imageUrl}')">`;if(meal.aiEvaluation){element.innerHTML+=`<button class="ai-eval-btn" onclick="event.stopPropagation();showAiEvaluation('${mealType}','${escapeForAttribute(meal.aiEvaluation)}',${meal.score||0})"><i class="bi bi-stars"></i> AIí‰ê°€</button>`}}currentMealData[mealType]=meal})}}catch(error){console.error('í™ˆ ì‹ë‹¨ ë¡œë“œ ì‹¤íŒ¨:',error)}}
function escapeForAttribute(text){return text.replace(/'/g,'&apos;').replace(/"/g,'&quot;').replace(/\n/g,' ')}
function showImageModal(imageUrl){document.getElementById('imageModalImage').src=imageUrl;document.getElementById('imageModal').classList.add('active')}
function showAiEvaluation(mealType,evaluation,score){const titles={breakfast:'ì•„ì¹¨ ì‹ë‹¨',lunch:'ì ì‹¬ ì‹ë‹¨',dinner:'ì €ë… ì‹ë‹¨'};document.getElementById('aiEvalModalTitle').textContent=titles[mealType]+' AI í‰ê°€';const color=getScoreColor(score);document.getElementById('aiEvalModalContent').innerHTML=`<div style="padding:16px;background:${color}15;border-left:4px solid ${color};border-radius:8px;margin-bottom:16px"><div style="font-weight:700;color:${color};font-size:24px;margin-bottom:8px">${score}ì </div></div><div style="line-height:1.8;white-space:pre-wrap">${evaluation}</div>`;document.getElementById('aiEvaluationModal').classList.add('active')}
async function initializeFirebase(){try{const firebaseConfig={apiKey:"AIzaSyC4oP4zGjT1W5gVsWu0kyOoHVpbieOtVpM",authDomain:"mdedicine.firebaseapp.com",projectId:"mdedicine",storageBucket:"mdedicine.firebasestorage.app",messagingSenderId:"659585584078",appId:"1:659585584078:web:bf9f90d5a2fdcd42f5b99f",measurementId:"G-GETB4S7XM4"};firebase.initializeApp(firebaseConfig);messaging=firebase.messaging();console.log('âœ… Firebase initialized');await requestNotificationPermission()}catch(error){console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:',error)}}
async function requestNotificationPermission(){try{const permission=await Notification.requestPermission();if(permission==='granted'){console.log('âœ… ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨');await registerFcmToken()}else{console.log('âš ï¸ ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨')}}catch(error){console.error('âŒ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:',error)}}
async function registerFcmToken(){try{const VAPID_KEY='BFkmMV5OmNvF6_j5hblhJD9L-y3v3BDaUWcbXr-y0fJrMOi4gGPD1jA4SkBVk4LWqaJvV8gB2qHY5VZL3gW-GyY';if('serviceWorker' in navigator){await navigator.serviceWorker.register('/firebase-messaging-sw.js');console.log('âœ… Service Worker ë“±ë¡ ì™„ë£Œ')}const fcmToken=await messaging.getToken({vapidKey:VAPID_KEY});if(!fcmToken){console.error('âŒ FCM í† í° ìƒì„± ì‹¤íŒ¨');return}currentFcmToken=fcmToken;console.log('âœ… FCM Token:',fcmToken.substring(0,50)+'...');const response=await fetch('/api/push/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:fcmToken})});if(response.ok){console.log('âœ… FCM í† í° ì„œë²„ ë“±ë¡ ì™„ë£Œ')}else{console.error('âŒ FCM í† í° ì„œë²„ ë“±ë¡ ì‹¤íŒ¨')}messaging.onMessage((payload)=>{console.log('ğŸ“¨ í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹ :',payload);const title=payload.data?.title||payload.notification?.title||'ì•Œë¦¼';const body=payload.data?.body||payload.notification?.body||'';showToast(body,'info')})}catch(error){console.error('âŒ FCM í† í° ë“±ë¡ ì‹¤íŒ¨:',error)}}
let stompClient=null;
function initializeWebSocket(){try{const socket=new SockJS('/ws');stompClient=Stomp.over(socket);stompClient.connect({},function(frame){console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ:',frame);stompClient.subscribe('/topic/activities',function(message){const data=JSON.parse(message.body);console.log('ğŸ“¨ í™œë™ ì•Œë¦¼ ìˆ˜ì‹ :',data);handleActivityMessage(data)});stompClient.subscribe('/topic/dailies',function(message){const data=JSON.parse(message.body);console.log('ğŸ“¨ ì¼ìƒ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :',data);handleDailyMessage(data)});stompClient.subscribe('/topic/wishes',function(message){const data=JSON.parse(message.body);console.log('ğŸ“¨ ìœ„ì‹œ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :',data);handleWishMessage(data)})},function(error){console.error('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨:',error);setTimeout(initializeWebSocket,5000)})}catch(error){console.error('âŒ WebSocket ì´ˆê¸°í™” ì‹¤íŒ¨:',error)}}
function handleActivityMessage(message){if(message.type==='ACTIVITY'&&message.action==='CREATE'){loadActivities();showToast('ìƒˆë¡œìš´ í™œë™ì´ ìˆìŠµë‹ˆë‹¤!','info')}}
function handleDailyMessage(message){if(currentTab==='dailyTab'){if(message.action==='CREATE'){loadDailies();showToast('ìƒˆ ê²Œì‹œë¬¼ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.','info')}else if(message.action==='UPDATE'){loadDailies()}else if(message.action==='DELETE'){loadDailies();showToast('ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.','info')}}loadHomeRecentDailies()}
function handleWishMessage(message){if(currentTab==='wishTab'){if(message.action==='CREATE'){loadWishes();showToast('ìƒˆ ìœ„ì‹œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.','info')}else if(message.action==='UPDATE'){loadWishes()}else if(message.action==='DELETE'){loadWishes();showToast('ìœ„ì‹œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.','info')}}}
async function showPointItemManagement(){document.getElementById('pointItemManagementModal').classList.add('active');await loadAdminItems()}
async function loadAdminItems(){try{const response=await fetch('/api/points/admin/items');if(!response.ok){showToast('ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨','error');return}const items=await response.json();const container=document.getElementById('adminItemsList');if(!items||items.length===0){container.innerHTML='<div class="empty-state"><p>ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';return}container.innerHTML=items.map(item=>`<div style="background:white;border:1px solid var(--gray-300);border-radius:12px;padding:16px"><div style="display:flex;justify-content:space-between;align-items:start"><div style="flex:1"><h6 style="font-weight:700;margin-bottom:4px">${item.name}</h6><p style="font-size:14px;color:var(--gray-600);margin-bottom:8px">${item.description||''}</p><div style="display:flex;gap:12px;font-size:14px"><span><i class="bi bi-coin"></i> ${item.points}pt</span><span style="color:${item.available?'var(--success)':'var(--danger)}'}">${item.available?'íŒë§¤ì¤‘':'íŒë§¤ì¤‘ì§€'}</span></div></div><div style="display:flex;gap:8px"><button class="comment-submit-btn" style="padding:8px 12px;background:var(--danger)" onclick="deleteAdminItem(${item.id})"><i class="bi bi-trash"></i></button></div></div>${item.imageUrl?`<img src="${item.imageUrl}" style="width:100%;max-height:200px;object-fit:cover;border-radius:8px;margin-top:12px">`:''}  </div>`).join('')}catch(error){console.error('ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:',error);showToast('ìƒí’ˆ ëª©ë¡ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function submitPointItem(event){event.preventDefault();const formData=new FormData();formData.append('name',document.getElementById('itemName').value);formData.append('description',document.getElementById('itemDescription').value);formData.append('points',document.getElementById('itemPoints').value);const icon=document.getElementById('itemIcon').value;const color=document.getElementById('itemColor').value;if(icon)formData.append('icon',icon);if(color)formData.append('color',color);const imageFile=document.getElementById('itemImage').files[0];if(imageFile)formData.append('image',imageFile);try{const response=await fetch('/api/points/admin/items',{method:'POST',body:formData});if(response.ok){showToast('ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.','success');document.getElementById('pointItemForm').reset();await loadAdminItems()}else{const error=await response.json();showToast(error.error||'ìƒí’ˆ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}catch(error){console.error('ìƒí’ˆ ë“±ë¡ ì‹¤íŒ¨:',error);showToast('ìƒí’ˆ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function deleteAdminItem(itemId){if(!confirm('ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{const response=await fetch(`/api/points/admin/items/${itemId}`,{method:'DELETE'});if(response.ok){showToast('ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.','success');await loadAdminItems();await loadPointItems()}else{const error=await response.json();showToast(error.error||'ìƒí’ˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}catch(error){console.error('ìƒí’ˆ ì‚­ì œ ì‹¤íŒ¨:',error);showToast('ìƒí’ˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function showPointShop(){document.getElementById('pointShopModal').classList.add('active');loadPointItemsToModal()}
function loadPointShop(){loadPointItemsToModal()}
async function loadPointItemsToModal(){try{const response=await fetch('/api/points/items');const items=await response.json();renderPointItemsInModal(items)}catch(error){console.error('í¬ì¸íŠ¸ ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨:',error);showToast('ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function renderPointItemsInModal(items){const grid=document.getElementById('modalPointItemsGrid');const userRole='[[${user.role.name()}]]';const isFather=userRole==='FATHER';if(!items||items.length===0){grid.innerHTML='<div class="empty-state"><div class="empty-state-icon"><i class="bi bi-shop"></i></div><div class="empty-state-title">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div></div>';return}grid.innerHTML=items.map(item=>{const canPurchase=isFather&&item.available&&parseInt(document.getElementById('userPoints').textContent)>=item.points;return`<div class="point-item-card ${canPurchase?'':'disabled'}" onclick="${canPurchase?`purchaseItemFromModal(${item.id})`:''}"><div class="point-item-icon-wrapper" style="background:${item.color||'#e5e7eb'}">${item.icon?`<i class="bi bi-${item.icon}"></i>`:'ğŸ'}</div><div class="point-item-name">${item.name}</div><div class="point-item-desc">${item.description||''}</div><div class="point-item-price"><span class="point-item-price-value">${item.points}</span><span class="point-item-price-unit">pt</span>${!isFather?'<span style="font-size:12px;color:var(--danger);margin-left:auto">ì•„ë²„ì§€ë§Œ êµ¬ë§¤ ê°€ëŠ¥</span>':''}</div></div>`}).join('')}
async function purchaseItemFromModal(itemId){if(!confirm('ì´ ìƒí’ˆì„ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{const response=await fetch(`/api/points/purchase/${itemId}`,{method:'POST'});if(response.ok){const result=await response.json();document.getElementById('modalCurrentPoints').textContent=result.remainingPoints;document.getElementById('userPoints').textContent=result.remainingPoints;showToast('ìƒí’ˆì„ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!','success');await loadPointItemsToModal()}else{const error=await response.json();showToast(error.message||'êµ¬ë§¤ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}catch(error){console.error('ìƒí’ˆ êµ¬ë§¤ ì‹¤íŒ¨:',error);showToast('ìƒí’ˆ êµ¬ë§¤ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function handleDailyMediaSelect(event){const files=event.target.files;if(!files||files.length===0)return;const preview=document.getElementById('dailyMediaPreview');preview.innerHTML='';preview.style.display='grid';Array.from(files).forEach((file,index)=>{const fileType=file.type.startsWith('image')?'image':'video';const reader=new FileReader();reader.onload=function(e){const wrapper=document.createElement('div');wrapper.style.position='relative';wrapper.style.borderRadius='8px';wrapper.style.overflow='hidden';if(fileType==='image'){wrapper.innerHTML=`<img src="${e.target.result}" style="width:100%;height:120px;object-fit:cover">`}else{wrapper.innerHTML=`<video src="${e.target.result}" style="width:100%;height:120px;object-fit:cover"></video>`}preview.appendChild(wrapper)};reader.readAsDataURL(file)})}
function handleWishImageSelect(event){const file=event.target.files[0];if(!file)return;const preview=document.getElementById('wishImagePreview');const reader=new FileReader();reader.onload=function(e){preview.innerHTML=`<img src="${e.target.result}" style="width:100%;max-height:300px;object-fit:cover;border-radius:12px">`;preview.style.display='block'};reader.readAsDataURL(file)}
function showDailyPostModal(){document.getElementById('dailyPostModal').classList.add('active')}
async function submitDailyPost(event){event.preventDefault();const content=document.getElementById('dailyContent').value.trim();const mediaFiles=document.getElementById('dailyMedia').files;if(!content){showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');return}const formData=new FormData();formData.append('content',content);if(mediaFiles&&mediaFiles.length>0){if(mediaFiles.length===1){formData.append('media',mediaFiles[0])}else{showToast('í˜„ì¬ëŠ” 1ê°œì˜ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ íŒŒì¼ë§Œ ì—…ë¡œë“œë©ë‹ˆë‹¤.','info');formData.append('media',mediaFiles[0])}}try{const response=await fetch('/api/daily',{method:'POST',body:formData});if(response.ok){showToast('ê²Œì‹œë¬¼ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.','success');closeModal('dailyPostModal');document.getElementById('dailyPostForm').reset();document.getElementById('dailyMediaPreview').innerHTML='';document.getElementById('dailyMediaPreview').style.display='none';await loadDailies()}else throw new Error('ê²Œì‹œë¬¼ ì‘ì„± ì‹¤íŒ¨')}catch(error){console.error('ê²Œì‹œë¬¼ ì‘ì„± ì‹¤íŒ¨:',error);showToast('ê²Œì‹œë¬¼ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
let allDailies=[];let dailyPage=1;const dailyPageSize=5;
async function loadDailies(){try{const response=await fetch('/api/daily');const dailies=await response.json();allDailies=dailies;dailyPage=1;renderDailies()}catch(error){console.error('ì¼ìƒ ë¡œë“œ ì‹¤íŒ¨:',error);showToast('ì¼ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function renderDailies(){const grid=document.getElementById('dailyPostsGrid');const start=0;const end=dailyPage*dailyPageSize;const dailies=allDailies.slice(start,end);if(!dailies||dailies.length===0){grid.innerHTML='<div class="empty-state"><div class="empty-state-icon"><i class="bi bi-images"></i></div><div class="empty-state-title">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤</div><div class="empty-state-text">ì²« ë²ˆì§¸ ì¼ìƒì„ ê³µìœ í•´ë³´ì„¸ìš”!</div></div>';return}let html=dailies.map(daily=>{const rainbowClass=hasRecentProfileUpdate(daily.user)?'rainbow-border':'';return`<div class="comment-item" style="padding:20px"><div class="comment-header"><div class="comment-avatar ${rainbowClass}" onclick="showProfileModal('${daily.user.profileImage}','${daily.user.displayName}')">${daily.user.profileImage?`<img src="${daily.user.profileImage}" alt="${daily.user.displayName}">`:daily.user.displayName.substring(0,1)}</div><div class="comment-user-info"><div class="comment-username">${daily.user.displayName}</div><div class="comment-time">${formatTimeAgo(new Date(daily.createdAt))}</div></div>${daily.user.id==currentUserId?`<button class="comment-delete-btn" onclick="deleteDaily(${daily.id})"><i class="bi bi-trash"></i></button>`:''}</div><div class="comment-content" style="margin-bottom:${daily.mediaUrl?'16px':'12px'}">${escapeHtml(daily.content)}</div>${daily.mediaUrl?(daily.mediaType==='VIDEO'?`<video controls class="comment-image" style="max-height:500px"><source src="${daily.mediaUrl}">Your browser does not support the video tag.</video>`:`<img class="comment-image" src="${daily.mediaUrl}" onclick="showImageModal('${daily.mediaUrl}')" style="cursor:pointer">`):''}  <div class="comment-actions"><button class="comment-action-btn ${daily.isLiked?'liked':''}" onclick="toggleDailyLike(${daily.id})"><i class="bi bi-heart-fill"></i><span>${daily.likesCount||0}</span></button><button class="comment-action-btn" onclick="showDailyComments(${daily.id})"><i class="bi bi-chat-fill"></i> <span>${daily.commentsCount||0}</span></button></div><div id="dailyComments-${daily.id}" style="display:none;margin-top:16px;padding-top:16px;border-top:1px solid var(--gray-200)"></div></div>`}).join('');if(end<allDailies.length){html+=`<button onclick="loadMoreDailies()" class="comment-submit-btn" style="width:100%;margin-top:12px"><i class="bi bi-arrow-down-circle"></i> ë” ë³´ê¸° (${allDailies.length-end}ê°œ ë‚¨ìŒ)</button>`}grid.innerHTML=html}
function loadMoreDailies(){dailyPage++;renderDailies()}
function toggleDailySearch(){const panel=document.getElementById('dailySearchPanel');panel.style.display=panel.style.display==='none'?'block':'none';const select=document.getElementById('dailySearchType');select.addEventListener('change',function(){const contentDiv=document.getElementById('dailySearchContent');const dateDiv=document.getElementById('dailySearchDate');if(this.value==='content'){contentDiv.style.display='block';dateDiv.style.display='none'}else{contentDiv.style.display='none';dateDiv.style.display='block'}})}
async function searchDailyPosts(){const type=document.getElementById('dailySearchType').value;if(type==='content'){const query=document.getElementById('dailySearchInput').value.trim();if(!query){showToast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”','error');return}allDailies=allDailies.filter(d=>d.content.includes(query));dailyPage=1;renderDailies();showToast(`${allDailies.length}ê°œì˜ ê²Œì‹œë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤`,'success')}else{const date=document.getElementById('dailySearchDateInput').value;if(!date){showToast('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”','error');return}allDailies=allDailies.filter(d=>d.createdAt.startsWith(date));dailyPage=1;renderDailies();showToast(`${allDailies.length}ê°œì˜ ê²Œì‹œë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤`,'success')}}
async function toggleDailyLike(dailyId){try{const response=await fetch(`/api/daily/${dailyId}/like`,{method:'POST'});if(response.ok){await loadDailies()}else throw new Error('ì¢‹ì•„ìš” ì‹¤íŒ¨')}catch(error){console.error('ì¢‹ì•„ìš” ì‹¤íŒ¨:',error);showToast('ì¢‹ì•„ìš”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function deleteDaily(dailyId){if(!confirm('ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{const response=await fetch(`/api/daily/${dailyId}`,{method:'DELETE'});if(response.ok){showToast('ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.','success');await loadDailies()}else throw new Error('ì‚­ì œ ì‹¤íŒ¨')}catch(error){console.error('ì‚­ì œ ì‹¤íŒ¨:',error);showToast('ê²Œì‹œë¬¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function showDailyComments(dailyId){const commentsDiv=document.getElementById(`dailyComments-${dailyId}`);if(commentsDiv.style.display==='none'){try{const response=await fetch(`/api/daily/${dailyId}/comments`);const comments=await response.json();renderDailyComments(dailyId,comments);commentsDiv.style.display='block'}catch(error){console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:',error);showToast('ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}else{commentsDiv.style.display='none'}}
function renderDailyComments(dailyId,comments){const commentsDiv=document.getElementById(`dailyComments-${dailyId}`);const parentComments=comments.filter(c=>!c.parentCommentId);let html=`<div class="comment-input-row" style="margin-bottom:12px"><input type="text" id="dailyCommentInput-${dailyId}" class="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."><button class="comment-submit-btn" onclick="addDailyComment(${dailyId})"><i class="bi bi-send-fill"></i></button></div>`;if(parentComments.length>0){html+='<div style="display:flex;flex-direction:column;gap:12px">';parentComments.forEach(comment=>{const rainbowClass=hasRecentProfileUpdate(comment.user)?'rainbow-border':'';html+=`<div style="background:var(--gray-100);padding:12px;border-radius:8px"><div class="comment-header" style="margin-bottom:8px"><div class="comment-avatar ${rainbowClass}" style="width:32px;height:32px;font-size:14px">${comment.user.profileImage?`<img src="${comment.user.profileImage}" alt="${comment.user.displayName}">`:comment.user.displayName.substring(0,1)}</div><div class="comment-user-info"><div class="comment-username" style="font-size:13px">${comment.user.displayName}</div><div class="comment-time" style="font-size:11px">${formatTimeAgo(new Date(comment.createdAt))}</div></div>${comment.user.id==currentUserId?`<button class="comment-delete-btn" onclick="deleteDailyComment(${comment.id},${dailyId})"><i class="bi bi-trash"></i></button>`:''}</div><div style="font-size:14px;line-height:1.5">${escapeHtml(comment.content)}</div><button class="comment-action-btn" style="font-size:12px;margin-top:8px" onclick="showDailyReplyInput(${comment.id},${dailyId})"><i class="bi bi-reply-fill"></i> ë‹µê¸€</button><div id="dailyReply-${comment.id}" style="display:none;margin-top:12px"></div>`;const replies=comments.filter(r=>r.parentCommentId===comment.id);if(replies.length>0){replies.forEach(reply=>{const replyRainbowClass=hasRecentProfileUpdate(reply.user)?'rainbow-border':'';html+=`<div style="margin-left:20px;margin-top:8px;padding:8px;background:var(--white);border-radius:6px"><div class="comment-header" style="margin-bottom:6px"><div class="comment-avatar ${replyRainbowClass}" style="width:24px;height:24px;font-size:12px">${reply.user.profileImage?`<img src="${reply.user.profileImage}" alt="${reply.user.displayName}">`:reply.user.displayName.substring(0,1)}</div><div class="comment-user-info"><div class="comment-username" style="font-size:12px">${reply.user.displayName}</div><div class="comment-time" style="font-size:10px">${formatTimeAgo(new Date(reply.createdAt))}</div></div>${reply.user.id==currentUserId?`<button class="comment-delete-btn" onclick="deleteDailyComment(${reply.id},${dailyId})"><i class="bi bi-trash"></i></button>`:''}</div><div style="font-size:13px">${escapeHtml(reply.content)}</div></div>`})}html+='</div>'}); html+='</div>'}commentsDiv.innerHTML=html}
function showDailyReplyInput(commentId,dailyId){const replyDiv=document.getElementById(`dailyReply-${commentId}`);if(replyDiv.style.display==='none'){replyDiv.innerHTML=`<div class="comment-input-row"><input type="text" id="dailyReplyInput-${commentId}" class="comment-input" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."><button class="comment-submit-btn" onclick="addDailyComment(${dailyId},${commentId})"><i class="bi bi-send-fill"></i></button><button class="comment-submit-btn" style="background:var(--gray-600)" onclick="document.getElementById('dailyReply-${commentId}').style.display='none'">ì·¨ì†Œ</button></div>`;replyDiv.style.display='block';document.getElementById(`dailyReplyInput-${commentId}`).focus()}else{replyDiv.style.display='none'}}
async function addDailyComment(dailyId,parentCommentId){const inputId=parentCommentId?`dailyReplyInput-${parentCommentId}`:`dailyCommentInput-${dailyId}`;const input=document.getElementById(inputId);const content=input.value.trim();if(!content){showToast('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');return}const formData=new FormData();formData.append('content',content);if(parentCommentId)formData.append('parentCommentId',parentCommentId);try{const response=await fetch(`/api/daily/${dailyId}/comments`,{method:'POST',body:formData});if(response.ok){input.value='';if(parentCommentId)document.getElementById(`dailyReply-${parentCommentId}`).style.display='none';showToast('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.','success');const commentsResponse=await fetch(`/api/daily/${dailyId}/comments`);const comments=await commentsResponse.json();renderDailyComments(dailyId,comments)}else throw new Error('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨')}catch(error){console.error('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:',error);showToast('ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function deleteDailyComment(commentId,dailyId){if(!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{const response=await fetch(`/api/daily/comments/${commentId}`,{method:'DELETE'});if(response.ok){showToast('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.','success');const commentsResponse=await fetch(`/api/daily/${dailyId}/comments`);const comments=await commentsResponse.json();renderDailyComments(dailyId,comments)}else throw new Error('ì‚­ì œ ì‹¤íŒ¨')}catch(error){console.error('ì‚­ì œ ì‹¤íŒ¨:',error);showToast('ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
let naverMap;let naverMarker;let selectedLat=null;let selectedLng=null;let wishCurrentMonth=new Date().getMonth();let wishCurrentYear=new Date().getFullYear();
function showWishModal(){document.getElementById('wishModal').classList.add('active');setTimeout(()=>{initNaverMap()},300)}
function initNaverMap(){if(typeof naver==='undefined'||!naver.maps){console.error('Naver Maps APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');showToast('ì§€ë„ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.','error');return}const mapDiv=document.getElementById('naverMap');if(naverMap){return}const mapOptions={center:new naver.maps.LatLng(37.5665,126.9780),zoom:15};naverMap=new naver.maps.Map(mapDiv,mapOptions);naverMarker=new naver.maps.Marker({position:naverMap.getCenter(),map:naverMap});naver.maps.Event.addListener(naverMap,'click',function(e){const latlng=e.coord;naverMarker.setPosition(latlng);selectedLat=latlng.lat();selectedLng=latlng.lng();document.getElementById('wishLatitude').value=selectedLat;document.getElementById('wishLongitude').value=selectedLng;naver.maps.Service.reverseGeocode({coords:latlng},function(status,response){if(status===naver.maps.Service.Status.OK){const result=response.v2.address;const address=result.jibunAddress||result.roadAddress;document.getElementById('wishAddress').value=address}else{document.getElementById('wishAddress').value='ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}})})}
async function searchLocation(){const query=document.getElementById('wishLocationSearch').value.trim();if(!query){showToast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');return}try{naver.maps.Service.geocode({query:query},function(status,response){if(status===naver.maps.Service.Status.OK){const result=response.v2.addresses[0];if(result){const latlng=new naver.maps.LatLng(result.y,result.x);naverMap.setCenter(latlng);naverMap.setZoom(16);naverMarker.setPosition(latlng);selectedLat=result.y;selectedLng=result.x;document.getElementById('wishLatitude').value=selectedLat;document.getElementById('wishLongitude').value=selectedLng;document.getElementById('wishAddress').value=result.jibunAddress||result.roadAddress}else{showToast('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.','error')}}else{showToast('ìœ„ì¹˜ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}})}catch(error){console.error('ìœ„ì¹˜ ê²€ìƒ‰ ì‹¤íŒ¨:',error);showToast('ìœ„ì¹˜ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function submitWish(event){event.preventDefault();const title=document.getElementById('wishTitle').value.trim();const description=document.getElementById('wishDescription').value.trim();const category=document.getElementById('wishCategory').value;const imageFile=document.getElementById('wishImage').files[0];const scheduleDate=document.getElementById('wishScheduleDate').value;const scheduleTime=document.getElementById('wishScheduleTime').value;if(!title||!category){showToast('ì œëª©ê³¼ ì¹´í…Œê³ ë¦¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.','error');return}const formData=new FormData();formData.append('title',title);if(description)formData.append('description',description);formData.append('category',category);if(selectedLat)formData.append('latitude',selectedLat);if(selectedLng)formData.append('longitude',selectedLng);if(document.getElementById('wishAddress').value)formData.append('address',document.getElementById('wishAddress').value);if(imageFile)formData.append('image',imageFile);if(scheduleDate){let scheduledDateTime=scheduleDate;if(scheduleTime){scheduledDateTime+=`T${scheduleTime}:00`}else{scheduledDateTime+='T00:00:00'}formData.append('scheduleDate',scheduledDateTime)}try{const response=await fetch('/api/wish',{method:'POST',body:formData});if(response.ok){showToast('ìœ„ì‹œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.','success');closeModal('wishModal');document.getElementById('wishForm').reset();selectedLat=null;selectedLng=null;await loadWishes();await loadWishSchedules()}else{const error=await response.json();showToast(error.error||'ìœ„ì‹œ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}catch(error){console.error('ìœ„ì‹œ ì¶”ê°€ ì‹¤íŒ¨:',error);showToast('ìœ„ì‹œ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
let allWishes=[];let wishPage=1;const wishPageSize=3;
async function loadWishes(){try{const response=await fetch('/api/wish',{cache:'no-store',headers:{'Cache-Control':'no-cache','Pragma':'no-cache'}});const wishes=await response.json();allWishes=wishes.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));wishPage=1;renderWishes()}catch(error){console.error('ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:',error);showToast('ìœ„ì‹œë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function renderWishes(){const grid=document.getElementById('wishListGrid');const start=0;const end=wishPage*wishPageSize;const wishes=allWishes.slice(start,end);if(!wishes||wishes.length===0){grid.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon"><i class="bi bi-star-fill"></i></div><div class="empty-state-title">ìœ„ì‹œë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div><div class="empty-state-text">ì²« ë²ˆì§¸ ìœ„ì‹œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</div></div>';return}const categoryColors={RESTAURANT:'#ff6b6b',TRAVEL:'#4ecdc4',SHOPPING:'#45b7d1',CAFE:'#f9ca24',ACTIVITY:'#ee5a6f',OTHER:'#95a5a6'};const categoryIcons={RESTAURANT:'shop',TRAVEL:'airplane',SHOPPING:'bag-fill',CAFE:'cup-hot-fill',ACTIVITY:'bicycle',OTHER:'star-fill'};let html=wishes.map(wish=>`<div class="comment-item" style="padding:0;overflow:hidden;${wish.completed?'opacity:0.6;':''}">${wish.imageUrl?`<img src="${wish.imageUrl}" style="width:100%;height:200px;object-fit:cover;cursor:pointer" onclick="showImageModal('${wish.imageUrl}')">`:''}  <div style="padding:16px"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px"><div style="flex:1"><div style="display:inline-block;padding:4px 12px;background:${categoryColors[wish.category]||'#95a5a6'};color:white;border-radius:12px;font-size:12px;font-weight:600;margin-bottom:8px"><i class="bi bi-${categoryIcons[wish.category]||'star-fill'}"></i> ${wish.category}</div><h6 style="font-weight:700;margin-bottom:4px;${wish.completed?'text-decoration:line-through;color:var(--gray-600)':''}">${escapeHtml(wish.title)}</h6></div>${wish.user.id==currentUserId?`<button class="comment-delete-btn" onclick="deleteWish(${wish.id})"><i class="bi bi-trash"></i></button>`:''}</div>${wish.description?`<p style="font-size:14px;color:var(--gray-600);margin-bottom:12px;line-height:1.5">${escapeHtml(wish.description)}</p>`:''} ${wish.address?`<div style="display:flex;align-items:center;gap:6px;font-size:13px;color:var(--gray-600);margin-bottom:12px"><i class="bi bi-geo-alt-fill"></i><span>${escapeHtml(wish.address)}</span></div>`:''} <div style="display:flex;gap:8px"><button class="comment-submit-btn" style="padding:8px 16px;font-size:13px;${wish.completed?'background:var(--gray-600)':'background:var(--success)'}" onclick="toggleWishCompletion(${wish.id})"><i class="bi bi-${wish.completed?'arrow-counterclockwise':'check-lg'}"></i> ${wish.completed?'ë¯¸ì™„ë£Œë¡œ ë³€ê²½':'ì™„ë£Œ'}</button>${wish.latitude&&wish.longitude?`<button class="comment-submit-btn" style="padding:8px 16px;font-size:13px;background:var(--info)" onclick="openNaverMapLink(${wish.latitude},${wish.longitude},'${escapeForAttribute(wish.title)}')"><i class="bi bi-map-fill"></i> ì§€ë„ë³´ê¸°</button>`:''}</div></div></div>`).join('');if(end<allWishes.length){html+=`<button onclick="loadMoreWishes()" class="comment-submit-btn" style="grid-column:1/-1;margin-top:8px"><i class="bi bi-arrow-down-circle"></i> ë” ë³´ê¸° (${allWishes.length-end}ê°œ ë‚¨ìŒ)</button>`}grid.innerHTML=html}
function loadMoreWishes(){wishPage++;renderWishes()}
async function toggleWishCompletion(wishId){try{const response=await fetch(`/api/wish/${wishId}/toggle-complete`,{method:'POST'});if(response.ok){const result=await response.json();showToast(result.completed?'ìœ„ì‹œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!':'ìœ„ì‹œê°€ ë¯¸ì™„ë£Œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.','success');await loadWishes()}else throw new Error('ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨')}catch(error){console.error('ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:',error);showToast('ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function deleteWish(wishId){if(!confirm('ì´ ìœ„ì‹œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{const response=await fetch(`/api/wish/${wishId}`,{method:'DELETE'});if(response.ok){showToast('ìœ„ì‹œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.','success');await loadWishes();await loadWishSchedules()}else throw new Error('ì‚­ì œ ì‹¤íŒ¨')}catch(error){console.error('ì‚­ì œ ì‹¤íŒ¨:',error);showToast('ìœ„ì‹œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function openNaverMapLink(lat,lng,title){const url=`https://map.naver.com/v5/?c=${lng},${lat},15,0,0,0,dh&p=${lat},${lng},-,-,${encodeURIComponent(title)}`;window.open(url,'_blank')}
async function loadWishSchedules(){try{const response=await fetch('/api/wish/schedules',{cache:'no-store',headers:{'Cache-Control':'no-cache','Pragma':'no-cache'}});const schedules=await response.json();renderWishCalendar(schedules);renderWishScheduleList(schedules)}catch(error){console.error('ì¼ì • ë¡œë“œ ì‹¤íŒ¨:',error)}}
function renderWishCalendar(schedules){const title=document.getElementById('wishCalendarTitle');title.textContent=`${wishCurrentYear}ë…„ ${wishCurrentMonth+1}ì›”`;const grid=document.getElementById('wishCalendarGrid');const firstDay=new Date(wishCurrentYear,wishCurrentMonth,1).getDay();const lastDate=new Date(wishCurrentYear,wishCurrentMonth+1,0).getDate();const today=new Date();today.setHours(0,0,0,0);let html='<div class="calendar-weekdays">';['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach((day,index)=>{html+=`<div class="calendar-weekday" style="${index===0?'color:#e74c3c':index===6?'color:#3498db':''}">${day}</div>`});html+='</div><div class="calendar-days">';for(let i=0;i<firstDay;i++){html+='<div class="calendar-day empty"></div>'}for(let day=1;day<=lastDate;day++){const date=new Date(wishCurrentYear,wishCurrentMonth,day);date.setHours(0,0,0,0);const dateStr=`${wishCurrentYear}-${String(wishCurrentMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;const isToday=date.getTime()===today.getTime();const daySchedules=schedules.filter(s=>{const scheduleDate=new Date(s.scheduledDate);return scheduleDate.getFullYear()===wishCurrentYear&&scheduleDate.getMonth()===wishCurrentMonth&&scheduleDate.getDate()===day});html+=`<div class="calendar-day ${isToday?'today':''}" onclick="filterWishesByDate('${dateStr}')" style="cursor:pointer;${daySchedules.length>0?'background:#e3f2fd;font-weight:700':''}">${day}${daySchedules.length>0?`<div style="font-size:10px;color:#1976d2">${daySchedules.length}ê°œ</div>`:''}</div>`}html+='</div>';grid.innerHTML=html}
function filterWishesByDate(dateStr){const filtered=allWishes.filter(w=>{if(w.scheduledDate){return w.scheduledDate.startsWith(dateStr)}return false});if(filtered.length===0){showToast(`${dateStr} ë‚ ì§œì— ì˜ˆì •ëœ ìœ„ì‹œê°€ ì—†ìŠµë‹ˆë‹¤.`,'info');return}const grid=document.getElementById('wishListGrid');const categoryColors={RESTAURANT:'#ff6b6b',TRAVEL:'#4ecdc4',SHOPPING:'#45b7d1',CAFE:'#f9ca24',ACTIVITY:'#ee5a6f',OTHER:'#95a5a6'};const categoryIcons={RESTAURANT:'shop',TRAVEL:'airplane',SHOPPING:'bag-fill',CAFE:'cup-hot-fill',ACTIVITY:'bicycle',OTHER:'star-fill'};let html='<div style="grid-column:1/-1;padding:12px;background:var(--info-light);border-radius:8px;margin-bottom:12px"><strong>ğŸ“… '+dateStr+'</strong> ë‚ ì§œì˜ ìœ„ì‹œ ('+filtered.length+'ê°œ) <button onclick="wishPage=1;renderWishes()" style="background:none;border:none;color:var(--primary);text-decoration:underline;cursor:pointer;margin-left:12px">ì „ì²´ ë³´ê¸°</button></div>';html+=filtered.map(wish=>`<div class="comment-item" style="padding:0;overflow:hidden;${wish.completed?'opacity:0.6;':''}">${wish.imageUrl?`<img src="${wish.imageUrl}" style="width:100%;height:200px;object-fit:cover;cursor:pointer" onclick="showImageModal('${wish.imageUrl}')">`:''}  <div style="padding:16px"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px"><div style="flex:1"><div style="display:inline-block;padding:4px 12px;background:${categoryColors[wish.category]||'#95a5a6'};color:white;border-radius:12px;font-size:12px;font-weight:600;margin-bottom:8px"><i class="bi bi-${categoryIcons[wish.category]||'star-fill'}"></i> ${wish.category}</div><h6 style="font-weight:700;margin-bottom:4px;${wish.completed?'text-decoration:line-through;color:var(--gray-600)':''}">${escapeHtml(wish.title)}</h6></div>${wish.user.id==currentUserId?`<button class="comment-delete-btn" onclick="deleteWish(${wish.id})"><i class="bi bi-trash"></i></button>`:''}</div>${wish.description?`<p style="font-size:14px;color:var(--gray-600);margin-bottom:12px;line-height:1.5">${escapeHtml(wish.description)}</p>`:''} ${wish.address?`<div style="display:flex;align-items:center;gap:6px;font-size:13px;color:var(--gray-600);margin-bottom:12px"><i class="bi bi-geo-alt-fill"></i><span>${escapeHtml(wish.address)}</span></div>`:''} <div style="display:flex;gap:8px"><button class="comment-submit-btn" style="padding:8px 16px;font-size:13px;${wish.completed?'background:var(--gray-600)':'background:var(--success)'}" onclick="toggleWishCompletion(${wish.id})"><i class="bi bi-${wish.completed?'arrow-counterclockwise':'check-lg'}"></i> ${wish.completed?'ë¯¸ì™„ë£Œë¡œ ë³€ê²½':'ì™„ë£Œ'}</button>${wish.latitude&&wish.longitude?`<button class="comment-submit-btn" style="padding:8px 16px;font-size:13px;background:var(--info)" onclick="openNaverMapLink(${wish.latitude},${wish.longitude},'${escapeForAttribute(wish.title)}')"><i class="bi bi-map-fill"></i> ì§€ë„ë³´ê¸°</button>`:''}</div></div></div>`).join('');grid.innerHTML=html}
function renderWishScheduleList(schedules){const list=document.getElementById('wishScheduleList');const currentMonth=new Date(wishCurrentYear,wishCurrentMonth);const nextMonth=new Date(wishCurrentYear,wishCurrentMonth+1);const monthSchedules=schedules.filter(s=>{const date=new Date(s.scheduledDate);return date>=currentMonth&&date<nextMonth});if(!monthSchedules||monthSchedules.length===0){list.innerHTML='<div class="empty-state"><p>ì´ë²ˆ ë‹¬ì— ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';return}const categoryColors={RESTAURANT:'#ff6b6b',TRAVEL:'#4ecdc4',SHOPPING:'#45b7d1',CAFE:'#f9ca24',ACTIVITY:'#ee5a6f',OTHER:'#95a5a6'};list.innerHTML=monthSchedules.map(schedule=>`<div class="comment-item" style="padding:16px;${schedule.completed?'opacity:0.6;':''}"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px"><div style="flex:1"><div style="display:inline-block;padding:4px 12px;background:${categoryColors[schedule.wish.category]||'#95a5a6'};color:white;border-radius:12px;font-size:12px;font-weight:600;margin-bottom:8px">${schedule.wish.category}</div><h6 style="font-weight:700;margin-bottom:4px;${schedule.completed?'text-decoration:line-through;color:var(--gray-600)':''}">${escapeHtml(schedule.title)}</h6><div style="font-size:13px;color:var(--gray-600);margin-bottom:4px"><i class="bi bi-calendar-event"></i> ${formatDateTime(new Date(schedule.scheduledDate))}</div>${schedule.wish.address?`<div style="font-size:13px;color:var(--gray-600)"><i class="bi bi-geo-alt-fill"></i> ${escapeHtml(schedule.wish.address)}</div>`:''}</div><button class="comment-delete-btn" onclick="deleteSchedule(${schedule.id})"><i class="bi bi-trash"></i></button></div><div style="display:flex;gap:8px"><button class="comment-submit-btn" style="padding:8px 16px;font-size:13px;${schedule.completed?'background:var(--gray-600)':'background:var(--success)'}" onclick="toggleScheduleCompletion(${schedule.id})"><i class="bi bi-${schedule.completed?'arrow-counterclockwise':'check-lg'}"></i> ${schedule.completed?'ë¯¸ì™„ë£Œ':'ì™„ë£Œ'}</button></div></div>`).join('')}
async function toggleScheduleCompletion(scheduleId){try{const response=await fetch(`/api/wish/schedules/${scheduleId}/toggle-complete`,{method:'POST'});if(response.ok){const result=await response.json();showToast(result.completed?'ì¼ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!':'ì¼ì •ì´ ë¯¸ì™„ë£Œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.','success');await loadWishSchedules()}else throw new Error('ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨')}catch(error){console.error('ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:',error);showToast('ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
async function deleteSchedule(scheduleId){if(!confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{const response=await fetch(`/api/wish/schedules/${scheduleId}`,{method:'DELETE'});if(response.ok){showToast('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.','success');await loadWishSchedules()}else throw new Error('ì‚­ì œ ì‹¤íŒ¨')}catch(error){console.error('ì‚­ì œ ì‹¤íŒ¨:',error);showToast('ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function changeWishMonth(delta){wishCurrentMonth+=delta;if(wishCurrentMonth<0){wishCurrentMonth=11;wishCurrentYear--}else if(wishCurrentMonth>11){wishCurrentMonth=0;wishCurrentYear++}loadWishSchedules()}
function formatDateTime(date){return`${date.getFullYear()}ë…„ ${date.getMonth()+1}ì›” ${date.getDate()}ì¼ ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`}
async function loadHomeRecentDailies(){try{const response=await fetch('/api/daily');const dailies=await response.json();const recentDailies=dailies.slice(0,3);renderHomeRecentDailies(recentDailies)}catch(error){console.error('í™ˆ ì¼ìƒ ë¡œë“œ ì‹¤íŒ¨:',error)}}
function renderHomeRecentDailies(dailies){const container=document.getElementById('homeRecentDailies');if(!dailies||dailies.length===0){container.innerHTML='<div class="empty-state"><p>ì•„ì§ ì¼ìƒ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';return}container.innerHTML=dailies.map(daily=>{const truncatedContent=daily.content&&daily.content.length>20?daily.content.substring(0,20)+'...':daily.content||'';const rainbowClass=hasRecentProfileUpdate(daily.user)?'rainbow-border':'';return`<div class="comment-item" style="padding:8px;cursor:pointer" onclick="switchTab('dailyTab')"><div class="comment-header" style="margin-bottom:6px"><div class="comment-avatar ${rainbowClass}" style="width:28px;height:28px;font-size:12px">${daily.user.profileImage?`<img src="${daily.user.profileImage}" alt="${daily.user.displayName}">`:daily.user.displayName.substring(0,1)}</div><div class="comment-user-info"><div class="comment-username" style="font-size:12px">${daily.user.displayName}</div><div class="comment-time" style="font-size:10px">${formatTimeAgo(new Date(daily.createdAt))}</div></div></div><div style="font-size:13px;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-secondary)">${escapeHtml(truncatedContent)}</div>${daily.mediaUrl?`<div style="margin-top:6px;border-radius:6px;overflow:hidden;max-height:60px"><img src="${daily.mediaUrl}" style="width:100%;height:100%;object-fit:cover"></div>`:''}</div>`}).join('')}
function toggleCommentSection(){const content=document.getElementById('commentSectionContent');const icon=document.getElementById('commentToggleIcon');if(content.style.display==='none'){content.style.display='block';icon.style.transform='rotate(180deg)'}else{content.style.display='none';icon.style.transform='rotate(0deg)'}}
async function loadActivities(){try{const response=await fetch('/api/activity');const data=await response.json();renderActivities(data.activities)}catch(error){console.error('í™œë™ ë¡œë“œ ì‹¤íŒ¨:',error)}}
function renderActivities(activities){const container=document.getElementById('activityList');const unreadActivities=activities?activities.filter(a=>!a.isRead):[];if(!unreadActivities||unreadActivities.length===0){container.innerHTML='<div class="empty-state"><p>í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';return}const activityIcons={COMMENT:'chat-heart-fill',COMMENT_REPLY:'reply-fill',DAILY_POST:'images',DAILY_COMMENT:'chat-dots-fill',DAILY_LIKE:'heart-fill',WISH_ADDED:'star-fill',SCHEDULE_ADDED:'calendar-plus-fill'};const activityTabs={COMMENT:'homeTab',COMMENT_REPLY:'homeTab',DAILY_POST:'dailyTab',DAILY_COMMENT:'dailyTab',DAILY_LIKE:'dailyTab',WISH_ADDED:'wishTab',SCHEDULE_ADDED:'wishTab'};container.innerHTML=unreadActivities.map(activity=>{const rainbowClass=hasRecentProfileUpdate(activity.user)?'rainbow-border':'';return`<div class="comment-item" style="padding:12px;background:var(--primary-light);border-left:3px solid var(--primary)"><div style="display:flex;justify-content:space-between;align-items:start"><div style="flex:1"><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><div class="comment-avatar ${rainbowClass}" style="width:28px;height:28px;font-size:12px">${activity.user.profileImage?`<img src="${activity.user.profileImage}" alt="${activity.user.displayName}">`:activity.user.displayName.substring(0,1)}</div><span style="font-size:14px;line-height:1.4">${escapeHtml(activity.message)}</span></div><div style="font-size:11px;color:var(--gray-600);margin-left:36px">${formatTimeAgo(new Date(activity.createdAt))}</div></div><button onclick="navigateToActivity('${activityTabs[activity.activityType]}',${activity.id})" style="background:var(--primary);color:white;border:none;border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer;white-space:nowrap;transition:all .2s" onmouseover="this.style.background='var(--primary-dark)'" onmouseout="this.style.background='var(--primary)'"><i class="bi bi-${activityIcons[activity.activityType]||'arrow-right'}"></i> ë³´ê¸°</button></div></div>`}).join('')}
async function navigateToActivity(tabId,activityId){try{await fetch(`/api/activity/${activityId}/read`,{method:'POST'});switchTab(tabId);await loadActivities()}catch(error){console.error('í™œë™ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:',error);switchTab(tabId)}}
async function markAllActivitiesAsRead(){try{const response=await fetch('/api/activity/read-all',{method:'POST'});if(response.ok){showToast('ëª¨ë“  í™œë™ì„ ì½ìŒ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.','success');await loadActivities()}else throw new Error('ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨')}catch(error){console.error('ëª¨ë“  í™œë™ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:',error);showToast('ì½ìŒ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
let healthCurrentMonth=new Date().getMonth();let healthCurrentYear=new Date().getFullYear();let healthMedicineRecordsCache=[];
async function renderHealthCalendar(){const title=document.getElementById('healthCalendarTitle');title.textContent=`${healthCurrentYear}ë…„ ${healthCurrentMonth+1}ì›”`;const today=new Date().toISOString().split('T')[0];try{const [medicineRes,mealsRes]=await Promise.all([fetch(`/api/medicine/calendar/${healthCurrentYear}/${healthCurrentMonth+1}`),fetch(`/api/meal/calendar/${healthCurrentYear}/${healthCurrentMonth+1}`)]);const medicineData=await medicineRes.json();const mealData=await mealsRes.json();const medicineRecords=medicineData.records||[];const dailyMealStats=mealData.dailyStats||[];healthMedicineRecordsCache=medicineRecords;const grid=document.getElementById('healthCalendarGrid');const firstDay=new Date(healthCurrentYear,healthCurrentMonth,1).getDay();const lastDate=new Date(healthCurrentYear,healthCurrentMonth+1,0).getDate();const todayDate=new Date();todayDate.setHours(0,0,0,0);let html='<div class="calendar-weekdays">';['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach((day,index)=>{html+=`<div class="calendar-weekday" style="${index===0?'color:#e74c3c':index===6?'color:#3498db':''}">${day}</div>`});html+='</div><div class="calendar-days">';for(let i=0;i<firstDay;i++){html+='<div class="calendar-day empty"></div>'}for(let day=1;day<=lastDate;day++){const date=new Date(healthCurrentYear,healthCurrentMonth,day);date.setHours(0,0,0,0);const dateStr=`${healthCurrentYear}-${String(healthCurrentMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;const isToday=date.getTime()===todayDate.getTime();let medicineStatus='';const dayMedicineRecords=medicineRecords.filter(r=>r.date===dateStr);let morningTaken=false,eveningTaken=false;dayMedicineRecords.forEach(r=>{if(r.medicineType==='MORNING'&&r.taken)morningTaken=true;if(r.medicineType==='EVENING'&&r.taken)eveningTaken=true});if(morningTaken&&eveningTaken)medicineStatus='<div style="font-size:10px;color:#10b981">ì•½ğŸ’Š</div>';else if(morningTaken||eveningTaken)medicineStatus='<div style="font-size:10px;color:#f59e0b">ì•½ğŸ’Š</div>';let mealStatus='';const dayMealStat=dailyMealStats.find(m=>m.date===dateStr);if(dayMealStat&&dayMealStat.averageScore>0){const avgScore=dayMealStat.averageScore;mealStatus=`<div style="font-size:10px;color:${avgScore>=80?'#10b981':avgScore>=60?'#f59e0b':'#ef4444'}">ì‹ğŸ½ï¸</div>`}html+=`<div class="calendar-day ${isToday?'today':''}" onclick="showHealthDayDetails('${dateStr}')" style="cursor:pointer">${day}${medicineStatus}${mealStatus}</div>`}html+='</div>';grid.innerHTML=html}catch(error){console.error('ê±´ê°• ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨:',error);showToast('ê±´ê°• ìº˜ë¦°ë”ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function changeHealthMonth(delta){healthCurrentMonth+=delta;if(healthCurrentMonth<0){healthCurrentMonth=11;healthCurrentYear--}else if(healthCurrentMonth>11){healthCurrentMonth=0;healthCurrentYear++}renderHealthCalendar()}
async function showHealthDayDetails(dateStr){try{const mealsRes=await fetch(`/api/meal/date/${dateStr}`);const mealsData=await mealsRes.json();const dayMeals=mealsData.meals||[];const dayMedicineRecords=healthMedicineRecordsCache.filter(r=>r.date===dateStr);let morningTaken=false,eveningTaken=false;dayMedicineRecords.forEach(r=>{if(r.medicineType==='MORNING'&&r.taken)morningTaken=true;if(r.medicineType==='EVENING'&&r.taken)eveningTaken=true});const detailsDiv=document.getElementById('healthDayDetails');let html=`<div style="padding:16px;background:var(--gray-100);border-radius:12px"><h6 style="font-weight:700;margin-bottom:12px">${dateStr} ê±´ê°• ê¸°ë¡</h6>`;html+='<div style="margin-bottom:16px"><div style="font-weight:600;margin-bottom:8px"><i class="bi bi-capsule"></i> ì•½ ë³µìš©</div>';if(dayMedicineRecords.length>0){html+=`<div style="display:flex;gap:12px"><span style="padding:4px 12px;border-radius:8px;background:${morningTaken?'#dcfce7':'#fee2e2'};color:${morningTaken?'#065f46':'#991b1b'}">ì•„ì¹¨: ${morningTaken?'ë³µìš©ì™„ë£Œ':'ë¯¸ë³µìš©'}</span><span style="padding:4px 12px;border-radius:8px;background:${eveningTaken?'#dcfce7':'#fee2e2'};color:${eveningTaken?'#065f46':'#991b1b'}">ì €ë…: ${eveningTaken?'ë³µìš©ì™„ë£Œ':'ë¯¸ë³µìš©'}</span></div>`}else{html+='<div style="color:var(--gray-600)">ê¸°ë¡ ì—†ìŒ</div>'}html+='</div>';html+='<div><div style="font-weight:600;margin-bottom:8px"><i class="bi bi-egg-fried"></i> ì‹ë‹¨ (ì‚¬ì§„ í´ë¦­ ì‹œ AI í‰ê°€ ë³´ê¸°)</div>';if(dayMeals&&dayMeals.length>0){html+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px">';dayMeals.forEach(meal=>{const mealTypeText=meal.mealType==='BREAKFAST'?'ì•„ì¹¨':meal.mealType==='LUNCH'?'ì ì‹¬':'ì €ë…';const mealJson=JSON.stringify(meal).replace(/'/g,"&#39;");html+=`<div style="border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid var(--gray-300);transition:all .2s" onclick='showMealEvaluation(${mealJson})' onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--gray-300)'">${meal.imageUrl?`<img src="${meal.imageUrl}" style="width:100%;height:100px;object-fit:cover">`:'<div style="width:100%;height:100px;background:var(--gray-300);display:flex;align-items:center;justify-content:center"><i class="bi bi-image" style="font-size:32px;color:var(--gray-600)"></i></div>'}<div style="padding:8px;background:var(--white)"><div style="font-weight:600;font-size:13px">${mealTypeText}</div>${meal.score?`<div style="font-size:12px;color:${meal.score>=80?'#10b981':meal.score>=60?'#f59e0b':'#ef4444'};font-weight:600">${meal.score}ì </div>`:''}</div></div>`});html+='</div>'}else{html+='<div style="color:var(--gray-600)">ê¸°ë¡ ì—†ìŒ</div>'}html+='</div></div>';detailsDiv.innerHTML=html;detailsDiv.style.display='block'}catch(error){console.error('ë‚ ì§œ ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:',error);showToast('í•´ë‹¹ ë‚ ì§œì˜ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error')}}
function showMealEvaluation(meal){const modal=document.getElementById('imageModal');if(!meal.imageUrl&&!meal.aiEvaluation){showToast('ì‹ë‹¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.','info');return}const modalImage=document.getElementById('modalImage');const modalTitle=document.getElementById('profileModalTitle');const mealTypeText=meal.mealType==='BREAKFAST'?'ì•„ì¹¨':meal.mealType==='LUNCH'?'ì ì‹¬':'ì €ë…';modalTitle.textContent=`${mealTypeText} ì‹ë‹¨ í‰ê°€`;let html='';if(meal.imageUrl){html+=`<img src="${meal.imageUrl}" style="width:100%;max-height:400px;object-fit:contain;border-radius:12px;margin-bottom:16px">`}if(meal.aiEvaluation){const scoreColor=meal.score>=80?'#10b981':meal.score>=60?'#f59e0b':'#ef4444';html+=`<div style="padding:16px;background:${scoreColor}20;border-left:4px solid ${scoreColor};border-radius:8px"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><div style="font-size:32px;font-weight:700;color:${scoreColor}">${meal.score||0}ì </div><div style="flex:1;font-size:14px;color:var(--gray-600)">AI ì˜ì–‘ í‰ê°€</div></div><div style="font-size:14px;line-height:1.6;white-space:pre-wrap">${escapeHtml(meal.aiEvaluation)}</div></div>`}else{html+=`<div style="padding:16px;background:var(--gray-100);border-radius:8px;text-align:center;color:var(--gray-600)">AI í‰ê°€ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>`}modalImage.innerHTML=html;modal.classList.add('active')}
</script>
</body>
</html>
